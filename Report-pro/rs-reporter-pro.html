<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>RS-Reporter Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&family=Bebas+Neue&display=swap');
:root{
  --bg:#0f0f0f;--surface:#191919;--surface2:#222;--border:#2a2a2a;
  --accent:#e8a020;--text:#f0f0f0;--text2:#777;--danger:#ef4444;--ok:#22c55e;
  --before:#4a9eff;--during:#a855f7;--after:#22c55e;--pickup:#f59e0b;--other:#94a3b8;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html{height:100%;}
body{background:var(--bg);font-family:'Noto Sans JP',sans-serif;color:var(--text);max-width:480px;margin:0 auto;min-height:100vh;}

/* â”€â”€â”€ å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€â”€ */
.app-header{background:#000;border-bottom:2px solid var(--accent);padding:10px 16px;display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:200;flex-wrap:nowrap;overflow:hidden;}
.app-logo{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--accent);letter-spacing:2px;white-space:nowrap;line-height:1.2;}
.app-sub{font-size:10px;color:var(--text2);white-space:nowrap;line-height:1.2;}
.header-step{margin-left:auto;font-family:'Bebas Neue',sans-serif;font-size:16px;color:var(--accent);letter-spacing:1px;white-space:nowrap;flex-shrink:0;}
.header-back{background:none;border:none;color:var(--text2);font-size:20px;cursor:pointer;margin-right:4px;}

/* â”€â”€â”€ ç”»é¢ç®¡ç† â”€â”€â”€ */
.screen{display:none;flex-direction:column;min-height:calc(100vh - 48px);}
.screen.active{display:flex;}

/* â”€â”€â”€ ãƒ›ãƒ¼ãƒ ç”»é¢ â”€â”€â”€ */
.home-hero{background:linear-gradient(160deg,#111 0%,#0a0a0a 100%);padding:48px 24px 36px;text-align:center;border-bottom:1px solid var(--border);}
.home-logo{font-family:'Bebas Neue',sans-serif;font-size:38px;color:var(--accent);letter-spacing:4px;line-height:1;}
.home-tagline{font-size:11px;color:var(--text2);letter-spacing:2px;margin-top:6px;}
.home-lead{font-size:15px;font-weight:900;color:var(--text);margin-top:20px;margin-bottom:6px;}
.home-desc{font-size:12px;color:var(--text2);line-height:1.8;}

.home-body{padding:24px 16px;display:flex;flex-direction:column;gap:16px;}
.setup-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;}
.setup-title{font-size:13px;font-weight:900;color:var(--text);margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.setup-sub{font-size:11px;color:var(--text2);margin-bottom:14px;}
.setup-label{font-size:10px;color:var(--text2);margin-bottom:4px;font-weight:700;}
.home-input{width:100%;background:#111;border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--text);font-family:inherit;outline:none;transition:border-color .2s;}
.home-input:focus{border-color:rgba(232,160,32,.5);}
.home-input::placeholder{color:#444;}
.home-select{width:100%;background:#111;border:1.5px solid var(--border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--text);font-family:inherit;outline:none;appearance:none;cursor:pointer;}
.home-select:focus{border-color:rgba(232,160,32,.5);}
.select-wrap{position:relative;}
.select-wrap::after{content:'â–¾';position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--text2);pointer-events:none;}

.start-btn{width:100%;padding:18px;background:var(--accent);color:#000;border:none;border-radius:14px;font-size:18px;font-weight:900;font-family:inherit;cursor:pointer;transition:opacity .15s;}
.start-btn:active{opacity:.85;}

.guide-btn{width:100%;padding:14px;background:transparent;color:var(--accent);border:1.5px solid rgba(232,160,32,.3);border-radius:14px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;}

/* â”€â”€â”€ ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼ â”€â”€â”€ */
.step-bar{background:var(--surface);border-bottom:1px solid var(--border);padding:8px 12px;display:flex;align-items:center;gap:2px;}
.sbar-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;min-width:0;}
.sbar-dot{width:8px;height:8px;border-radius:50%;background:var(--border);}
.sbar-dot.done{background:var(--ok);}
.sbar-dot.active{background:var(--accent);box-shadow:0 0 0 3px rgba(232,160,32,.2);}
.sbar-label{font-size:9px;color:var(--text2);font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;text-align:center;}
.sbar-label.active{color:var(--accent);}
.sbar-line{width:16px;min-width:8px;height:1px;background:var(--border);flex:none;}
.sbar-line.done{background:var(--ok);}

/* â”€â”€ STEP2: å†™çœŸã‚¢ãƒƒãƒ— â”€â”€ */
.s2-body{padding:16px;display:flex;flex-direction:column;gap:16px;padding-bottom:160px;}
.section-label{font-size:11px;font-weight:700;color:var(--text2);letter-spacing:1px;display:flex;align-items:center;gap:6px;}
.section-label::before{content:'';width:3px;height:11px;background:var(--accent);border-radius:2px;}
.tag-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
.tag-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;padding:14px 4px;border-radius:16px;border:2px solid #1e1e1e;background:#111;color:#444;cursor:pointer;font-family:inherit;transition:all .2s;min-height:80px;}
.tag-btn .ti{font-size:24px;line-height:1;}
.tag-btn .tc{font-size:11px;font-weight:700;line-height:1.2;text-align:center;}
.tag-btn .tn{font-size:10px;font-weight:900;padding:2px 7px;border-radius:100px;background:rgba(255,255,255,.06);margin-top:2px;}
.tag-btn.active.t-b{border-color:var(--before);background:rgba(74,158,255,.12);color:var(--before);box-shadow:0 0 0 3px rgba(74,158,255,.15);}
.tag-btn.active.t-d{border-color:var(--during);background:rgba(168,85,247,.12);color:var(--during);box-shadow:0 0 0 3px rgba(168,85,247,.15);}
.tag-btn.active.t-a{border-color:var(--after);background:rgba(34,197,94,.12);color:var(--after);box-shadow:0 0 0 3px rgba(34,197,94,.15);}
.tag-btn.active.t-p{border-color:var(--pickup);background:rgba(245,158,11,.12);color:var(--pickup);box-shadow:0 0 0 3px rgba(245,158,11,.15);}
.tag-btn.active.t-o{border-color:var(--other);background:rgba(148,163,184,.10);color:var(--other);box-shadow:0 0 0 3px rgba(148,163,184,.12);}
.upload-zone{border-radius:20px;padding:32px 20px;text-align:center;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:10px;transition:all .2s;border:3px dashed var(--border);background:var(--surface);}
.upload-zone:active{transform:scale(.98);}
.uz-icon{font-size:44px;line-height:1;}
.uz-main{font-size:20px;font-weight:900;}
.uz-tag-pill{font-size:13px;font-weight:700;padding:5px 16px;border-radius:100px;}
.uz-hint{font-size:11px;color:var(--text2);}
.uz-b{border-color:var(--before)!important;background:rgba(74,158,255,.06)!important;}
.uz-d{border-color:var(--during)!important;background:rgba(168,85,247,.06)!important;}
.uz-a{border-color:var(--after)!important;background:rgba(34,197,94,.06)!important;}
.uz-p{border-color:var(--pickup)!important;background:rgba(245,158,11,.06)!important;}
.uz-o{border-color:var(--other)!important;background:rgba(148,163,184,.06)!important;}
.pill-b{background:rgba(74,158,255,.2);color:var(--before);}
.pill-d{background:rgba(168,85,247,.2);color:var(--during);}
.pill-a{background:rgba(34,197,94,.2);color:var(--after);}
.pill-p{background:rgba(245,158,11,.2);color:var(--pickup);}
.pill-o{background:rgba(148,163,184,.15);color:var(--other);}
.uploaded-section{display:flex;flex-direction:column;gap:10px;}
.thumb-scroll{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:10px;padding-top:4px;}
.thumb-scroll::-webkit-scrollbar{display:none;}
.thumb-item{position:relative;flex-shrink:0;width:100px;height:100px;border-radius:10px;overflow:hidden;cursor:pointer;}
.thumb-item img{width:100%;height:100%;object-fit:cover;display:block;}
.thumb-tag{position:absolute;bottom:0;left:0;right:0;font-size:8px;font-weight:700;text-align:center;padding:2px 0;}
.tb-b{background:rgba(74,158,255,.85);}
.tb-d{background:rgba(168,85,247,.85);}
.tb-a{background:rgba(34,197,94,.85);color:#000;}
.tb-p{background:rgba(245,158,11,.85);color:#000;}
.tb-o{background:rgba(148,163,184,.8);color:#000;}
.thumb-del{position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;background:rgba(239,68,68,.9);display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;border:none;cursor:pointer;}
.orient-badge{position:absolute;top:3px;left:3px;font-size:8px;font-weight:700;padding:1px 4px;border-radius:3px;background:rgba(0,0,0,.7);color:#ccc;line-height:1.4;}
.orient-filter{display:flex;gap:5px;align-items:center;}
.of-btn{padding:5px 11px;border-radius:100px;font-size:11px;font-weight:700;border:1.5px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;}
.of-btn.on{background:#222;border-color:#555;color:var(--text);}
.of-btn.on.of-port,.of-btn.on.of-land{border-color:var(--accent);color:var(--accent);background:rgba(232,160,32,.1);}
.tag-row{display:flex;align-items:center;gap:6px;margin-bottom:4px;}
.tag-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.tag-name{font-size:12px;font-weight:700;}
.tag-cnt{font-size:11px;color:var(--text2);}

/* â”€â”€ STEP3: å†™çœŸæ•´ç† â”€â”€ */
.s3-body{padding:16px;display:flex;flex-direction:column;gap:16px;padding-bottom:100px;}
.prog-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:13px 14px;display:flex;flex-direction:column;gap:8px;}
.prog-top{display:flex;align-items:center;justify-content:space-between;}
.prog-label{font-size:12px;font-weight:700;color:var(--text2);}
.prog-nums{display:flex;gap:14px;}
.pn{text-align:center;}
.pn-v{font-size:20px;font-weight:900;line-height:1;}
.pn-l{font-size:10px;color:var(--text2);margin-top:2px;}
.prog-bar-wrap{background:#111;border-radius:100px;height:5px;overflow:hidden;}
.prog-bar{height:100%;border-radius:100px;background:linear-gradient(90deg,var(--before),var(--after));transition:width .4s;}
.prog-msg{font-size:11px;line-height:1.6;}
.ok{color:var(--after);}
.warn{color:var(--danger);}
.dim{color:var(--text2);}
.frow{display:flex;gap:5px;overflow-x:auto;scrollbar-width:none;padding-right:4px;}
.frow::-webkit-scrollbar{display:none;}
.fbtn{flex-shrink:0;padding:7px 12px;border-radius:100px;font-size:11px;font-weight:700;border:1.5px solid var(--border);background:transparent;color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;}
.fbtn.on.f-all{background:var(--accent);border-color:var(--accent);color:#000;}
.fbtn.on.f-b{background:var(--before);border-color:var(--before);color:#fff;}
.fbtn.on.f-a{background:var(--after);border-color:var(--after);color:#000;}
.fbtn.on.f-pair{background:linear-gradient(90deg,var(--before),var(--after));border:none;color:#fff;}
.fbtn.on.f-none{background:var(--danger);border-color:var(--danger);color:#fff;}
.fbtn.on.f-solo{background:var(--pickup);border-color:var(--pickup);color:#000;}
.pair-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;}
.pair-card.ok{border-color:rgba(34,197,94,.3);}
.pair-card.warn{border-color:rgba(239,68,68,.25);}
.pair-header{padding:10px 14px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--border);}
.pair-num{font-family:'Bebas Neue',sans-serif;font-size:22px;color:var(--accent);letter-spacing:1px;}
.pair-badge{font-size:10px;font-weight:700;padding:2px 10px;border-radius:100px;margin-left:auto;}
.pb-ok{background:rgba(34,197,94,.12);color:var(--after);}
.pb-warn{background:rgba(239,68,68,.1);color:var(--danger);}
.pair-images{display:grid;grid-template-columns:1fr 1fr;gap:2px;align-items:start;}
.pair-slot{position:relative;}
.pair-slot img{width:100%;display:block;object-fit:cover;aspect-ratio:4/3;}
.pair-slot img.port-img{aspect-ratio:3/4;}
.pair-slot img.land-img{aspect-ratio:4/3;}
.orient-pill{position:absolute;top:5px;left:5px;font-size:9px;font-weight:700;padding:2px 7px;border-radius:100px;background:rgba(0,0,0,.75);color:#e0e0e0;letter-spacing:.5px;}
.s3-guide{background:rgba(232,160,32,.07);border:1px solid rgba(232,160,32,.2);border-radius:12px;padding:12px 14px;font-size:11px;color:var(--text2);line-height:2.0;}
.s3-guide strong{color:var(--accent);}
.pair-slot-empty{aspect-ratio:4/3;background:#111;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:4px;font-size:11px;color:var(--text2);}
.slot-lbl{position:absolute;bottom:0;left:0;right:0;font-size:9px;font-weight:700;text-align:center;padding:3px;}
.sl-b{background:rgba(74,158,255,.85);}
.sl-a{background:rgba(34,197,94,.85);color:#000;}
.assign-btn{position:absolute;bottom:22px;right:5px;min-width:28px;height:28px;padding:0 7px;border-radius:8px;background:rgba(0,0,0,.85);border:1.5px solid rgba(232,160,32,.6);color:var(--accent);font-size:12px;font-weight:900;cursor:pointer;font-family:inherit;}
.assign-btn.unset{border-color:rgba(255,255,255,.2);color:var(--text2);}
.del-btn{position:absolute;top:5px;right:5px;width:28px;height:28px;border-radius:8px;background:rgba(232,160,32,.85);border:none;color:#000;font-size:13px;cursor:pointer;font-weight:900;}
.solo-section{display:flex;flex-direction:column;gap:10px;}
.solo-header{display:flex;align-items:center;justify-content:space-between;padding:0 2px;}
.solo-title{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:700;}
.solo-dot{width:9px;height:9px;border-radius:50%;}
.solo-count{font-size:11px;color:var(--text2);}
.solo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;}.solo-grid .port-frame{grid-column:span 1;}.solo-grid .land-frame{grid-column:span 1;}
.solo-item{position:relative;border-radius:10px;overflow:hidden;}
.solo-item img{width:100%;display:block;object-fit:cover;aspect-ratio:4/3;}.solo-item img.port-img{aspect-ratio:3/4;}.solo-item img.land-img{aspect-ratio:4/3;}
.solo-tag{position:absolute;bottom:0;left:0;right:0;font-size:9px;font-weight:700;text-align:center;padding:3px 0;}
.st-d{background:rgba(168,85,247,.85);}
.st-p{background:rgba(245,158,11,.85);color:#000;}
.st-o{background:rgba(148,163,184,.8);color:#000;}
.st-b{background:rgba(74,158,255,.85);}
.st-a{background:rgba(34,197,94,.85);color:#000;}
.include-toggle{position:absolute;top:5px;left:5px;display:flex;align-items:center;gap:0;background:rgba(0,0,0,.8);border-radius:100px;padding:3px 8px 3px 4px;cursor:pointer;border:none;font-family:inherit;}
.toggle-dot{width:14px;height:14px;border-radius:50%;background:#333;transition:background .2s;flex-shrink:0;}
.toggle-dot.on{background:var(--after);}
.toggle-lbl{font-size:9px;font-weight:700;color:var(--text2);margin-left:4px;transition:color .2s;white-space:nowrap;}
.toggle-lbl.on{color:var(--after);}
.nopair-section{background:rgba(239,68,68,.05);border:1px solid rgba(239,68,68,.18);border-radius:14px;padding:12px;}
.nopair-header{font-size:12px;font-weight:700;color:var(--danger);margin-bottom:10px;display:flex;align-items:center;gap:6px;}
.nopair-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}
.nopair-item{position:relative;border-radius:8px;overflow:hidden;}
.nopair-item img{width:100%;display:block;object-fit:cover;aspect-ratio:1;}
.nopair-assign{position:absolute;inset:0;display:flex;align-items:flex-end;justify-content:flex-end;padding:4px;}
.empty-sec{border:1px dashed var(--border);border-radius:12px;padding:24px;text-align:center;font-size:12px;color:var(--text2);line-height:2;}
.empty-sec .ei{font-size:36px;margin-bottom:8px;}
.sheet{position:fixed;inset:0;max-width:480px;margin:0 auto;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);z-index:300;display:none;flex-direction:column;align-items:center;justify-content:flex-end;padding-bottom:28px;}
.sheet.show{display:flex;}
.sheet-card{width:calc(100% - 28px);background:var(--surface);border:1px solid var(--border);border-radius:22px;padding:20px 16px;}
.sheet-thumb{width:100%;aspect-ratio:16/9;border-radius:12px;overflow:hidden;margin-bottom:14px;}
.sheet-thumb img{width:100%;height:100%;object-fit:cover;}
.sheet-label{font-size:12px;font-weight:700;color:var(--text2);text-align:center;margin-bottom:12px;}
.sheet-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:12px;}
.sn-btn{aspect-ratio:1;border-radius:12px;border:2px solid var(--border);background:#111;color:var(--text2);font-size:24px;font-weight:900;cursor:pointer;font-family:inherit;transition:all .2s;display:flex;align-items:center;justify-content:center;}
.sn-btn.sel{border-color:var(--accent);background:var(--accent);color:#000;transform:scale(1.05);}
.sn-btn.paired{border-color:rgba(34,197,94,.4);color:var(--after);}
.sn-add{font-size:16px;border-style:dashed;border-color:rgba(232,160,32,.35);color:var(--accent);}
.sn-none{grid-column:span 4;border-radius:12px;border:2px solid var(--border);background:#111;color:var(--text2);font-size:12px;font-weight:700;padding:12px;cursor:pointer;font-family:inherit;transition:all .15s;text-align:center;}
.sn-none.sel{border-color:var(--other);background:rgba(148,163,184,.1);color:var(--other);}
.sheet-actions{display:flex;gap:8px;margin-top:4px;}
.sh-cancel{flex:1;padding:14px;background:transparent;border:1px solid var(--border);border-radius:12px;font-size:14px;font-weight:700;color:var(--text2);cursor:pointer;font-family:inherit;}
.sh-apply{flex:2;padding:14px;background:var(--accent);border:none;border-radius:12px;font-size:14px;font-weight:700;color:#000;cursor:pointer;font-family:inherit;}

/* â”€â”€ STEP4: å ±å‘Šæ›¸å…¥åŠ› â”€â”€ */
.s4-body{padding:16px;display:flex;flex-direction:column;gap:0;padding-bottom:100px;}
.field{border-left:3px solid var(--accent);padding:14px 14px 14px 12px;margin-bottom:1px;background:var(--surface);}
.field:first-child{border-radius:12px 12px 0 0;}
.field:last-child{border-radius:0 0 12px 12px;margin-bottom:16px;}
.field-label{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.field-label .opt{font-size:9px;color:var(--text2);font-weight:400;}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:6px;}
.chip{padding:7px 14px;border-radius:100px;font-size:13px;font-weight:700;border:2px solid var(--border);background:#111;color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;}
.chip.on{border-color:var(--accent);background:rgba(232,160,32,.15);color:var(--accent);}
.color-chip{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:100px;font-size:12px;font-weight:700;border:2px solid var(--border);background:#111;color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;}
.color-chip.on{border-color:var(--accent);background:rgba(232,160,32,.15);color:var(--accent);}
.cdot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.finput{width:100%;background:#111;border:1.5px solid var(--border);border-radius:10px;padding:11px 12px;font-size:13px;color:var(--text);font-family:inherit;outline:none;transition:border-color .2s;}
.finput.auto-grow{overflow-y:hidden;resize:none;min-height:80px;}
.finput:focus{border-color:rgba(232,160,32,.5);}
.finput::placeholder{color:#444;}
textarea.finput{resize:none;line-height:1.7;}
.num-row{display:flex;gap:10px;align-items:center;}
.num-wrap{display:flex;align-items:center;gap:6px;flex:1;}
.num-wrap .finput{text-align:right;}
.num-unit{font-size:12px;color:var(--text2);white-space:nowrap;}
.yn-btn{padding:7px 20px;border-radius:100px;font-size:13px;font-weight:700;border:2px solid var(--border);background:#111;color:var(--text2);cursor:pointer;font-family:inherit;transition:all .15s;}
.yn-btn.on{border-color:var(--accent);background:rgba(232,160,32,.15);color:var(--accent);}
.ex-btn{font-size:11px;color:var(--accent);background:transparent;border:none;cursor:pointer;font-family:inherit;padding:4px 0;text-decoration:underline;display:block;margin-top:4px;}
.photo-summary-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;font-size:12px;color:var(--text2);line-height:1.9;margin-top:16px;}

/* â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ â”€â”€ */
.preview-body{padding:16px;display:flex;flex-direction:column;gap:12px;padding-bottom:260px;}
.send-section-title{font-size:11px;font-weight:700;color:var(--text2);margin-bottom:6px;padding:0 2px;display:flex;align-items:center;gap:6px;}
.send-section-title::before{content:'';width:3px;height:10px;background:var(--accent);border-radius:2px;}
.send-text-box{background:#111;border:1px solid var(--border);border-radius:12px;padding:14px;font-size:13px;line-height:1.9;color:var(--text);white-space:pre-wrap;word-break:break-all;}
.steps-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;}
.steps-title{font-size:12px;font-weight:900;color:var(--accent);margin-bottom:8px;}
.step-row{font-size:12px;color:var(--text2);margin-bottom:4px;display:flex;align-items:flex-start;gap:6px;}
.step-num{color:var(--accent);font-weight:700;flex-shrink:0;}
.fb-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:16px;}

/* â”€â”€ å›ºå®šãƒœã‚¿ãƒ³å…±é€š â”€â”€ */
.fixed-footer{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;padding:10px 16px;background:rgba(15,15,15,.96);backdrop-filter:blur(10px);border-top:1px solid var(--border);z-index:100;display:flex;flex-direction:column;gap:8px;}
.primary-btn{width:100%;padding:16px;background:var(--accent);color:#000;border:none;border-radius:12px;font-size:16px;font-weight:900;font-family:inherit;cursor:pointer;transition:opacity .15s;}
.primary-btn:active{opacity:.85;}
.primary-btn:disabled{opacity:.3;cursor:not-allowed;}
.secondary-btn{width:100%;padding:13px;background:transparent;border:1.5px solid var(--border);border-radius:12px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;color:var(--text2);}
.danger-btn{background:transparent;color:var(--danger);border:1.5px solid rgba(239,68,68,.3);border-radius:12px;padding:11px;font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;flex:1;}
.action-row{display:flex;gap:8px;}
.btn-copy{background:var(--accent);color:#000;border:none;}
.btn-zip{background:#222;color:var(--text);border:1.5px solid var(--border);}
.copied-flash{background:var(--ok)!important;color:#000!important;border-color:var(--ok)!important;}

/* â”€â”€ ãƒˆãƒ¼ã‚¹ãƒˆ â”€â”€ */
.toast{position:fixed;bottom:220px;left:50%;transform:translateX(-50%) translateY(12px);background:rgba(232,160,32,.97);color:#000;padding:12px 28px;border-radius:100px;font-size:13px;font-weight:700;opacity:0;transition:all .25s;z-index:999;white-space:nowrap;pointer-events:none;}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â”€â”€ å ±å‘Šä¸€è¦§ã‚«ãƒ¼ãƒ‰ â”€â”€ */
.report-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:border-color .15s;margin-bottom:8px;}
.report-card:active{border-color:var(--accent);}
.report-card-icon{width:44px;height:44px;border-radius:10px;background:rgba(232,160,32,.1);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.report-card-body{flex:1;min-width:0;}
.report-card-title{font-size:14px;font-weight:900;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.report-card-meta{font-size:11px;color:var(--text2);margin-top:2px;}
.report-card-del{width:32px;height:32px;border-radius:8px;background:transparent;border:1px solid rgba(239,68,68,.2);color:var(--danger);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.empty-home{text-align:center;padding:40px 20px;color:var(--text2);font-size:13px;line-height:2;}
.empty-home .ei{font-size:40px;margin-bottom:12px;}
</style>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" onerror="window._jszipFailed=true"></script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     å…±é€šãƒ˜ãƒƒãƒ€ãƒ¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="app-header" id="app-header">
  <div>
    <div class="app-logo">RS-Reporter Pro</div>
    <div class="app-sub">è·äººã®3ç§’ã‚’ã€ä¼šç¤¾ã®è³‡ç”£ã«å¤‰ãˆã‚‹</div>
  </div>
  <div class="header-step" id="header-step"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 0a: åˆå›ç™»éŒ²
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-register">
  <div class="home-hero">
    <div class="home-logo">RS-REPORTER PRO</div>
    <div class="home-tagline">ROLLERSTONE èªå®šæ–½å·¥åº—å‘ã‘ æ–½å·¥å ±å‘Šã‚¢ãƒ—ãƒª</div>
    <div class="home-lead">åº—èˆ—æƒ…å ±ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</div>
    <div class="home-desc">ä¸€åº¦ç™»éŒ²ã™ã‚Œã°æ¬¡å›ã‹ã‚‰è‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™</div>
  </div>
  <div class="home-body">
    <div class="setup-card">
      <div class="setup-title">ğŸ¢ åº—èˆ—ãƒ»æ‹…å½“è€…æƒ…å ±</div>
      <div class="setup-sub">å…¥åŠ›å¾Œã€Œç™»éŒ²ã—ã¦ã¯ã˜ã‚ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
      <div style="display:flex;flex-direction:column;gap:10px;">
        <div>
          <div class="setup-label">éƒ½é“åºœçœŒ</div>
          <div class="select-wrap">
            <select class="home-select" id="home-pref">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option>åŒ—æµ·é“</option><option>é’æ£®çœŒ</option><option>å²©æ‰‹çœŒ</option><option>å®®åŸçœŒ</option><option>ç§‹ç”°çœŒ</option>
              <option>å±±å½¢çœŒ</option><option>ç¦å³¶çœŒ</option><option>èŒ¨åŸçœŒ</option><option>æ ƒæœ¨çœŒ</option><option>ç¾¤é¦¬çœŒ</option>
              <option>åŸ¼ç‰çœŒ</option><option>åƒè‘‰çœŒ</option><option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option><option>æ–°æ½ŸçœŒ</option>
              <option>å¯Œå±±çœŒ</option><option>çŸ³å·çœŒ</option><option>ç¦äº•çœŒ</option><option>å±±æ¢¨çœŒ</option><option>é•·é‡çœŒ</option>
              <option>å²é˜œçœŒ</option><option>é™å²¡çœŒ</option><option>æ„›çŸ¥çœŒ</option><option>ä¸‰é‡çœŒ</option><option>æ»‹è³€çœŒ</option>
              <option>äº¬éƒ½åºœ</option><option>å¤§é˜ªåºœ</option><option>å…µåº«çœŒ</option><option>å¥ˆè‰¯çœŒ</option><option>å’Œæ­Œå±±çœŒ</option>
              <option>é³¥å–çœŒ</option><option>å³¶æ ¹çœŒ</option><option>å²¡å±±çœŒ</option><option>åºƒå³¶çœŒ</option><option>å±±å£çœŒ</option>
              <option>å¾³å³¶çœŒ</option><option>é¦™å·çœŒ</option><option>æ„›åª›çœŒ</option><option>é«˜çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
              <option>ä½è³€çœŒ</option><option>é•·å´çœŒ</option><option>ç†Šæœ¬çœŒ</option><option>å¤§åˆ†çœŒ</option><option>å®®å´çœŒ</option>
              <option>é¹¿å…å³¶çœŒ</option><option>æ²–ç¸„çœŒ</option>
            </select>
          </div>
        </div>
        <div>
          <div class="setup-label">ä¼šç¤¾å</div>
          <input class="home-input" id="home-company" placeholder="ä¾‹ï¼šã¬ãƒ¼ã¾ã‚“å·¥å‹™åº—">
        </div>
        <div>
          <div class="setup-label">æ‹…å½“è€…å</div>
          <input class="home-input" id="home-staff" placeholder="ä¾‹ï¼šã¬ãƒ¼ã¾ã‚“">
        </div>
      </div>
    </div>
    <a class="guide-btn" href="https://rsw-member.github.io/RS-tool/Report-pro/rs-reporter-app-overview.html" target="_blank" style="display:block;text-align:center;text-decoration:none;">ä½¿ã„æ–¹ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆäºˆå®šã‚’è¦‹ã‚‹ â†’</a>
    <button class="start-btn" onclick="startApp()">ç™»éŒ²ã—ã¦ã¯ã˜ã‚ã‚‹</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 0b: ãƒ¡ã‚¤ãƒ³ãƒ›ãƒ¼ãƒ ï¼ˆç¾å ´ä¸€è¦§ï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-home">
  <!-- åº—èˆ—ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div style="background:#000;border-bottom:1px solid var(--border);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div style="font-size:11px;color:var(--text2);" id="home-info-pref"></div>
      <div style="font-size:15px;font-weight:900;color:var(--text);" id="home-info-company"></div>
      <div style="font-size:12px;color:var(--accent);" id="home-info-staff"></div>
    </div>
    <button onclick="showRegister()" style="background:transparent;border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--text2);font-family:inherit;cursor:pointer;">è¨­å®šå¤‰æ›´</button>
  </div>
  <!-- æ–°è¦ä½œæˆãƒœã‚¿ãƒ³ -->
  <div style="padding:16px 16px 8px;">
    <button class="start-btn" onclick="showNewSiteSheet()" style="font-size:16px;padding:16px;">ï¼‹ æ–°ã—ã„ç¾å ´ã®å ±å‘Šã‚’ä½œæˆ</button>
    <a class="guide-btn" href="https://rsw-member.github.io/RS-tool/Report-pro/rs-reporter-app-overview.html" target="_blank" style="display:block;text-align:center;text-decoration:none;margin-top:10px;">ä½¿ã„æ–¹ãƒ»ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆäºˆå®šã‚’è¦‹ã‚‹ â†’</a>
  </div>
  <!-- å ±å‘Šæ¸ˆã¿ä¸€è¦§ -->
  <div style="padding:0 16px 16px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <div style="font-size:13px;font-weight:900;color:var(--text);display:flex;align-items:center;gap:8px;">
        <div style="width:3px;height:14px;background:var(--accent);border-radius:2px;"></div>
        å ±å‘Šæ¸ˆã¿ã®ç¾å ´
      </div>
      <div style="font-size:11px;color:var(--text2);" id="home-report-count"></div>
    </div>
    <div id="home-report-list"></div>
  </div>
</div>

<!-- ç¾å ´åå…¥åŠ›ã‚·ãƒ¼ãƒˆ -->
<div class="sheet" id="new-site-sheet">
  <div class="sheet-card">
    <div style="font-size:16px;font-weight:900;color:var(--text);margin-bottom:4px;">ğŸ— ç¾å ´æƒ…å ±ã‚’å…¥åŠ›</div>
    <div style="font-size:12px;color:var(--text2);margin-bottom:16px;">å ±å‘Šæ›¸ã®ã‚¿ã‚¤ãƒˆãƒ«ã«ãªã‚Šã¾ã™</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div>
        <div class="setup-label">ãŠå®¢æ§˜å</div>
        <input class="home-input" id="ns-client" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜é‚¸">
      </div>
      <div>
        <div class="setup-label">æ–½å·¥å ´æ‰€</div>
        <input class="home-input" id="ns-place" placeholder="ä¾‹ï¼šé§è»Šå ´ã€ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ">
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px;">
      <button class="sh-cancel" onclick="closeNewSiteSheet()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="sh-apply" onclick="startNewSite()">ä½œæˆã—ã¦STEP2ã¸ â†’</button>
    </div>
  </div>
</div>

<!-- å ±å‘Šãƒ†ã‚­ã‚¹ãƒˆç¢ºèªã‚·ãƒ¼ãƒˆ -->
<div class="sheet" id="report-view-sheet">
  <div class="sheet-card" style="max-height:80vh;overflow-y:auto;">
    <div style="font-size:14px;font-weight:900;color:var(--accent);margin-bottom:12px;" id="rv-title"></div>
    <div style="background:#111;border-radius:10px;padding:14px;font-size:12px;line-height:1.9;color:var(--text);white-space:pre-wrap;word-break:break-all;margin-bottom:14px;" id="rv-text"></div>
    <div style="display:flex;gap:8px;">
      <button class="sh-cancel" style="flex:1;" onclick="closeReportView()">é–‰ã˜ã‚‹</button>
      <button class="sh-apply" style="flex:1;" onclick="copyReportText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
    <button onclick="deleteReport()" style="width:100%;margin-top:8px;padding:11px;background:transparent;border:1.5px solid rgba(239,68,68,.3);border-radius:12px;font-size:13px;font-weight:700;color:var(--danger);font-family:inherit;cursor:pointer;">ğŸ—‘ ã“ã®å ±å‘Šã‚’å‰Šé™¤</button>
  </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—ãƒãƒ¼ï¼ˆSTEP2ã€œ4ã§è¡¨ç¤ºï¼‰ -->
<div id="step-bar-wrap" style="display:none;">
  <div class="step-bar">
    <div class="sbar-item">
      <div class="sbar-dot" id="sd-2"></div>
      <div class="sbar-label" id="sl-2">å†™çœŸã‚¢ãƒƒãƒ—</div>
    </div>
    <div class="sbar-line" id="sl-line-1"></div>
    <div class="sbar-item">
      <div class="sbar-dot" id="sd-3"></div>
      <div class="sbar-label" id="sl-3">å†™çœŸæ•´ç†</div>
    </div>
    <div class="sbar-line" id="sl-line-2"></div>
    <div class="sbar-item">
      <div class="sbar-dot" id="sd-4"></div>
      <div class="sbar-label" id="sl-4">å ±å‘Šæ›¸</div>
    </div>
    <div class="sbar-line" id="sl-line-3"></div>
    <div class="sbar-item">
      <div class="sbar-dot" id="sd-5"></div>
      <div class="sbar-label" id="sl-5">é€ä»˜</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 2: å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-s2">
<div class="s2-body">
  <!-- æ“ä½œã‚¬ã‚¤ãƒ‰ -->
  <div style="background:rgba(232,160,32,.08);border:1.5px solid rgba(232,160,32,.25);border-radius:14px;padding:16px;">
    <div style="font-size:14px;font-weight:900;color:var(--accent);margin-bottom:12px;">ğŸ“· å†™çœŸã®ã‚¢ãƒƒãƒ—æ–¹æ³•</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">1</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">ã‚¿ã‚°ã‚’é¸ã¶ï¼ˆBefore / é€ å½¢å¾Œ / After â€¦ï¼‰</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">2</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">ã‚¢ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦å†™çœŸã‚’é¸ã¶ï¼ˆè¤‡æ•°OKï¼‰</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">ã‚¿ã‚°ã‚’åˆ‡ã‚Šæ›¿ãˆãªãŒã‚‰ç¹°ã‚Šè¿”ã™</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.15);border-radius:10px;padding:11px 12px;">
        <div style="font-size:18px;flex-shrink:0;">ğŸ’¡</div>
        <div style="font-size:12px;color:var(--text2);line-height:1.6;">Beforeã ã‘ãƒ»é€ å½¢å¾Œã¾ã§ã€<strong style="color:var(--text);">é€”ä¸­ã§ã‚‚ä¿å­˜ã§ãã¾ã™ã€‚</strong>å¾Œæ—¥ç¶šãã‹ã‚‰ã‚¢ãƒƒãƒ—å¯èƒ½ã§ã™ã€‚</div>
      </div>
    </div>
  </div>
  <!-- ã‚¿ã‚°é¸æŠ -->
  <div>
    <div class="section-label" style="margin-bottom:12px;">â‘  ã‚¿ã‚°ã‚’é¸ã¶</div>
    <div class="tag-grid">
      <button class="tag-btn t-b active" id="tb-b" onclick="s2SelectTag('b',this)">
        <span class="ti">ğŸ“·</span><span class="tc">Before</span><span class="tn" id="cn-b">0</span>
      </button>
      <button class="tag-btn t-d" id="tb-d" onclick="s2SelectTag('d',this)">
        <span class="ti">ğŸ”¨</span><span class="tc">é€ å½¢å¾Œ</span><span class="tn" id="cn-d">0</span>
      </button>
      <button class="tag-btn t-a" id="tb-a" onclick="s2SelectTag('a',this)">
        <span class="ti">âœ¨</span><span class="tc">After</span><span class="tn" id="cn-a">0</span>
      </button>
      <button class="tag-btn t-p" id="tb-p" onclick="s2SelectTag('p',this)">
        <span class="ti">â­</span><span class="tc">ã“ã <br>ã‚ã‚Š</span><span class="tn" id="cn-p">0</span>
      </button>
      <button class="tag-btn t-o" id="tb-o" onclick="s2SelectTag('o',this)">
        <span class="ti">ğŸ“Œ</span><span class="tc">ãã®ä»–</span><span class="tn" id="cn-o">0</span>
      </button>
    </div>
  </div>
  <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¾ãƒ¼ãƒ³ -->
  <div>
    <div class="section-label" style="margin-bottom:12px;">â‘¡ å†™çœŸã‚’ã‚¢ãƒƒãƒ—</div>
    <label class="upload-zone uz-b" id="s2-uz">
      <input type="file" accept="image/*" multiple style="display:none;" id="s2-file-input" onchange="s2HandleFiles(this.files)">
      <div class="uz-icon">ğŸ“</div>
      <div class="uz-main">ã‚¿ãƒƒãƒ—ã—ã¦è¿½åŠ </div>
      <div class="uz-tag-pill pill-b" id="uz-pill">ğŸ“· Before ã¨ã—ã¦è¿½åŠ </div>
      <div class="uz-hint">è¤‡æ•°é¸æŠOK</div>
    </label>
  </div>
  <!-- ã‚¢ãƒƒãƒ—æ¸ˆã¿å†™çœŸ -->
  <div class="uploaded-section" id="s2-uploaded" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">
      <div class="section-label">ã‚¢ãƒƒãƒ—æ¸ˆã¿å†™çœŸ</div>
      <div class="orient-filter">
        <button class="of-btn on" onclick="s2SetOrient('all',this)">ã™ã¹ã¦</button>
        <button class="of-btn of-port" onclick="s2SetOrient('port',this)">â–¯ ç¸¦</button>
        <button class="of-btn of-land" onclick="s2SetOrient('land',this)">â–­ æ¨ª</button>
      </div>
    </div>
    <div id="s2-thumb-area"></div>
  </div>
</div>
<div class="fixed-footer">
  <button class="primary-btn" id="s2-next-btn" disabled onclick="goTo('s3')">å†™çœŸã‚’æ•´ç†ã™ã‚‹ â†’</button>
  <div style="display:flex;gap:8px;">
    <button class="secondary-btn" style="flex:1;" onclick="goTo('home')">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
    <button id="s2-save-btn" style="flex:1;padding:13px;background:rgba(34,197,94,.15);color:var(--ok);border:1.5px solid rgba(34,197,94,.3);border-radius:12px;font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;" onclick="saveAndExit()">ğŸ’¾ é€”ä¸­ä¿å­˜ã—ã¦çµ‚ã‚ã‚‹</button>
  </div>
</div>
</div><!-- screen-s2 -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 3: å†™çœŸæ•´ç†ãƒ»ãƒšã‚¢ãƒªãƒ³ã‚°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-s3">
<div class="s3-body">
  <div style="background:rgba(232,160,32,.08);border:1.5px solid rgba(232,160,32,.25);border-radius:14px;padding:16px;">
    <div style="font-size:14px;font-weight:900;color:var(--accent);margin-bottom:12px;display:flex;align-items:center;gap:8px;">ğŸ“Œ æ“ä½œæ–¹æ³•</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;align-items:flex-start;gap:10px;">
        <div style="width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;font-size:12px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">1</div>
        <div style="font-size:13px;color:var(--text);line-height:1.6;">å†™çœŸã‚’ã‚¿ãƒƒãƒ— â†’ ãƒšã‚¢ç•ªå·ï¼ˆâ‘ â‘¡â‘¢â€¦ï¼‰ã‚’å‰²ã‚Šå½“ã¦</div>
      </div>
      <div style="display:flex;align-items:flex-start;gap:10px;">
        <div style="width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;font-size:12px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">2</div>
        <div style="font-size:13px;color:var(--text);line-height:1.6;"><strong style="color:var(--accent);">ãƒšã‚¢ç¢ºèª</strong>ã‚¿ãƒ–ã§ Before/After ã‚’ä¸¦ã¹ã¦ç¢ºèªã€ä¿®æ­£ã§ãã¾ã™</div>
      </div>
      <div style="display:flex;align-items:flex-start;gap:10px;">
        <div style="width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;font-size:12px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
        <div style="font-size:13px;color:var(--text);line-height:1.6;">ã‚¿ã‚°ã‚’é–“é•ãˆãŸå ´åˆã¯å†™çœŸã‚¿ãƒƒãƒ— â†’ <strong style="color:var(--pickup);">ã‚¿ã‚°å¤‰æ›´</strong>ã§ä¿®æ­£ã§ãã¾ã™</div>
      </div>
      <div style="display:flex;align-items:flex-start;gap:10px;">
        <div style="width:24px;height:24px;border-radius:50%;background:var(--accent);color:#000;font-size:12px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">4</div>
        <div style="font-size:13px;color:var(--text);line-height:1.6;">é€ å½¢å¾Œãƒ»ã“ã ã‚ã‚Šã¯ã€Œå ±å‘Šæ›¸ã«å«ã‚ã‚‹ã€ãƒˆã‚°ãƒ«ã§é¸æŠ</div>
      </div>
    </div>
  </div>
  <div class="prog-card">
    <div class="prog-top">
      <div class="prog-label">ãƒšã‚¢ãƒªãƒ³ã‚°é€²æ—</div>
      <div class="prog-nums">
        <div class="pn"><div class="pn-v" id="s3-paired">0</div><div class="pn-l">ãƒšã‚¢å®Œæˆ</div></div>
        <div class="pn"><div class="pn-v" style="color:var(--danger)" id="s3-unpaired">0</div><div class="pn-l">æœªå‰²å½“ã¦</div></div>
        <div class="pn"><div class="pn-v" style="color:var(--text2)" id="s3-total">0</div><div class="pn-l">åˆè¨ˆ</div></div>
      </div>
    </div>
    <div class="prog-bar-wrap"><div class="prog-bar" id="s3-prog-bar" style="width:0%"></div></div>
    <div class="prog-msg" id="s3-prog-msg"><span class="dim">Beforeã¨Afterã«ãƒšã‚¢ç•ªå·ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„</span></div>
  </div>
  <div class="frow">
    <button class="fbtn f-all on" onclick="s3SetF('all',this)">ã™ã¹ã¦</button>
    <button class="fbtn f-pair"   onclick="s3SetF('pair',this)">â‡” ãƒšã‚¢ç¢ºèª</button>
    <button class="fbtn f-b"      onclick="s3SetF('b',this)">ğŸ“· Before</button>
    <button class="fbtn f-a"      onclick="s3SetF('a',this)">âœ¨ After</button>
    <button class="fbtn f-none"   onclick="s3SetF('none',this)">âš ï¸ æœªå‰²å½“ã¦</button>
    <button class="fbtn f-solo"   onclick="s3SetF('solo',this)">â­ å˜ä½“å†™çœŸ</button>
  </div>
  <div id="s3-main-area"></div>
  <div class="footer-note" id="s3-footer-note" style="font-size:11px;color:var(--text2);text-align:center;"></div>
</div>
<div class="fixed-footer">
  <button class="primary-btn" id="s3-next-btn" onclick="goTo('s4')">å ±å‘Šæ›¸ã‚’ä½œæˆã™ã‚‹ â†’</button>
  <button class="secondary-btn" onclick="goTo('s2')">â† å†™çœŸã‚¢ãƒƒãƒ—ã«æˆ»ã‚‹</button>
</div>
<!-- ãƒšã‚¢ç•ªå·å‰²å½“ã‚·ãƒ¼ãƒˆ -->
<div class="sheet" id="s3-sheet">
  <div class="sheet-card">
    <div class="sheet-thumb"><img id="s3-sheet-img" src="" alt=""></div>
    <!-- ã‚¿ã‚°å¤‰æ›´ -->
    <div style="margin-bottom:12px;">
      <div style="font-size:11px;font-weight:700;color:var(--text2);margin-bottom:8px;">â–¼ ã‚¿ã‚°ã‚’å¤‰æ›´ã™ã‚‹</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;" id="s3-tag-change-btns"></div>
    </div>
    <div class="sheet-label">ç”»è§’ç•ªå·ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="sheet-grid" id="s3-sheet-grid"></div>
    <div class="sheet-actions">
      <button class="sh-cancel" onclick="s3CloseSheet()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="sh-apply"  onclick="s3ApplySheet()">æ±ºå®šã™ã‚‹</button>
    </div>
  </div>
</div>

<!-- æœªå‰²å½“ã¦å†™çœŸã‹ã‚‰é¸æŠã‚·ãƒ¼ãƒˆ -->
<div class="sheet" id="s3-pick-sheet">
  <div class="sheet-card">
    <div style="font-size:15px;font-weight:900;color:var(--text);margin-bottom:4px;" id="s3-pick-title">æœªå‰²å½“ã¦å†™çœŸã‹ã‚‰é¸ã¶</div>
    <div style="font-size:11px;color:var(--text2);margin-bottom:14px;" id="s3-pick-sub"></div>
    <div id="s3-pick-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-height:50vh;overflow-y:auto;"></div>
    <div style="margin-top:14px;">
      <button class="sh-cancel" style="width:100%;" onclick="s3ClosePickSheet()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>
</div><!-- screen-s3 -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 4: å ±å‘Šæ›¸å…¥åŠ›
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-s4">
<div class="s4-body">
  <!-- ã‚¬ã‚¤ãƒ‰ -->
  <div style="background:rgba(232,160,32,.08);border:1.5px solid rgba(232,160,32,.25);border-radius:14px;padding:16px;margin-bottom:14px;">
    <div style="font-size:14px;font-weight:900;color:var(--accent);margin-bottom:12px;">ğŸ“‹ å ±å‘Šæ›¸ã®ä½œã‚Šæ–¹</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">1</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">æ–½å·¥ç¨®åˆ¥ã‚’é¸ã¶ï¼ˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³ / ã‚¦ã‚©ãƒ¼ãƒ«ï¼‰</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">2</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">å„é …ç›®ã‚’å…¥åŠ›ãƒ»é¸æŠï¼ˆä¾‹æ–‡ãƒœã‚¿ãƒ³ã‚‚æ´»ç”¨ï¼‰</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--accent);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã™ã‚‹ã€ã§ä»•ä¸ŠãŒã‚Šç¢ºèª</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;background:#111;border-radius:10px;padding:11px 12px;">
        <div style="width:26px;height:26px;border-radius:50%;background:var(--ok);color:#000;font-size:13px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">4</div>
        <div style="font-size:13px;color:var(--text);font-weight:700;">ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼ â†’ ZIPä¿å­˜ â†’ <strong style="color:var(--ok);">å ±å‘Šã‚’ä¿å­˜</strong></div>
      </div>
    </div>
  </div>
  <!-- æ‹…å½“è€…å -->
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 14px;margin-bottom:14px;display:flex;align-items:center;gap:10px;">
    <div style="font-size:13px;">ğŸ‘¤</div>
    <div style="flex:1;">
      <div style="font-size:10px;color:var(--text2);margin-bottom:4px;">æ‹…å½“è€…å</div>
      <input class="finput" id="f-staff" placeholder="ã¬ãƒ¼ã¾ã‚“" style="padding:8px 10px;">
    </div>
  </div>
  <!-- æ–½å·¥ç¨®åˆ¥ -->
  <div class="field" style="border-radius:12px 12px 0 0;">
    <div class="field-label">æ–½å·¥ç¨®åˆ¥</div>
    <div style="display:flex;gap:10px;">
      <button class="yn-btn on" id="type-rs" style="flex:1;padding:12px 8px;font-size:13px;" onclick="setType('rs')">ğŸ— ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¹ãƒˆãƒ¼ãƒ³</button>
      <button class="yn-btn"    id="type-rw" style="flex:1;padding:12px 8px;font-size:13px;" onclick="setType('rw')">ğŸ§± ãƒ­ãƒ¼ãƒ©ãƒ¼ã‚¦ã‚©ãƒ¼ãƒ«</button>
    </div>
  </div>
  <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
  <div class="field">
    <div class="field-label">ã‚¿ã‚¤ãƒˆãƒ«</div>
    <div class="chips" id="chips-title">
      <button class="chip" onclick="chipToggle(this,'title',false)">ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥</button>
      <button class="chip" onclick="chipToggle(this,'title',false)">é§è»Šå ´æ–½å·¥</button>
      <button class="chip" onclick="chipToggle(this,'title',false)">ã‚¿ã‚¤ãƒ«ãƒ‡ãƒƒã‚­æ–½å·¥</button>
      <button class="chip" onclick="chipToggle(this,'title',false)">å¤–æ§‹æ–½å·¥</button>
    </div>
    <input class="finput" id="title-custom" placeholder="ãã®ä»–ï¼ˆè‡ªç”±è¨˜è¿°ï¼‰">
  </div>
  <!-- è¦æ¨¡ãƒ»æ—¥æ•° -->
  <div class="field">
    <div class="field-label">è¦æ¨¡</div>
    <div class="num-row">
      <div class="num-wrap" style="flex:3;"><input class="finput" id="f-size" type="number" placeholder="25" inputmode="numeric"><span class="num-unit">ã¡</span></div>
      <div style="flex:1.5;">
        <div class="field-label" style="margin-bottom:4px;">æ–½å·¥æ—¥æ•°</div>
        <div class="num-wrap"><input class="finput" id="f-days" type="number" placeholder="3" inputmode="numeric"><span class="num-unit">æ—¥</span></div>
      </div>
    </div>
  </div>
  <!-- ä¸‹åœ°å‡¦ç† -->
  <div class="field">
    <div class="field-label">ä¸‹åœ°å‡¦ç†</div>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <button class="yn-btn on" id="yn-yes" onclick="setYN('yes')">ã‚ã‚Š</button>
      <button class="yn-btn"    id="yn-no"  onclick="setYN('no')">ãªã—</button>
    </div>
    <input class="finput" id="f-base" placeholder="ã‚±ãƒ¬ãƒ³å‡¦ç†ã€ä¸‹åœ°èª¿æ•´ãªã©ï¼ˆä»»æ„ï¼‰">
  </div>
  <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³ -->
  <div class="field">
    <div class="field-label">ãƒ‘ã‚¿ãƒ¼ãƒ³ <span class="opt">è¤‡æ•°å¯</span></div>
    <div class="chips" id="chips-pattern">
      <button class="chip" onclick="chipToggle(this,'pattern',true)">ä¹±å½¢çŸ³èª¿</button>
      <button class="chip" onclick="chipToggle(this,'pattern',true)">ã‚¿ã‚¤ãƒ«èª¿</button>
      <button class="chip" onclick="chipToggle(this,'pattern',true)">ç‰¹æ®Šãƒ»ãƒ­ã‚´</button>
      <button class="chip" onclick="chipToggle(this,'pattern',true)">ãã®ä»–</button>
    </div>
    <input class="finput" id="pattern-custom" placeholder="è‡ªç”±è¨˜è¿°">
  </div>
  <!-- ã‚«ãƒ©ãƒ¼ãƒ¡ã‚¤ãƒ³ -->
  <div class="field">
    <div class="field-label">ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ <span class="opt">è¤‡æ•°å¯</span></div>
    <div class="chips" id="chips-color-main">
      <button class="color-chip" onclick="chipToggle(this,'color-main',true)"><span class="cdot" style="background:#999"></span>ã‚°ãƒ¬ãƒ¼</button>
      <button class="color-chip" onclick="chipToggle(this,'color-main',true)"><span class="cdot" style="background:#222;border:1px solid #555"></span>ãƒ–ãƒ©ãƒƒã‚¯</button>
      <button class="color-chip" onclick="chipToggle(this,'color-main',true)"><span class="cdot" style="background:#e8d5a0"></span>ã‚¤ã‚¨ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¸ãƒ¥</button>
      <button class="color-chip" onclick="chipToggle(this,'color-main',true)"><span class="cdot" style="background:#c9a882"></span>ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼</button>
      <button class="color-chip" onclick="chipToggle(this,'color-main',true)"><span class="cdot" style="background:#e87030"></span>ã‚ªãƒ¬ãƒ³ã‚¸</button>
      <button class="color-chip" onclick="chipToggle(this,'color-main',true)"><span class="cdot" style="background:#5a7a50"></span>ãƒ¢ã‚¹ã‚°ãƒªãƒ¼ãƒ³</button>
    </div>
    <input class="finput" id="color-main-custom" placeholder="ãã®ä»–ã®ã‚«ãƒ©ãƒ¼ï¼ˆä»»æ„ï¼‰">
  </div>
  <!-- ã‚«ãƒ©ãƒ¼ã‚µãƒ– -->
  <div class="field">
    <div class="field-label">ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ï¼ˆã‚µãƒ–ï¼‰ <span class="opt">ä»»æ„ãƒ»è¤‡æ•°å¯</span></div>
    <div class="chips" id="chips-color-sub">
      <button class="color-chip" onclick="chipToggle(this,'color-sub',true)"><span class="cdot" style="background:#999"></span>ã‚°ãƒ¬ãƒ¼</button>
      <button class="color-chip" onclick="chipToggle(this,'color-sub',true)"><span class="cdot" style="background:#222;border:1px solid #555"></span>ãƒ–ãƒ©ãƒƒã‚¯</button>
      <button class="color-chip" onclick="chipToggle(this,'color-sub',true)"><span class="cdot" style="background:#e8d5a0"></span>ã‚¤ã‚¨ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¸ãƒ¥</button>
      <button class="color-chip" onclick="chipToggle(this,'color-sub',true)"><span class="cdot" style="background:#c9a882"></span>ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼</button>
      <button class="color-chip" onclick="chipToggle(this,'color-sub',true)"><span class="cdot" style="background:#e87030"></span>ã‚ªãƒ¬ãƒ³ã‚¸</button>
      <button class="color-chip" onclick="chipToggle(this,'color-sub',true)"><span class="cdot" style="background:#5a7a50"></span>ãƒ¢ã‚¹ã‚°ãƒªãƒ¼ãƒ³</button>
    </div>
    <input class="finput" id="color-sub-custom" placeholder="ãã®ä»–ã®ã‚µãƒ–ã‚«ãƒ©ãƒ¼ï¼ˆä»»æ„ï¼‰">
  </div>
  <!-- ç›®åœ°ã‚«ãƒ©ãƒ¼ -->
  <div class="field">
    <div class="field-label">ç›®åœ°ã‚«ãƒ©ãƒ¼</div>
    <input class="finput" id="f-grout" placeholder="ãƒ›ãƒ¯ã‚¤ãƒˆã€ã‚°ãƒ¬ãƒ¼ã€ãƒ–ãƒ©ãƒƒã‚¯ãªã©">
  </div>
  <!-- ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ -->
  <div class="field">
    <div class="field-label">ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ</div>
    <textarea class="finput auto-grow" id="f-point" oninput="autoGrow(this)" rows="3" placeholder="æ–½å·¥ã®ã“ã ã‚ã‚Šã‚„ç‰¹å¾´ã‚’å…¥åŠ›â€¦"></textarea>
    <button class="ex-btn" onclick="fillEx('f-point','ç›®åœ°å¹…ã‚’3mmã«çµ±ä¸€ã—ã€ä¸Šè³ªãªä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã€‚çŸ³ã®å‘ãã‚’æƒãˆã¦æ•´ç„¶ã¨ã—ãŸå°è±¡ã«ã€‚')">ä¾‹æ–‡ã‚’ä½¿ã†</button>
  </div>
  <!-- ãŠå®¢æ§˜ã®å£° -->
  <div class="field">
    <div class="field-label">ãŠå®¢æ§˜ã®å£°</div>
    <textarea class="finput auto-grow" id="f-voice" oninput="autoGrow(this)" rows="2" placeholder="ã€Œæƒ³åƒä»¥ä¸Šã®ä»•ä¸ŠãŒã‚Šã§å¤§æº€è¶³ã§ã™ï¼ã€ãªã©"></textarea>
    <button class="ex-btn" onclick="fillEx('f-voice','ã€Œæƒ³åƒä»¥ä¸Šã®ä»•ä¸ŠãŒã‚Šã§å¤§æº€è¶³ã§ã™ï¼è¿‘æ‰€ã®æ–¹ã«ã‚‚è¤’ã‚ã‚‰ã‚Œã¾ã—ãŸã€')">ä¾‹æ–‡ã‚’ä½¿ã†</button>
  </div>
  <!-- ãŠå®¢æ§˜ã®ãŠæ‚©ã¿ -->
  <div class="field">
    <div class="field-label">ãŠå®¢æ§˜ã®ãŠæ‚©ã¿ <span class="opt">ä»»æ„</span></div>
    <textarea class="finput auto-grow" id="f-problem" oninput="autoGrow(this)" rows="2" placeholder="ã€Œã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãŒå‘³æ°—ãªãã¦ãŠã—ã‚ƒã‚Œã«ã—ãŸã‹ã£ãŸã€ãªã©"></textarea>
    <button class="ex-btn" onclick="fillEx('f-problem','ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãŒå‘³æ°—ãªãã¦ãŠã—ã‚ƒã‚Œã«ã—ãŸã‹ã£ãŸ')">ä¾‹æ–‡ã‚’ä½¿ã†</button>
  </div>
  <!-- è‡ªç”±è¨˜è¿° -->
  <div class="field" style="border-radius:0 0 12px 12px;">
    <div class="field-label">ãã®ä»–ãƒ»è‡ªç”±è¨˜è¿° <span class="opt">ä»»æ„</span></div>
    <textarea class="finput auto-grow" id="f-free" oninput="autoGrow(this)" rows="2" placeholder="è‡ªç”±è¨˜å…¥"></textarea>
  </div>
  <!-- å†™çœŸã‚µãƒãƒªãƒ¼ï¼ˆSTEP2ã‹ã‚‰å¼•ç¶™ãï¼‰ -->
  <div class="photo-summary-card" id="photo-summary">ğŸ“¸ å†™çœŸãªã—ï¼ˆSTEP2ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰</div>
</div>
<div class="fixed-footer">
  <button class="primary-btn" onclick="goPreview()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã™ã‚‹ â†’</button>
</div>
</div><!-- screen-s4 -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREEN 5: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»é€ä»˜
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-preview">
<div class="preview-body">

  <div class="send-section-title">é€ä»˜ãƒ†ã‚­ã‚¹ãƒˆ</div>
  <div class="send-text-box" id="send-text-box"></div>
  <div style="background:var(--surface);border:1.5px solid rgba(232,160,32,.25);border-radius:14px;padding:16px;">
    <div style="font-size:15px;font-weight:900;color:var(--accent);margin-bottom:14px;display:flex;align-items:center;gap:8px;">ğŸ“¤ é€ä»˜ã®æ‰‹é †</div>
    <div style="display:flex;flex-direction:column;gap:12px;">
      <div style="display:flex;align-items:center;gap:12px;background:#111;border-radius:10px;padding:12px;">
        <div style="width:28px;height:28px;border-radius:50%;background:var(--accent);color:#000;font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">1</div>
        <div style="font-size:14px;color:var(--text);font-weight:700;">ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ â†’ LINEã«è²¼ã‚Šä»˜ã‘</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;background:#111;border-radius:10px;padding:12px;">
        <div style="width:28px;height:28px;border-radius:50%;background:var(--accent);color:#000;font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">2</div>
        <div style="font-size:14px;color:var(--text);font-weight:700;">ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ LINEã«æ·»ä»˜</div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;background:rgba(34,197,94,.06);border:1px solid rgba(34,197,94,.2);border-radius:10px;padding:12px;">
        <div style="width:28px;height:28px;border-radius:50%;background:var(--ok);color:#000;font-size:14px;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
        <div style="font-size:14px;color:var(--ok);font-weight:700;">ã€Œã“ã®å ±å‘Šã‚’ä¿å­˜ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ä¿å­˜ï¼</div>
      </div>
    </div>
  </div>
  <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
  <div class="fb-card">
    <div style="font-size:13px;font-weight:900;color:var(--text);margin-bottom:4px;">ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ğŸ‰</div>
    <div style="font-size:12px;color:var(--text2);line-height:1.8;margin-bottom:12px;">ä½¿ã„å¿ƒåœ°ã¯ã„ã‹ãŒã§ã—ãŸã‹ï¼Ÿ<br>ã‚ˆã‹ã£ãŸã‚‰ç°¡å˜ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚</div>
    <textarea class="finput" id="fb-text" rows="3" placeholder="ä¾‹ï¼‰å…¥åŠ›ãŒã‚¹ãƒ ãƒ¼ã‚ºã ã£ãŸãƒ»ã“ã“ãŒä½¿ã„ã«ãã‹ã£ãŸ ãªã©"></textarea>
    <div style="display:flex;gap:8px;margin-top:10px;" id="fb-actions">
      <button onclick="sendFeedback()" style="flex:1;padding:12px;background:var(--accent);color:#000;border:none;border-radius:10px;font-size:13px;font-weight:900;font-family:inherit;cursor:pointer;">ğŸ“¨ é€ä¿¡ã™ã‚‹</button>
      <button onclick="skipFeedback()" style="flex:1;padding:12px;background:transparent;color:var(--text2);border:1.5px solid var(--border);border-radius:10px;font-size:13px;font-weight:700;font-family:inherit;cursor:pointer;">ã‚¹ã‚­ãƒƒãƒ—</button>
    </div>
    <div id="fb-sent" style="display:none;text-align:center;padding:10px;font-size:12px;color:var(--ok);font-weight:700;">âœ… ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’å—ã‘å–ã‚Šã¾ã—ãŸï¼ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</div>
  </div>
</div>
<div class="fixed-footer">
  <button class="primary-btn btn-copy" id="btn-copy" onclick="copyText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
  <button class="primary-btn" style="background:#222;color:var(--text);border:1.5px solid var(--border);" onclick="downloadZip()">ğŸ“¦ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  <button class="primary-btn" id="save-btn" style="background:var(--ok);color:#000;font-size:17px;" onclick="saveReport()">ğŸ’¾ ã“ã®å ±å‘Šã‚’ä¿å­˜ã™ã‚‹</button>
  <div class="action-row">
    <button class="secondary-btn" style="flex:1;" onclick="goTo('s4')">â† ä¿®æ­£ã™ã‚‹</button>
    <button class="danger-btn" onclick="confirmDelete()">ğŸ—‘ å‰Šé™¤</button>
  </div>
</div>
</div><!-- screen-preview -->

<div class="toast" id="toast-el"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JavaScript
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const APP = {
  pref: '', company: '', staff: '',
  curScreen: 'home',
};

// â”€â”€ å†™çœŸãƒ‡ãƒ¼ã‚¿ï¼ˆS2/S3å…±æœ‰ï¼‰ â”€â”€
const TM2 = {
  b:{uz:'uz-b',pill:'pill-b',label:'ğŸ“· Before ã¨ã—ã¦è¿½åŠ ',badge:'tb-b',name:'Before',dot:'var(--before)'},
  d:{uz:'uz-d',pill:'pill-d',label:'ğŸ”¨ é€ å½¢å¾Œ ã¨ã—ã¦è¿½åŠ ', badge:'tb-d',name:'é€ å½¢å¾Œ',dot:'var(--during)'},
  a:{uz:'uz-a',pill:'pill-a',label:'âœ¨ After ã¨ã—ã¦è¿½åŠ ',  badge:'tb-a',name:'After', dot:'var(--after)'},
  p:{uz:'uz-p',pill:'pill-p',label:'â­ ã“ã ã‚ã‚Š ã¨ã—ã¦è¿½åŠ ',badge:'tb-p',name:'ã“ã ã‚ã‚Š',dot:'var(--pickup)'},
  o:{uz:'uz-o',pill:'pill-o',label:'ğŸ“Œ ãã®ä»– ã¨ã—ã¦è¿½åŠ ', badge:'tb-o',name:'ãã®ä»–',dot:'var(--other)'},
};
let s2Photos = {b:[],d:[],a:[],p:[],o:[]};
let s2Pid = 0, s2CurTag = 'b', s2CurOrient = 'all';

// S3ç”¨å†™çœŸãƒªã‚¹ãƒˆï¼ˆS2ã‹ã‚‰å¤‰æ›ï¼‰
let s3Photos = [], s3CurF = 'all', s3MaxPair = 0;
let s3SheetId = null, s3SheetNewPair = null;
const NC = ['â‘ ','â‘¡','â‘¢','â‘£','â‘¤','â‘¥','â‘¦','â‘§','â‘¨'];
const fn = n => NC[n-1] || n+'';
const TM3 = {
  b:{name:'Before',dot:'var(--before)',badge:'sl-b'},
  d:{name:'é€ å½¢å¾Œ', dot:'var(--during)',badge:'st-d'},
  a:{name:'After', dot:'var(--after)', badge:'sl-a'},
  p:{name:'ã“ã ã‚ã‚Š',dot:'var(--pickup)',badge:'st-p'},
  o:{name:'ãã®ä»–', dot:'var(--other)', badge:'st-o'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ç”»é¢é·ç§»
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTo(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const screenId = {
    home: 'screen-home',
    register: 'screen-register',
    s2: 'screen-s2', s3: 'screen-s3', s4: 'screen-s4',
    preview: 'screen-preview'
  }[name] || 'screen-home';
  document.getElementById(screenId).classList.add('active');
  const isHome = name === 'home' || name === 'register';
  document.getElementById('step-bar-wrap').style.display = isHome ? 'none' : 'block';
  updateStepBar(name);
  document.getElementById('header-step').textContent =
    isHome ? '' : name === 's2' ? 'STEP 2' : name === 's3' ? 'STEP 3' : name === 's4' ? 'STEP 4' : 'é€ä»˜';
  window.scrollTo(0, 0);
  if (name === 'home') { renderHomeReports(); }
  if (name === 's3') { s3SyncFromS2(); s3UpdateStats(); s3Render(); }
  if (name === 's4') { updatePhotoSummary(); syncStaffToS4(); setTimeout(restoreDraft, 100); }
  APP.curScreen = name;
}

function updateStepBar(name) {
  const steps = ['2','3','4','5'];
  const nameMap = {s2:'2', s3:'3', s4:'4', preview:'5'};
  const cur = nameMap[name] || '0';
  const curIdx = steps.indexOf(cur);
  steps.forEach((s, i) => {
    const dot = document.getElementById('sd-' + s);
    const lbl = document.getElementById('sl-' + s);
    if (!dot) return;
    dot.className = 'sbar-dot' + (i < curIdx ? ' done' : i === curIdx ? ' active' : '');
    lbl.className = 'sbar-label' + (i === curIdx ? ' active' : '');
  });
  ['1','2','3'].forEach((n, i) => {
    const line = document.getElementById('sl-line-' + n);
    if (line) line.className = 'sbar-line' + (i < curIdx - 1 ? ' done' : '');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ›ãƒ¼ãƒ ç”»é¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRegister() {
  // ç¾åœ¨ã®å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ ã—ã¦ã‹ã‚‰registerç”»é¢ã¸
  const p = document.getElementById('home-pref');
  if (p && APP.pref) p.value = APP.pref;
  const c = document.getElementById('home-company');
  if (c && APP.company) c.value = APP.company;
  const s = document.getElementById('home-staff');
  if (s && APP.staff) s.value = APP.staff;
  goTo('register');
}

function startApp() {
  const pref    = document.getElementById('home-pref').value;
  const company = document.getElementById('home-company').value.trim();
  const staff   = document.getElementById('home-staff').value.trim();
  if (!pref)    { toast('éƒ½é“åºœçœŒã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if (!company) { toast('ä¼šç¤¾åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!staff)   { toast('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  APP.pref = pref; APP.company = company; APP.staff = staff;
  // localStorage ã«ä¿å­˜
  try {
    localStorage.setItem('rs_pref', pref);
    localStorage.setItem('rs_company', company);
    localStorage.setItem('rs_staff', staff);
  } catch(e) {}
  updateHomeInfo();
  goTo('home');
}

function updateHomeInfo() {
  const el = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
  el('home-info-pref', APP.pref + 'ã€€èªå®šæ–½å·¥åº—');
  el('home-info-company', APP.company);
  el('home-info-staff', 'æ‹…å½“ï¼š' + APP.staff);
}

// ç¾å ´åå…¥åŠ›ã‚·ãƒ¼ãƒˆ
function showNewSiteSheet() {
  document.getElementById('ns-client').value = '';
  document.getElementById('ns-place').value = '';
  document.getElementById('new-site-sheet').classList.add('show');
}
function closeNewSiteSheet() {
  document.getElementById('new-site-sheet').classList.remove('show');
}
function startNewSite() {
  const client = document.getElementById('ns-client').value.trim();
  const place  = document.getElementById('ns-place').value.trim();
  if (!client) { toast('ãŠå®¢æ§˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  APP.siteName = client + (place ? ' ' + place : '');
  closeNewSiteSheet();
  // å†™çœŸãƒ»çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
  s2Photos = {b:[],d:[],a:[],p:[],o:[]};
  s2Pid = 0; s2CurTag = 'b'; s2CurOrient = 'all';
  s3Photos = []; s3MaxPair = 0;
  document.getElementById('s2-uploaded').style.display = 'none';
  document.getElementById('s2-next-btn').disabled = true;
  goTo('s2');
}

// å ±å‘Šä¸€è¦§ã‚’æç”»
function renderHomeReports() {
  let reports = [];
  try {
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (k && k.startsWith('rs_report_')) {
        const d = JSON.parse(localStorage.getItem(k));
        if (d) reports.push({key: k, ...d});
      }
    }
  } catch(e) {}
  reports.sort((a,b) => new Date(b.savedAt) - new Date(a.savedAt));

  const count = document.getElementById('home-report-count');
  const list  = document.getElementById('home-report-list');
  if (!count || !list) return;
  count.textContent = reports.length + 'ä»¶';

  if (!reports.length) {
    list.innerHTML = `<div class="empty-home"><div class="ei">ğŸ“‹</div>ã¾ã å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“<br><span style="font-size:11px;">ã€Œæ–°ã—ã„ç¾å ´ã®å ±å‘Šã‚’ä½œæˆã€ã‹ã‚‰å§‹ã‚ã¦ãã ã•ã„</span></div>`;
    return;
  }
  list.innerHTML = reports.map(r => {
    const d = new Date(r.savedAt);
    const ds = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    const title = r.siteName || r.title || 'ç„¡é¡Œã®ç¾å ´';
    return `<div class="report-card" onclick="viewReport('${r.key}')">
      <div class="report-card-icon">ğŸ“‹</div>
      <div class="report-card-body">
        <div class="report-card-title">${title}</div>
        <div class="report-card-meta">${r.staff || APP.staff} ãƒ» ${ds}</div>
      </div>
      <button class="report-card-del" onclick="event.stopPropagation();deleteReportByKey('${r.key}')">ğŸ—‘</button>
    </div>`;
  }).join('');
}

// å ±å‘Šãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤º
let currentViewKey = null;
function viewReport(key) {
  try {
    const d = JSON.parse(localStorage.getItem(key));
    if (!d) return;
    currentViewKey = key;
    document.getElementById('rv-title').textContent = d.siteName || d.title || 'ç„¡é¡Œã®ç¾å ´';
    document.getElementById('rv-text').textContent = d.text || '';
    document.getElementById('report-view-sheet').classList.add('show');
  } catch(e) {}
}
function closeReportView() {
  document.getElementById('report-view-sheet').classList.remove('show');
  currentViewKey = null;
}
function copyReportText() {
  const txt = document.getElementById('rv-text').textContent;
  navigator.clipboard?.writeText(txt).then(() => toast('ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = txt; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    toast('ğŸ“‹ ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
  });
}
function deleteReport() {
  if (!currentViewKey) return;
  if (!confirm('ã“ã®å ±å‘Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  deleteReportByKey(currentViewKey);
  closeReportView();
}
function deleteReportByKey(key) {
  localStorage.removeItem(key);
  renderHomeReports();
  toast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

// showGuide â†’ å¤–éƒ¨URLãƒªãƒ³ã‚¯ã«ç§»è¡Œï¼ˆãƒœã‚¿ãƒ³å´ã§hrefå‡¦ç†ï¼‰

// ãƒšãƒ¼ã‚¸èª­è¾¼æ™‚ã«ä¿å­˜å€¤ã‚’å¾©å…ƒ
window.addEventListener('load', () => {
  try {
    const p = localStorage.getItem('rs_pref');
    const c = localStorage.getItem('rs_company');
    const s = localStorage.getItem('rs_staff');
    if (p && c && s) {
      // ç™»éŒ²æ¸ˆã¿ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã¸
      APP.pref = p; APP.company = c; APP.staff = s;
      document.getElementById('home-pref').value = p;
      document.getElementById('home-company').value = c;
      document.getElementById('home-staff').value = s;
      updateHomeInfo();
      goTo('home');
    }
    // æœªç™»éŒ²ã¯registerç”»é¢ã®ã¾ã¾ï¼ˆåˆæœŸactiveï¼‰
  } catch(e) {}
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP2: å†™çœŸã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function s2SelectTag(t, btn) {
  s2CurTag = t;
  document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const m = TM2[t];
  const uz = document.getElementById('s2-uz');
  uz.className = 'upload-zone ' + m.uz;
  const pill = document.getElementById('uz-pill');
  pill.className = 'uz-tag-pill ' + m.pill;
  pill.textContent = m.label;
}

// â”€â”€ ç”»åƒå‡¦ç†ã‚­ãƒ¥ãƒ¼ï¼ˆ1æšãšã¤å‡¦ç†ã—ã¦UIã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰â”€â”€
let s2Queue = [];
let s2Processing = false;

function s2HandleFiles(files) {
  if (!files || !files.length) return;
  const tag = s2CurTag;
  const fileArr = Array.from(files);
  // å‡¦ç†ä»¶æ•°ã‚’ãƒˆãƒ¼ã‚¹ãƒˆã§å…ˆè¡Œè¡¨ç¤º
  toast(`${TM2[tag].name} ã‚’ ${fileArr.length}æš å‡¦ç†ä¸­â€¦`);
  // ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
  fileArr.forEach(file => s2Queue.push({file, tag}));
  document.getElementById('s2-file-input').value = '';
  if (!s2Processing) s2ProcessQueue();
}

function s2ProcessQueue() {
  if (!s2Queue.length) {
    s2Processing = false;
    toast('âœ… ã™ã¹ã¦è¿½åŠ ã—ã¾ã—ãŸ');
    return;
  }
  s2Processing = true;
  const {file, tag} = s2Queue.shift();

  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.onload = () => {
      // â”€â”€ Canvasã§ãƒªã‚µã‚¤ã‚ºï¼ˆé•·è¾º1200pxä»¥å†…ï¼‰â”€â”€
      const MAX = 1200;
      let w = img.naturalWidth, h = img.naturalHeight;
      const orient = h > w ? 'port' : 'land';
      if (w > MAX || h > MAX) {
        const ratio = Math.min(MAX / w, MAX / h);
        w = Math.round(w * ratio);
        h = Math.round(h * ratio);
      }
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);
      // æœ¬ä½“ç”¨ï¼ˆå ±å‘Šæ›¸æ·»ä»˜ç”¨ï¼‰: quality 0.82
      const src = canvas.toDataURL('image/jpeg', 0.82);
      // ã‚µãƒ ãƒã‚¤ãƒ«ç”¨ï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰: 200pxä»¥å†…
      const TW = 200;
      const tr = Math.min(TW / w, TW / h);
      const tw = Math.round(w * tr), th = Math.round(h * tr);
      const tc = document.createElement('canvas');
      tc.width = tw; tc.height = th;
      tc.getContext('2d').drawImage(canvas, 0, 0, tw, th);
      const thumb = tc.toDataURL('image/jpeg', 0.7);

      s2Photos[tag].push({
        id: s2Pid++,
        src,       // æ·»ä»˜ç”¨ï¼ˆãƒªã‚µã‚¤ã‚ºæ¸ˆã¿ï¼‰
        thumb,     // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºç”¨ï¼ˆå°ã•ã„ï¼‰
        tag,
        orient,
        pairNum: null,
        include: true
      });
      s2UpdateAll();
      // å°‘ã—é–“ã‚’ç©ºã‘ã¦æ¬¡ã‚’å‡¦ç†ï¼ˆUIã«æ¯ç¶™ãã•ã›ã‚‹ï¼‰
      setTimeout(s2ProcessQueue, 30);
    };
    img.onerror = () => { toast('èª­ã¿è¾¼ã¿å¤±æ•—ï¼š' + file.name); setTimeout(s2ProcessQueue, 30); };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function s2SetOrient(o, btn) {
  s2CurOrient = o;
  document.querySelectorAll('.of-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  s2RenderThumbs();
}

function s2DelPhoto(id, tag) {
  s2Photos[tag] = s2Photos[tag].filter(p => p.id !== id);
  s2UpdateAll();
  toast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

function s2UpdateAll() {
  const total = Object.values(s2Photos).reduce((s, a) => s + a.length, 0);
  Object.keys(s2Photos).forEach(t => {
    document.getElementById('cn-' + t).textContent = s2Photos[t].length;
  });
  document.getElementById('s2-next-btn').disabled = (total === 0);
  const sec = document.getElementById('s2-uploaded');
  if (total === 0) { sec.style.display = 'none'; return; }
  sec.style.display = 'flex';
  s2RenderThumbs();
}

function s2RenderThumbs() {
  const area = document.getElementById('s2-thumb-area');
  const order = ['b','d','a','p','o'];
  let html = '';
  order.forEach(t => {
    let L = s2Photos[t];
    if (s2CurOrient !== 'all') L = L.filter(p => p.orient === s2CurOrient);
    if (!L.length) return;
    const m = TM2[t];
    const cntLabel = s2CurOrient === 'all' ? `${s2Photos[t].length}æš` : `${L.length}/${s2Photos[t].length}æš`;
    html += `<div style="margin-bottom:10px;">
      <div class="tag-row">
        <div class="tag-dot" style="background:${m.dot}"></div>
        <div class="tag-name">${m.name}</div>
        <div class="tag-cnt">${cntLabel}</div>
      </div>
      <div class="thumb-scroll">`;
    L.forEach(p => {
      const oLbl = p.orient === 'port' ? 'â–¯ç¸¦' : 'â–­æ¨ª';
      html += `<div class="thumb-item">
        <img src="${p.thumb || p.src}" alt="" loading="lazy">
        <div class="thumb-tag ${m.badge}">${m.name}</div>
        <div class="orient-badge">${oLbl}</div>
        <button class="thumb-del" onclick="event.stopPropagation();s2DelPhoto(${p.id},'${t}')">âœ•</button>
      </div>`;
    });
    html += `</div></div>`;
  });
  if (!html) {
    const lbl = s2CurOrient === 'port' ? 'â–¯ç¸¦' : 'â–­æ¨ª';
    html = `<div style="text-align:center;padding:16px;font-size:12px;color:var(--text2);">${lbl}å‘ãã®å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“</div>`;
  }
  area.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP3: å†™çœŸæ•´ç†ãƒ»ãƒšã‚¢ãƒªãƒ³ã‚°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// S2ã®ãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã«å¤‰æ›ã—ã¦S3ã«æ¸¡ã™
function s3SyncFromS2() {
  const all = [];
  ['b','d','a','p','o'].forEach(t => {
    s2Photos[t].forEach(p => all.push({...p}));
  });
  // æ—¢å­˜ã®S3ãƒ‡ãƒ¼ã‚¿ã‚’ç¶­æŒã—ã¤ã¤ã€æ–°è¦è¿½åŠ åˆ†ã‚’ãƒãƒ¼ã‚¸
  const existingIds = new Set(s3Photos.map(p => p.id));
  all.forEach(p => {
    if (!existingIds.has(p.id)) s3Photos.push({...p, pairNum: null, include: true});
  });
  // S2ã§å‰Šé™¤ã•ã‚ŒãŸå†™çœŸã‚’S3ã‹ã‚‰ã‚‚å‰Šé™¤
  const s2AllIds = new Set(all.map(p => p.id));
  s3Photos = s3Photos.filter(p => s2AllIds.has(p.id));
  s3MaxPair = Math.max(...s3Photos.filter(p => p.pairNum).map(p => p.pairNum), 0);
}

function s3UpdateStats() {
  const bs = s3Photos.filter(p => p.tag === 'b');
  const as = s3Photos.filter(p => p.tag === 'a');
  const pnums = [...new Set([...bs,...as].filter(p => p.pairNum).map(p => p.pairNum))];
  const paired = pnums.filter(n => bs.find(p => p.pairNum === n) && as.find(p => p.pairNum === n)).length;
  const unpaired = s3Photos.filter(p => (p.tag === 'b' || p.tag === 'a') && !p.pairNum).length;
  const total = s3Photos.length;
  document.getElementById('s3-paired').textContent = paired;
  document.getElementById('s3-unpaired').textContent = unpaired;
  document.getElementById('s3-total').textContent = total;
  const baTotal = bs.length + as.length;
  const pct = baTotal > 0 ? Math.round(paired * 2 / baTotal * 100) : 0;
  document.getElementById('s3-prog-bar').style.width = pct + '%';
  const incl = s3Photos.filter(p => p.include).length;
  if (unpaired === 0 && baTotal > 0) {
    document.getElementById('s3-prog-msg').innerHTML = `<span class="ok">âœ… ãƒšã‚¢ãƒªãƒ³ã‚°å®Œäº†</span>`;
  } else if (unpaired > 0) {
    document.getElementById('s3-prog-msg').innerHTML = `<span class="warn">âš ï¸ ${unpaired}æšãŒæœªå‰²å½“ã¦</span>`;
  } else {
    document.getElementById('s3-prog-msg').innerHTML = `<span class="dim">Beforeã¨Afterã«ãƒšã‚¢ç•ªå·ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„</span>`;
  }
  document.getElementById('s3-footer-note').textContent = `å ±å‘Šæ›¸ã«å«ã‚ã‚‹å†™çœŸï¼š${incl}æš`;
}

function s3SetF(f, btn) {
  s3CurF = f;
  document.querySelectorAll('.fbtn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  s3Render();
}

function s3Render() {
  const el = document.getElementById('s3-main-area');
  if (s3CurF === 'pair') { s3RenderPair(el); return; }
  let list = s3Photos;
  if (s3CurF === 'b')    list = s3Photos.filter(p => p.tag === 'b');
  else if (s3CurF === 'a')    list = s3Photos.filter(p => p.tag === 'a');
  else if (s3CurF === 'none') list = s3Photos.filter(p => (p.tag === 'b' || p.tag === 'a') && !p.pairNum);
  else if (s3CurF === 'solo') list = s3Photos.filter(p => p.tag !== 'b' && p.tag !== 'a');
  if (s3CurF === 'all') { s3RenderAll(el); return; }
  if (!list.length) {
    const msg = s3CurF === 'none' ? 'âœ… æœªå‰²å½“ã¦ã®å†™çœŸã¯ã‚ã‚Šã¾ã›ã‚“' : 'å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“';
    el.innerHTML = `<div class="empty-sec"><div class="ei">${s3CurF === 'none' ? 'âœ…' : 'ğŸ“·'}</div>${msg}</div>`;
    return;
  }
  let h = '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:6px;">';
  list.forEach(p => {
    const isPairable = p.tag === 'b' || p.tag === 'a';
    const pnLabel = p.pairNum ? fn(p.pairNum) : 'â”€';
    const pnClass = p.pairNum ? '' : 'unset';
    const badge = TM3[p.tag].badge;
    h += `<div class="solo-item">
      <img src="${p.src}" alt="">
      <div class="solo-tag ${badge}">${TM3[p.tag].name}</div>
      ${isPairable ? `<button class="assign-btn ${pnClass}" onclick="event.stopPropagation();s3OpenSheet(${p.id})">${pnLabel}</button>` : ''}
      ${!isPairable ? s3IncludeToggleHTML(p) : ''}
      <button class="del-btn" onclick="event.stopPropagation();s3DelPhoto(${p.id})">âœ•</button>
    </div>`;
  });
  h += '</div>';
  el.innerHTML = h;
}

function s3RenderAll(el) {
  const bs = s3Photos.filter(p => p.tag === 'b');
  const as = s3Photos.filter(p => p.tag === 'a');
  const pnums = [...new Set([...bs,...as].filter(p => p.pairNum).map(p => p.pairNum))].sort((a,b) => a-b);
  const unB = bs.filter(p => !p.pairNum);
  const unA = as.filter(p => !p.pairNum);
  const solos = s3Photos.filter(p => p.tag !== 'b' && p.tag !== 'a');
  if (!s3Photos.length) {
    el.innerHTML = `<div class="empty-sec"><div class="ei">ğŸ“·</div>STEP2ã§å†™çœŸã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>`;
    return;
  }
  let h = '<div style="display:flex;flex-direction:column;gap:14px;">';
  if (pnums.length) {
    h += '<div style="display:flex;flex-direction:column;gap:10px;">';
    pnums.forEach(n => {
      const b = bs.find(p => p.pairNum === n);
      const a = as.find(p => p.pairNum === n);
      const ok = b && a;
      h += `<div class="pair-card ${ok ? 'ok' : 'warn'}">
        <div class="pair-header">
          <div class="pair-num">PAIR ${fn(n)}</div>
          <div class="pair-badge ${ok ? 'pb-ok' : 'pb-warn'}">${ok ? 'âœ… å®Œæˆ' : 'âš ï¸ ç‰‡æ–¹ãªã—'}</div>
        </div>
        <div class="pair-images">`;
      if (b) h += `<div class="pair-slot"><img src="${b.thumb||b.src}" class="${b.orient==='port'?'port-img':'land-img'}"><div class="orient-pill">${b.orient==='port'?'â–¯ç¸¦':'â–­æ¨ª'}</div><div class="slot-lbl sl-b">Before</div><button class="assign-btn" onclick="s3OpenSheet(${b.id})">${fn(n)}</button><button class="del-btn" title="ãƒšã‚¢ã‹ã‚‰å¤–ã™" onclick="s3UnpairPhoto(${b.id})">â†©</button></div>`;
      else   h += `<div class="pair-slot-empty" style="cursor:pointer;" onclick="s3PickSlotForPair(${n},'b')"><div style="font-size:28px">â•</div><span style="font-size:10px;color:var(--accent);font-weight:700;">Before ã‚’é¸ã¶</span></div>`;
      if (a) h += `<div class="pair-slot"><img src="${a.thumb||a.src}" class="${a.orient==='port'?'port-img':'land-img'}"><div class="orient-pill">${a.orient==='port'?'â–¯ç¸¦':'â–­æ¨ª'}</div><div class="slot-lbl sl-a">After</div><button class="assign-btn" onclick="s3OpenSheet(${a.id})">${fn(n)}</button><button class="del-btn" title="ãƒšã‚¢ã‹ã‚‰å¤–ã™" onclick="s3UnpairPhoto(${a.id})">â†©</button></div>`;
      else   h += `<div class="pair-slot-empty" style="cursor:pointer;" onclick="s3PickSlotForPair(${n},'a')"><div style="font-size:28px">â•</div><span style="font-size:10px;color:var(--accent);font-weight:700;">After ã‚’é¸ã¶</span></div>`;
      h += `</div></div>`;
    });
    h += '</div>';
  }
  if (unB.length || unA.length) {
    h += `<div class="nopair-section">
      <div class="nopair-header">âš ï¸ æœªå‰²å½“ã¦ï¼ˆ${unB.length + unA.length}æšï¼‰</div>
      <div class="nopair-grid">`;
    [...unB,...unA].forEach(p => {
      h += `<div class="nopair-item">
        <img src="${p.thumb||p.src}" alt="" class="${p.orient==='port'?'port-img':'land-img'}" style="width:100%;display:block;object-fit:cover;border-radius:8px;" loading="lazy">
        <div class="orient-pill">${p.orient==='port'?'â–¯ç¸¦':'â–­æ¨ª'}</div>
        <div class="solo-tag ${TM3[p.tag].badge}" style="border-radius:0 0 8px 8px;">${TM3[p.tag].name}</div>
        <div class="nopair-assign" style="display:flex;gap:4px;">
          <button class="assign-btn unset" style="position:static;" onclick="s3OpenSheet(${p.id})">â”€</button>
          <button onclick="s3DelPhoto(${p.id})" style="width:28px;height:28px;border-radius:8px;background:rgba(239,68,68,.9);border:none;color:#fff;font-size:11px;cursor:pointer;flex-shrink:0;">âœ•</button>
        </div>
      </div>`;
    });
    h += `</div></div>`;
  }
  const soloTags = ['d','p','o'];
  soloTags.forEach(t => {
    const L = solos.filter(s => s.tag === t);
    if (!L.length) return;
    const m = TM3[t];
    h += `<div class="solo-section">
      <div class="solo-header">
        <div class="solo-title"><div class="solo-dot" style="background:${m.dot}"></div>${m.name}</div>
        <div class="solo-count">${L.length}æš</div>
      </div>
      <div class="solo-grid">`;
    L.forEach(p => {
      h += `<div class="solo-item">
        <img src="${p.thumb||p.src}" alt="" class="${p.orient==='port'?'port-img':'land-img'}" loading="lazy">
        <div class="orient-pill">${p.orient==='port'?'â–¯ç¸¦':'â–­æ¨ª'}</div>
        <div class="solo-tag ${m.badge}">${m.name}</div>
        ${s3IncludeToggleHTML(p)}
        <button class="del-btn" onclick="s3DelPhoto(${p.id})">âœ•</button>
      </div>`;
    });
    h += `</div></div>`;
  });
  h += '</div>';
  el.innerHTML = h;
}

function s3RenderPair(el) {
  const bs = s3Photos.filter(p => p.tag === 'b');
  const as = s3Photos.filter(p => p.tag === 'a');
  const pnums = [...new Set([...bs,...as].filter(p => p.pairNum).map(p => p.pairNum))].sort((a,b) => a-b);
  if (!pnums.length) { el.innerHTML = `<div class="empty-sec"><div class="ei">â‡”</div>ãƒšã‚¢ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“</div>`; return; }
  let h = '<div style="display:flex;flex-direction:column;gap:10px;">';
  pnums.forEach(n => {
    const b = bs.find(p => p.pairNum === n);
    const a = as.find(p => p.pairNum === n);
    const ok = b && a;
    h += `<div class="pair-card ${ok ? 'ok' : 'warn'}">
      <div class="pair-header"><div class="pair-num">PAIR ${fn(n)}</div><div class="pair-badge ${ok ? 'pb-ok' : 'pb-warn'}">${ok ? 'âœ… å®Œæˆ' : 'âš ï¸ ç‰‡æ–¹ãªã—'}</div></div>
      <div class="pair-images">
        ${b ? `<div class="pair-slot"><img src="${b.src}"><div class="slot-lbl sl-b">Before</div></div>` : `<div class="pair-slot-empty"><div style="font-size:22px">ğŸ“·</div><span>Before ãªã—</span></div>`}
        ${a ? `<div class="pair-slot"><img src="${a.src}" class="${a.orient==='port'?'port-img':'land-img'}"><div class="slot-lbl sl-a">After</div></div>` :
        `<div class="pair-slot-empty" style="cursor:pointer;" onclick="s3PickSlotForPair(${n},'a')"><div style="font-size:28px">â•</div><span style="font-size:10px;color:var(--accent);font-weight:700;">After ã‚’é¸ã¶</span></div>`}
      </div></div>`;
  });
  h += '</div>';
  el.innerHTML = h;
}

function s3IncludeToggleHTML(p) {
  return `<button class="include-toggle" onclick="event.stopPropagation();s3ToggleInclude(${p.id})">
    <div class="toggle-dot ${p.include ? 'on' : ''}"></div>
    <div class="toggle-lbl ${p.include ? 'on' : ''}">å ±å‘Šæ›¸ã«${p.include ? 'å«ã‚ã‚‹' : 'å«ã‚ãªã„'}</div>
  </button>`;
}
function s3ToggleInclude(id) {
  const p = s3Photos.find(x => x.id === id);
  p.include = !p.include;
  s2Photos[p.tag] = s2Photos[p.tag].map(x => x.id === id ? {...x, include: p.include} : x);
  s3UpdateStats(); s3Render();
  toast(p.include ? 'å ±å‘Šæ›¸ã«å«ã‚ã¾ã™' : 'å ±å‘Šæ›¸ã‹ã‚‰é™¤å¤–ã—ã¾ã—ãŸ');
}
function s3DelPhoto(id) {
  const p = s3Photos.find(x => x.id === id);
  if (p) s2Photos[p.tag] = s2Photos[p.tag].filter(x => x.id !== id);
  s3Photos = s3Photos.filter(x => x.id !== id);
  s2UpdateAll(); s3UpdateStats(); s3Render();
  toast('å‰Šé™¤ã—ã¾ã—ãŸ');
}
// ã‚¿ã‚°å¤‰æ›´ç”¨ã®ä¸€æ™‚å¤‰æ•°
let s3SheetNewTag = null;

function s3OpenSheet(id) {
  s3SheetId = id;
  const p = s3Photos.find(x => x.id === id);
  s3SheetNewPair = p.pairNum;
  s3SheetNewTag = p.tag; // ç¾åœ¨ã®ã‚¿ã‚°
  document.getElementById('s3-sheet-img').src = p.thumb || p.src;

  // ã‚¿ã‚°å¤‰æ›´ãƒœã‚¿ãƒ³
  const TM3keys = [
    {t:'b', label:'ğŸ“· Before', col:'var(--before)'},
    {t:'d', label:'ğŸ”¨ é€ å½¢å¾Œ', col:'var(--during)'},
    {t:'a', label:'âœ¨ After',  col:'var(--after)'},
    {t:'p', label:'â­ ã“ã ã‚ã‚Š',col:'var(--pickup)'},
    {t:'o', label:'ğŸ“Œ ãã®ä»–', col:'var(--other)'},
  ];
  const tagContainer = document.getElementById('s3-tag-change-btns');
  tagContainer.innerHTML = TM3keys.map(({t, label, col}) =>
    `<button onclick="s3SelTag('${t}',this)" style="padding:6px 12px;border-radius:100px;font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;transition:all .15s;border:2px solid ${p.tag===t ? col : '#333'};background:${p.tag===t ? col+'22' : '#111'};color:${p.tag===t ? col : '#666'};">${label}</button>`
  ).join('');

  // ãƒšã‚¢ç•ªå·ã‚°ãƒªãƒƒãƒ‰ï¼ˆBefore/Afterã®ã¿è¡¨ç¤ºï¼‰
  const isPairable = p.tag === 'b' || p.tag === 'a';
  const sheetGrid = document.getElementById('s3-sheet-grid');
  if (isPairable) {
    const usedSame  = s3Photos.filter(x => x.tag === p.tag && x.pairNum && x.id !== id).map(x => x.pairNum);
    const usedOther = s3Photos.filter(x => ((p.tag === 'b' && x.tag === 'a') || (p.tag === 'a' && x.tag === 'b')) && x.pairNum).map(x => x.pairNum);
    const maxN = Math.max(s3MaxPair, 3);
    let g = '';
    for (let n = 1; n <= maxN; n++) {
      const isSel = s3SheetNewPair === n;
      const isPaired = usedOther.includes(n) && !usedSame.includes(n);
      g += `<button class="sn-btn ${isSel ? 'sel' : ''} ${isPaired ? 'paired' : ''}" onclick="s3SelPair(${n},this)">${fn(n)}</button>`;
    }
    g += `<button class="sn-btn sn-add" onclick="s3AddPair()">ï¼‹</button>`;
    g += `<button class="sn-none ${s3SheetNewPair === null ? 'sel' : ''}" onclick="s3SelNone(this)">ğŸ“Œ ãƒšã‚¢ãªã—</button>`;
    sheetGrid.innerHTML = g;
    sheetGrid.style.display = '';
    document.querySelector('.sheet-label').style.display = '';
  } else {
    sheetGrid.innerHTML = '';
    sheetGrid.style.display = 'none';
    document.querySelector('.sheet-label').style.display = 'none';
  }
  document.getElementById('s3-sheet').classList.add('show');
}

function s3SelTag(t, btn) {
  s3SheetNewTag = t;
  // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°
  const TM3colors = {b:'var(--before)',d:'var(--during)',a:'var(--after)',p:'var(--pickup)',o:'var(--other)'};
  const col = TM3colors[t];
  document.querySelectorAll('#s3-tag-change-btns button').forEach(b => {
    b.style.border = '2px solid #333';
    b.style.background = '#111';
    b.style.color = '#666';
  });
  btn.style.border = `2px solid ${col}`;
  btn.style.background = col + '22';
  btn.style.color = col;
  // ã‚¿ã‚°ãŒBefore/Afterä»¥å¤–ãªã‚‰ãƒšã‚¢ç•ªå·ã‚°ãƒªãƒƒãƒ‰ã‚’éè¡¨ç¤º
  const isPairable = t === 'b' || t === 'a';
  document.getElementById('s3-sheet-grid').style.display = isPairable ? '' : 'none';
  document.querySelector('.sheet-label').style.display = isPairable ? '' : 'none';
}
function s3SelPair(n, btn) {
  s3SheetNewPair = n;
  document.querySelectorAll('#s3-sheet-grid .sn-btn, #s3-sheet-grid .sn-none').forEach(b => b.classList.remove('sel'));
  btn.classList.add('sel');
}
function s3SelNone(btn) {
  s3SheetNewPair = null;
  document.querySelectorAll('#s3-sheet-grid .sn-btn, #s3-sheet-grid .sn-none').forEach(b => b.classList.remove('sel'));
  btn.classList.add('sel');
}
function s3AddPair() { s3MaxPair++; s3OpenSheet(s3SheetId); }
function s3CloseSheet() { document.getElementById('s3-sheet').classList.remove('show'); }
function s3ApplySheet() {
  const p = s3Photos.find(x => x.id === s3SheetId);
  const oldTag = p.tag;
  // ã‚¿ã‚°å¤‰æ›´ãŒã‚ã‚Œã°åæ˜ 
  if (s3SheetNewTag && s3SheetNewTag !== oldTag) {
    // S2ã®å¤ã„ã‚¿ã‚°é…åˆ—ã‹ã‚‰å‰Šé™¤
    s2Photos[oldTag] = s2Photos[oldTag].filter(x => x.id !== s3SheetId);
    // ã‚¿ã‚°æ›´æ–°
    p.tag = s3SheetNewTag;
    // Before/Afterä»¥å¤–ãªã‚‰pairNumã‚’ã‚¯ãƒªã‚¢
    if (s3SheetNewTag !== 'b' && s3SheetNewTag !== 'a') {
      p.pairNum = null;
      s3SheetNewPair = null;
    }
    // S2ã®æ–°ã—ã„ã‚¿ã‚°é…åˆ—ã«è¿½åŠ 
    s2Photos[s3SheetNewTag].push({...p});
  }
  p.pairNum = s3SheetNewPair;
  // S2ã«ã‚‚pairNumåæ˜ 
  const s2p = s2Photos[p.tag] && s2Photos[p.tag].find(x => x.id === s3SheetId);
  if (s2p) s2p.pairNum = s3SheetNewPair;
  if (s3SheetNewPair && s3SheetNewPair > s3MaxPair) s3MaxPair = s3SheetNewPair;
  s2UpdateAll();
  s3CloseSheet(); s3UpdateStats(); s3Render();
  const msgs = [];
  if (s3SheetNewTag !== oldTag) msgs.push(`ã‚¿ã‚°ã‚’ ${TM3[s3SheetNewTag].name} ã«å¤‰æ›´`);
  if (s3SheetNewPair) msgs.push(`ãƒšã‚¢ ${fn(s3SheetNewPair)} ã«å‰²ã‚Šå½“ã¦`);
  else if (s3SheetNewTag === 'b' || s3SheetNewTag === 'a') msgs.push('ãƒšã‚¢ãªã—');
  toast(msgs.length ? msgs.join(' / ') : 'å¤‰æ›´ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STEP4: å ±å‘Šæ›¸å…¥åŠ›
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncStaffToS4() {
  document.getElementById('f-staff').value = APP.staff || '';
}

function updatePhotoSummary() {
  const incl = s3Photos.filter(p => p.include);
  if (!incl.length) {
    document.getElementById('photo-summary').textContent = 'ğŸ“¸ å†™çœŸãªã—ï¼ˆSTEP2ã§è¿½åŠ ã—ã¦ãã ã•ã„ï¼‰';
    return;
  }
  const cnt = t => incl.filter(p => p.tag === t).length;
  const parts = [];
  if (cnt('b')) parts.push(`Before ${cnt('b')}æš`);
  if (cnt('d')) parts.push(`é€ å½¢å¾Œ ${cnt('d')}æš`);
  if (cnt('a')) parts.push(`After ${cnt('a')}æš`);
  if (cnt('p')) parts.push(`â­ ${cnt('p')}æš`);
  if (cnt('o')) parts.push(`ãã®ä»– ${cnt('o')}æš`);
  document.getElementById('photo-summary').textContent = `ğŸ“¸ æ·»ä»˜äºˆå®šï¼š${parts.join(' ï¼ ')}ã€€è¨ˆ ${incl.length}æš`;
}

function chipToggle(btn, group, multi) {
  if (!multi) {
    document.querySelectorAll(`#chips-${group} .chip, #chips-${group} .color-chip`).forEach(b => b.classList.remove('on'));
  }
  btn.classList.toggle('on');
}
function setType(v) {
  document.getElementById('type-rs').classList.toggle('on', v === 'rs');
  document.getElementById('type-rw').classList.toggle('on', v === 'rw');
}
function setYN(v) {
  document.getElementById('yn-yes').classList.toggle('on', v === 'yes');
  document.getElementById('yn-no').classList.toggle('on', v === 'no');
}
function fillEx(id, text) {
  document.getElementById(id).value = text;
  toast('ä¾‹æ–‡ã‚’å…¥åŠ›ã—ã¾ã—ãŸ');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»é€ä»˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getChips(containerId) {
  return [...document.querySelectorAll(`#${containerId} .on`)].map(b => b.textContent.trim()).join('ãƒ»');
}
function getChipsArr(containerId) {
  return [...document.querySelectorAll(`#${containerId} .on`)].map(b => b.textContent.replace(/[â—â—‹â–ª]/g,'').trim());
}

function buildSendText() {
  const title    = getChips('chips-title') || document.getElementById('title-custom').value || 'ï¼ˆã‚¿ã‚¤ãƒˆãƒ«æœªå…¥åŠ›ï¼‰';
  const size     = document.getElementById('f-size').value;
  const days     = document.getElementById('f-days').value;
  const baseYN   = document.getElementById('yn-yes').classList.contains('on') ? 'ã‚ã‚Š' : 'ãªã—';
  const baseText = document.getElementById('f-base').value;
  const patterns = [...getChipsArr('chips-pattern'), document.getElementById('pattern-custom').value].filter(Boolean).join('ã€');
  const colorMain = [...getChipsArr('chips-color-main'), document.getElementById('color-main-custom').value].filter(Boolean).join(' / ');
  const colorSub  = [...getChipsArr('chips-color-sub'), document.getElementById('color-sub-custom').value].filter(Boolean).join(' / ');
  const grout    = document.getElementById('f-grout').value;
  const point    = document.getElementById('f-point').value;
  const voice    = document.getElementById('f-voice').value;
  const problem  = document.getElementById('f-problem').value;
  const free     = document.getElementById('f-free').value;
  const staff    = document.getElementById('f-staff').value || APP.staff || 'ï¼ˆæ‹…å½“è€…æœªå…¥åŠ›ï¼‰';
  const isRS     = document.getElementById('type-rs').classList.contains('on');
  const typeName = isRS ? 'RollerStone' : 'RollerWall';

  let txt = '';
  txt += `ã€æ–½å·¥å ±å‘Šã€‘${APP.pref} ${APP.company}\n`;
  txt += `â—† ${typeName}ã€€${title}\n`;
  txt += `${'â”€'.repeat(18)}\n\n`;
  txt += `â–  æ‹…å½“ï¼š${staff}\n`;
  txt += `â–  æ—¥ä»˜ï¼š${new Date().toLocaleDateString('ja-JP', {year:'numeric', month:'numeric', day:'numeric'})}\n\n`;
  if (size)      txt += `â–· è¦æ¨¡ï¼š${size}ã¡\n`;
  if (days)      txt += `â–· æ–½å·¥æ—¥æ•°ï¼š${days}æ—¥\n`;
  txt += `â–· ä¸‹åœ°å‡¦ç†ï¼š${baseYN}${baseText ? ' ï¼ˆ' + baseText + 'ï¼‰' : ''}\n`;
  if (patterns)  txt += `â–· ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š${patterns}\n`;
  if (colorMain) {
    txt += `â–· ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ï¼š${colorMain}`;
    if (colorSub) txt += ` / ã‚µãƒ–ï¼š${colorSub}`;
    txt += '\n';
  }
  if (grout)   txt += `â–· ç›®åœ°ã‚«ãƒ©ãƒ¼ï¼š${grout}\n`;
  if (point)   txt += `\nâ˜… ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ\n${point}\n`;
  if (voice)   txt += `\nğŸ’¬ ãŠå®¢æ§˜ã®å£°\n${voice}\n`;
  if (problem) txt += `\nğŸ˜Ÿ ãŠå®¢æ§˜ã®ãŠæ‚©ã¿\n${problem}\n`;
  if (free)    txt += `\nğŸ“ ${free}\n`;
  // å†™çœŸã‚µãƒãƒªãƒ¼
  const incl = s3Photos.filter(p => p.include);
  if (incl.length) {
    const cnt = t => incl.filter(p => p.tag === t).length;
    txt += `\n${'â”€'.repeat(18)}\n`;
    txt += `ğŸ“· æ·»ä»˜ï¼š${incl.length}æšï¼ˆBefore:${cnt('b')} é€ å½¢å¾Œ:${cnt('d')} After:${cnt('a')} â­:${cnt('p')}ï¼‰`;
  }
  return txt;
}

function goPreview() {
  const txt = buildSendText();
  document.getElementById('send-text-box').textContent = txt;
  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('fb-text').style.display = '';
  document.getElementById('fb-actions').style.display = '';
  document.getElementById('fb-sent').style.display = 'none';
  document.getElementById('fb-text').value = '';
  goTo('preview');
}

function copyText() {
  const txt = document.getElementById('send-text-box').textContent;
  const btn = document.getElementById('btn-copy');
  if (navigator.clipboard) {
    navigator.clipboard.writeText(txt).then(() => {
      btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼';
      btn.classList.add('copied-flash');
      setTimeout(() => { btn.textContent = 'ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼'; btn.classList.remove('copied-flash'); }, 2500);
    }).catch(() => fallbackCopy(txt));
  } else { fallbackCopy(txt); }
}
function fallbackCopy(txt) {
  const ta = document.createElement('textarea');
  ta.value = txt; ta.style.cssText = 'position:fixed;opacity:0;';
  document.body.appendChild(ta); ta.select();
  document.execCommand('copy'); document.body.removeChild(ta);
  toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
}

async function downloadZip() {
  const d = new Date();
  const ds = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
  const siteName = (APP.siteName || 'ç¾å ´').replace(/[\s\/:*?"<>|]/g,'_');
  const zipName = `RS_å ±å‘Š_${siteName}_${ds}.zip`;
  const btn = document.getElementById('btn-zip');
  btn.textContent = 'â³ ZIPä½œæˆä¸­â€¦';
  btn.disabled = true;

  const tagName = {b:'Before', d:'é€ å½¢å¾Œ', a:'After', p:'ã“ã ã‚ã‚Š', o:'ãã®ä»–'};
  const tagOrder = ['b','d','a','p','o'];
  const tagCount = {b:0,d:0,a:0,p:0,o:0};
  const txt = document.getElementById('send-text-box').textContent;

  // å†™çœŸãƒªã‚¹ãƒˆåé›†
  const photoFiles = [];
  for (const tag of tagOrder) {
    const photos = s3Photos.filter(p => p.tag === tag && p.include !== false);
    const sorted = [
      ...photos.filter(p => p.pairNum).sort((a,b) => a.pairNum - b.pairNum),
      ...photos.filter(p => !p.pairNum)
    ];
    for (const photo of sorted) {
      const base64 = photo.src ? photo.src.split(',')[1] : null;
      if (!base64) continue;
      tagCount[tag]++;
      const num = String(tagCount[tag]).padStart(2,'0');
      photoFiles.push({ name: `${ds}_${tagName[tag]}_${num}.jpg`, base64 });
    }
  }

  // JSZipãŒä½¿ãˆã‚‹ã‹è©¦ã¿ã‚‹
  if (typeof JSZip !== 'undefined') {
    try {
      const zip = new JSZip();
      zip.file(`å ±å‘Šæ›¸_${ds}.txt`, txt);
      photoFiles.forEach(f => zip.file(f.name, f.base64, {base64: true}));
      const blob = await zip.generateAsync({type:'blob', compression:'DEFLATE', compressionOptions:{level:4}});
      triggerDownload(blob, zipName);
      showDownloadGuide(zipName, photoFiles.length);
      btn.textContent = 'ğŸ“¦ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'; btn.disabled = false;
      return;
    } catch(e) {
      console.warn('JSZip failed, trying manual ZIP:', e);
    }
  }

  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ‰‹å‹•ã§ZIPãƒã‚¤ãƒŠãƒªã‚’æ§‹ç¯‰ï¼ˆPure JSã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªä¸è¦ï¼‰
  try {
    const entries = [{name:`å ±å‘Šæ›¸_${ds}.txt`, data: strToUint8(txt)}];
    for (const f of photoFiles) {
      entries.push({name: f.name, data: b64ToUint8(f.base64)});
    }
    const zipBlob = buildZip(entries);
    triggerDownload(zipBlob, zipName);
    showDownloadGuide(zipName, photoFiles.length);
  } catch(e2) {
    // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ†ã‚­ã‚¹ãƒˆã®ã¿
    toast('âš ï¸ ZIPç”Ÿæˆå¤±æ•—ã€‚ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™');
    const b = new Blob([txt], {type:'text/plain;charset=utf-8'});
    triggerDownload(b, `RS_å ±å‘Š_${ds}.txt`);
  } finally {
    btn.textContent = 'ğŸ“¦ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰'; btn.disabled = false;
  }
}

function triggerDownload(blob, filename) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

function strToUint8(str) {
  return new TextEncoder().encode(str);
}

function b64ToUint8(b64) {
  const bin = atob(b64);
  const arr = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
  return arr;
}

// Pure JS ZIP builderï¼ˆSTOREã€ç„¡åœ§ç¸®ï¼‰
function buildZip(entries) {
  const parts = [];
  const centralDir = [];
  let offset = 0;

  for (const entry of entries) {
    const nameBytes = new TextEncoder().encode(entry.name);
    const data = entry.data;
    const crc = crc32(data);
    const size = data.length;

    // Local file header
    const lh = new Uint8Array(30 + nameBytes.length);
    const lv = new DataView(lh.buffer);
    lv.setUint32(0, 0x04034b50, true);   // signature
    lv.setUint16(4, 20, true);            // version needed
    lv.setUint16(6, 0, true);             // flags
    lv.setUint16(8, 0, true);             // compression: STORE
    lv.setUint16(10, 0, true);            // mod time
    lv.setUint16(12, 0, true);            // mod date
    lv.setUint32(14, crc, true);          // crc32
    lv.setUint32(18, size, true);         // compressed size
    lv.setUint32(22, size, true);         // uncompressed size
    lv.setUint16(26, nameBytes.length, true); // filename length
    lv.setUint16(28, 0, true);            // extra length
    lh.set(nameBytes, 30);

    parts.push(lh);
    parts.push(data);

    // Central directory entry
    const cd = new Uint8Array(46 + nameBytes.length);
    const cv = new DataView(cd.buffer);
    cv.setUint32(0, 0x02014b50, true);   // signature
    cv.setUint16(4, 20, true);            // version made by
    cv.setUint16(6, 20, true);            // version needed
    cv.setUint16(8, 0, true);             // flags
    cv.setUint16(10, 0, true);            // compression: STORE
    cv.setUint16(12, 0, true);            // mod time
    cv.setUint16(14, 0, true);            // mod date
    cv.setUint32(16, crc, true);          // crc32
    cv.setUint32(20, size, true);         // compressed size
    cv.setUint32(24, size, true);         // uncompressed size
    cv.setUint16(28, nameBytes.length, true); // filename length
    cv.setUint16(30, 0, true);            // extra length
    cv.setUint16(32, 0, true);            // comment length
    cv.setUint16(34, 0, true);            // disk start
    cv.setUint16(36, 0, true);            // internal attr
    cv.setUint32(38, 0, true);            // external attr
    cv.setUint32(42, offset, true);       // local header offset
    cd.set(nameBytes, 46);
    centralDir.push(cd);

    offset += lh.length + data.length;
  }

  const cdStart = offset;
  const cdSize = centralDir.reduce((s,c) => s + c.length, 0);

  // End of central directory
  const eocd = new Uint8Array(22);
  const ev = new DataView(eocd.buffer);
  ev.setUint32(0, 0x06054b50, true);    // signature
  ev.setUint16(4, 0, true);             // disk number
  ev.setUint16(6, 0, true);             // disk with cd
  ev.setUint16(8, entries.length, true); // entries on disk
  ev.setUint16(10, entries.length, true); // total entries
  ev.setUint32(12, cdSize, true);        // cd size
  ev.setUint32(16, cdStart, true);       // cd offset
  ev.setUint16(20, 0, true);             // comment length

  const allParts = [...parts, ...centralDir, eocd];
  const totalSize = allParts.reduce((s,p) => s + p.length, 0);
  const result = new Uint8Array(totalSize);
  let pos = 0;
  for (const p of allParts) { result.set(p, pos); pos += p.length; }
  return new Blob([result], {type:'application/zip'});
}

// CRC32ãƒ†ãƒ¼ãƒ–ãƒ«
const crc32Table = (() => {
  const t = new Uint32Array(256);
  for (let i = 0; i < 256; i++) {
    let c = i;
    for (let j = 0; j < 8; j++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
    t[i] = c;
  }
  return t;
})();

function crc32(data) {
  let crc = 0xFFFFFFFF;
  for (let i = 0; i < data.length; i++) crc = crc32Table[(crc ^ data[i]) & 0xFF] ^ (crc >>> 8);
  return (crc ^ 0xFFFFFFFF) >>> 0;
}
function showDownloadGuide(fname, photoCount) {
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;display:flex;align-items:flex-end;justify-content:center;padding-bottom:32px;max-width:480px;margin:0 auto;left:50%;transform:translateX(-50%);';
  overlay.innerHTML = `
    <div style="background:#1a1a1a;border:1px solid rgba(232,160,32,.3);border-radius:20px;padding:24px;width:calc(100% - 32px);max-width:440px;">
      <div style="font-size:28px;text-align:center;margin-bottom:12px;">ğŸ“¥</div>
      <div style="font-size:15px;font-weight:900;color:#e8a020;text-align:center;margin-bottom:6px;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼</div>
      <div style="font-size:13px;color:#f0f0f0;font-weight:700;text-align:center;margin-bottom:16px;">${fname}${photoCount !== undefined ? `<br><span style="font-size:11px;color:#aaa;">(å†™çœŸ ${photoCount}æš + å ±å‘Šãƒ†ã‚­ã‚¹ãƒˆ)</span>` : ""}</div>
      <div style="background:#111;border-radius:12px;padding:14px;margin-bottom:16px;font-size:12px;color:#999;line-height:2.2;">
        <div style="color:#e8a020;font-weight:700;margin-bottom:4px;">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€</div>
        <div>iPhoneï¼š<strong style="color:#f0f0f0;">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒ—ãƒª â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</strong></div>
        <div>Androidï¼š<strong style="color:#f0f0f0;">ãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</strong></div>
        <div style="margin-top:8px;color:#e8a020;font-weight:700;">ğŸ“¤ LINEã¸ã®æ·»ä»˜æ–¹æ³•</div>
        <div>LINEãƒˆãƒ¼ã‚¯ â†’ ï¼‹ â†’ ãƒ•ã‚¡ã‚¤ãƒ« â†’ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
      </div>
      <button onclick="this.parentElement.parentElement.remove()" style="width:100%;padding:15px;background:#e8a020;color:#000;border:none;border-radius:12px;font-size:15px;font-weight:900;font-family:inherit;cursor:pointer;">OKã€ã‚ã‹ã£ãŸï¼</button>
    </div>`;
  document.body.appendChild(overlay);
}

function confirmDelete() {
  if (confirm('ã“ã®å ±å‘Šæ›¸ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nâ€»å†™çœŸãƒ‡ãƒ¼ã‚¿ã‚‚å«ã‚å‰Šé™¤ã•ã‚Œã¾ã™')) {
    s2Photos = {b:[],d:[],a:[],p:[],o:[]};
    s3Photos = []; s3MaxPair = 0;
    toast('å‰Šé™¤ã—ã¾ã—ãŸ');
    setTimeout(() => goTo('s2'), 800);
  }
}

// ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
async function sendFeedback() {
  const msg = document.getElementById('fb-text').value.trim();
  if (!msg) { toast('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const staff = document.getElementById('f-staff').value || APP.staff || 'åŒ¿å';
  try {
    const res = await fetch('https://formspree.io/f/xjkwgqpk', {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'Accept': 'application/json'},
      body: JSON.stringify({message: msg, staff, date: new Date().toLocaleDateString('ja-JP'), _subject: `RS-Reporter ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ from ${staff}`})
    });
    if (!res.ok) throw new Error();
  } catch(e) {
    try { const s = JSON.parse(localStorage.getItem('rs_fb') || '[]'); s.push({msg, staff, date: new Date().toISOString()}); localStorage.setItem('rs_fb', JSON.stringify(s)); } catch(e2){}
  }
  document.getElementById('fb-text').style.display = 'none';
  document.getElementById('fb-actions').style.display = 'none';
  document.getElementById('fb-sent').style.display = 'block';
}
function skipFeedback() {
  document.getElementById('fb-text').style.display = 'none';
  document.getElementById('fb-actions').style.display = 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ãƒˆãƒ¼ã‚¹ãƒˆ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢è‡ªå‹•ä¼¸ç¸® â”€â”€
function autoGrow(el) {
  el.style.height = 'auto';
  el.style.height = (el.scrollHeight) + 'px';
  autoDraft(); // å…¥åŠ›ã®ãŸã³ã«ä¸‹æ›¸ãä¿å­˜
}

// â”€â”€ è‡ªå‹•ä¸‹æ›¸ãä¿å­˜ â”€â”€
function autoDraft() {
  try {
    const draft = {
      savedAt: new Date().toISOString(),
      pref: APP.pref, company: APP.company, staff: APP.staff,
      form: {
        staff:    document.getElementById('f-staff')?.value || '',
        size:     document.getElementById('f-size')?.value || '',
        days:     document.getElementById('f-days')?.value || '',
        base:     document.getElementById('f-base')?.value || '',
        grout:    document.getElementById('f-grout')?.value || '',
        point:    document.getElementById('f-point')?.value || '',
        voice:    document.getElementById('f-voice')?.value || '',
        problem:  document.getElementById('f-problem')?.value || '',
        free:     document.getElementById('f-free')?.value || '',
        titleCustom: document.getElementById('title-custom')?.value || '',
        patternCustom: document.getElementById('pattern-custom')?.value || '',
      }
    };
    localStorage.setItem('rs_draft', JSON.stringify(draft));
  } catch(e) {}
}

// â”€â”€ ä¸‹æ›¸ãå¾©å…ƒï¼ˆSTEP4è¡¨ç¤ºæ™‚ï¼‰ â”€â”€
function restoreDraft() {
  try {
    const raw = localStorage.getItem('rs_draft');
    if (!raw) return;
    const d = JSON.parse(raw);
    if (!d.form) return;
    const age = (Date.now() - new Date(d.savedAt).getTime()) / 1000 / 60; // åˆ†
    if (age > 120) return; // 2æ™‚é–“ä»¥ä¸Šå¤ã„ä¸‹æ›¸ãã¯ç„¡è¦–
    const f = d.form;
    const set = (id, v) => { const el = document.getElementById(id); if (el && v) el.value = v; };
    set('f-staff', f.staff); set('f-size', f.size); set('f-days', f.days);
    set('f-base', f.base); set('f-grout', f.grout); set('f-point', f.point);
    set('f-voice', f.voice); set('f-problem', f.problem); set('f-free', f.free);
    set('title-custom', f.titleCustom); set('pattern-custom', f.patternCustom);
    // è‡ªå‹•ä¼¸ç¸®ã‚’é©ç”¨
    ['f-point','f-voice','f-problem','f-free'].forEach(id => {
      const el = document.getElementById(id);
      if (el && el.value) { el.style.height='auto'; el.style.height=el.scrollHeight+'px'; }
    });
    const ago = Math.round(age);
    if (ago < 1) return;
    showDraftBanner(ago < 60 ? `${ago}åˆ†å‰ã®ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸ` : `${Math.round(age/60)}æ™‚é–“å‰ã®ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
  } catch(e) {}
}

function showDraftBanner(msg) {
  const banner = document.createElement('div');
  banner.style.cssText = 'background:rgba(232,160,32,.12);border:1px solid rgba(232,160,32,.3);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--accent);margin-bottom:12px;display:flex;align-items:center;gap:8px;';
  banner.innerHTML = `<span>ğŸ“</span><span style="flex:1;">${msg}</span><button onclick="this.parentElement.remove()" style="background:none;border:none;color:var(--text2);font-size:16px;cursor:pointer;">âœ•</button>`;
  const body = document.querySelector('.s4-body');
  if (body) body.insertBefore(banner, body.firstChild);
}

// 30ç§’ã”ã¨ã«è‡ªå‹•ä¸‹æ›¸ãä¿å­˜
setInterval(autoDraft, 30000);

// â”€â”€ STEP2é€”ä¸­ä¿å­˜ã—ã¦çµ‚ã‚ã‚‹ â”€â”€
function saveAndExit() {
  const total = Object.values(s2Photos).reduce((s, a) => s + a.length, 0);
  if (total === 0) { toast('å†™çœŸãŒ1æšã‚‚ã‚ã‚Šã¾ã›ã‚“'); return; }
  try {
    // ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆ200pxç‰ˆï¼‰ã®ã¿ä¿å­˜ã—ã¦ãƒ¡ã‚¿æƒ…å ±ã¨å…±ã«localStorageã¸
    const meta = {};
    ['b','d','a','p','o'].forEach(t => {
      meta[t] = s2Photos[t].map(p => ({
        id: p.id, tag: p.tag, orient: p.orient,
        pairNum: p.pairNum, include: p.include,
        thumb: p.thumb || ''
      }));
    });
    const data = {
      savedAt: new Date().toISOString(),
      pref: APP.pref, company: APP.company, staff: APP.staff,
      siteName: APP.siteName || '',
      photoMeta: meta,
      totalCount: total
    };
    const json = JSON.stringify(data);
    localStorage.setItem('rs_midway', json);

    // ä¿å­˜ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    showMidwaySavedModal(total, json.length);
  } catch(e) {
    if (e.name === 'QuotaExceededError') {
      toast('âš ï¸ ä¿å­˜å®¹é‡ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„');
    } else {
      toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }
}

function showMidwaySavedModal(total, byteSize) {
  const kb = Math.round(byteSize / 1024);
  const overlay = document.createElement('div');
  overlay.id = 'midway-modal';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:9999;display:flex;align-items:flex-end;justify-content:center;padding-bottom:32px;max-width:480px;margin:0 auto;left:50%;transform:translateX(-50%);';
  overlay.innerHTML = `
    <div style="background:#1a1a1a;border:1.5px solid rgba(34,197,94,.4);border-radius:20px;padding:24px;width:calc(100% - 32px);">
      <div style="font-size:28px;text-align:center;margin-bottom:10px;">ğŸ’¾</div>
      <div style="font-size:16px;font-weight:900;color:var(--ok);text-align:center;margin-bottom:6px;">é€”ä¸­ä¿å­˜ã—ã¾ã—ãŸ</div>
      <div style="background:#111;border-radius:12px;padding:14px;margin:14px 0;font-size:13px;color:#ccc;line-height:2.2;">
        <div>ğŸ“· å†™çœŸæšæ•°ï¼š<strong style="color:#fff;">${total}æš</strong>ï¼ˆã‚µãƒ ãƒã‚¤ãƒ«ã®ã¿ä¿å­˜ï¼‰</div>
        <div>ğŸ’¾ ä¿å­˜ã‚µã‚¤ã‚ºï¼š<strong style="color:#fff;">${kb} KB</strong></div>
        <div>ğŸ• ä¿å­˜æ—¥æ™‚ï¼š<strong style="color:#fff;">${new Date().toLocaleString('ja-JP')}</strong></div>
        <div style="margin-top:8px;padding-top:8px;border-top:1px solid #333;font-size:11px;color:#888;">
          âš ï¸ å†™çœŸã®å®Ÿãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚<br>æ¬¡å›ã¯å†åº¦å†™çœŸã‚’ã‚¢ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
        </div>
      </div>
      <button onclick="document.getElementById('midway-modal').remove()" style="width:100%;padding:14px;background:var(--ok);color:#000;border:none;border-radius:12px;font-size:15px;font-weight:900;font-family:inherit;cursor:pointer;">OKã€ç¢ºèªã—ã¾ã—ãŸ</button>
    </div>`;
  document.body.appendChild(overlay);
}

// â”€â”€ å ±å‘Šæ›¸ä¿å­˜ â”€â”€
function saveReport() {
  const btn = document.getElementById('save-btn');
  try {
    const saveData = {
      savedAt: new Date().toISOString(),
      pref: APP.pref,
      company: APP.company,
      staff: APP.staff,
      siteName: APP.siteName || document.getElementById('title-custom')?.value || '',
      text: document.getElementById('send-text-box').textContent,
    };
    const key = `rs_report_${Date.now()}`;
    localStorage.setItem(key, JSON.stringify(saveData));
    localStorage.removeItem('rs_draft'); // ä¸‹æ›¸ãã‚¯ãƒªã‚¢
    btn.textContent = 'âœ… ä¿å­˜ã—ã¾ã—ãŸï¼';
    btn.style.background = 'rgba(34,197,94,.3)';
    btn.style.color = 'var(--ok)';
    btn.style.borderColor = 'var(--ok)';
    btn.disabled = true;
    toast('âœ… å ±å‘Šæ›¸ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    setTimeout(() => {
      btn.textContent = 'ğŸ’¾ ã“ã®å ±å‘Šã‚’ä¿å­˜ã™ã‚‹';
      btn.disabled = false;
    }, 3000);
  } catch(e) {
    toast('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// â”€â”€ STEP3 ãƒšã‚¢ç¢ºèªã‹ã‚‰Afterã‚’ç›´æ¥ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ â”€â”€
// æœªå‰²å½“ã¦å†™çœŸã‹ã‚‰é¸ã¶ã‚·ãƒ¼ãƒˆ
let s3PickTargetPair = null;
let s3PickTargetTag = null;

function s3PickSlotForPair(pairNum, tag) {
  s3PickTargetPair = pairNum;
  s3PickTargetTag = tag;
  const tagLabel = tag === 'b' ? 'Before' : 'After';
  const oppTag   = tag === 'b' ? 'a' : 'b';

  // æœªå‰²å½“ã¦å†™çœŸã‚’å–å¾—ï¼ˆåŒã˜ã‚¿ã‚° or é€†ã‚¿ã‚°ã§ãƒšã‚¢ãªã—ï¼‰
  // Beforeç©ºæ¬„â†’Beforeæœªå‰²å½“ã¦ã€Afterç©ºæ¬„â†’Afteræœªå‰²å½“ã¦ ã‚’å¯¾è±¡
  const candidates = s3Photos.filter(p => p.tag === tag && !p.pairNum);

  const title = document.getElementById('s3-pick-title');
  const sub   = document.getElementById('s3-pick-sub');
  const grid  = document.getElementById('s3-pick-grid');
  title.textContent = `PAIR ${fn(pairNum)} ã® ${tagLabel} ã‚’é¸ã¶`;
  sub.textContent   = `æœªå‰²å½“ã¦ã® ${tagLabel} å†™çœŸï¼ˆ${candidates.length}æšï¼‰ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„`;

  if (!candidates.length) {
    grid.innerHTML = `<div style="grid-column:span 3;text-align:center;padding:24px;color:var(--text2);font-size:13px;">
      æœªå‰²å½“ã¦ã®${tagLabel}å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“<br>
      <span style="font-size:11px;">STEP2ã§${tagLabel}å†™çœŸã‚’è¿½åŠ ã—ã¦ãã ã•ã„</span>
    </div>`;
  } else {
    grid.innerHTML = candidates.map(p => `
      <div onclick="s3AssignToSlot(${p.id})" style="cursor:pointer;border-radius:10px;overflow:hidden;border:2px solid var(--border);aspect-ratio:1;position:relative;">
        <img src="${p.thumb||p.src}" style="width:100%;height:100%;object-fit:cover;">
        <div style="position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);font-size:9px;font-weight:700;color:#fff;padding:3px;text-align:center;">${p.orient==='port'?'â–¯ç¸¦':'â–­æ¨ª'}</div>
      </div>
    `).join('');
  }
  document.getElementById('s3-pick-sheet').classList.add('show');
}

function s3AssignToSlot(photoId) {
  const p = s3Photos.find(x => x.id === photoId);
  if (!p) return;
  p.pairNum = s3PickTargetPair;
  // S2ã«ã‚‚åæ˜ 
  const s2p = s2Photos[p.tag]?.find(x => x.id === photoId);
  if (s2p) s2p.pairNum = s3PickTargetPair;
  if (s3PickTargetPair > s3MaxPair) s3MaxPair = s3PickTargetPair;
  s3ClosePickSheet();
  s3UpdateStats();
  s3Render();
  toast(`âœ… PAIR ${fn(s3PickTargetPair)} ã«å‰²ã‚Šå½“ã¦ã¾ã—ãŸ`);
}

function s3ClosePickSheet() {
  document.getElementById('s3-pick-sheet').classList.remove('show');
  s3PickTargetPair = null;
  s3PickTargetTag  = null;
}

function s3PickAfterForPair(pairNum) {
  s3PickSlotForPair(pairNum, 'a');
}

let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast-el');
  el.textContent = msg; el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}
</script>
</body>
</html>
