<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RS-Reporter Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Bebas+Neue&display=swap');
:root {
  --bg:#0f0f0f; --surface:#1a1a1a; --surface2:#242424; --border:#2e2e2e;
  --accent:#e8a020; --text:#f0f0f0; --text2:#666;
  --before:#4a9eff; --during:#a855f7; --after:#22c55e; --pickup:#f59e0b; --danger:#ef4444;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans JP',sans-serif;min-height:100vh;overflow-x:hidden;padding-bottom:60px;}

/* HEADER */
.header{background:var(--surface);border-bottom:2px solid var(--accent);padding:12px 16px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:2px;color:var(--accent);}
.logo-sub{font-size:9px;color:var(--text2);letter-spacing:1px;margin-top:1px;}

/* SCREENS */
.screen{display:none;padding:20px 16px;}
.screen.active{display:block;}

/* BUTTONS */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;border:none;border-radius:12px;font-family:'Noto Sans JP',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all .15s;min-height:56px;width:100%;}
.btn:active{transform:scale(.97);}
.btn-primary{background:var(--accent);color:#000;}
.btn-secondary{background:var(--surface2);color:var(--text);border:1px solid var(--border);}
.btn-ghost{background:transparent;color:var(--text2);border:1px solid var(--border);font-size:14px;min-height:44px;}
.btn-danger{background:transparent;color:var(--danger);border:1px solid var(--danger);font-size:14px;min-height:44px;}
.btn-add{background:rgba(232,160,32,.1);color:var(--accent);border:1px dashed var(--accent);font-size:14px;min-height:48px;border-radius:10px;}
.btn-sm{min-height:44px;font-size:14px;padding:10px 16px;border-radius:8px;}

.back-btn{display:flex;align-items:center;gap:6px;font-size:14px;color:var(--text2);cursor:pointer;padding:8px 0;margin-bottom:16px;background:none;border:none;font-family:'Noto Sans JP',sans-serif;}

/* FORM */
.form-group{margin-bottom:22px;}
.form-label{display:block;font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;border-left:3px solid var(--accent);padding-left:8px;}
.form-label .opt{color:var(--text2);font-size:10px;font-weight:400;text-transform:none;letter-spacing:0;}
.form-input{width:100%;background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;font-size:16px;color:var(--text);font-family:'Noto Sans JP',sans-serif;outline:none;transition:border-color .15s;min-height:56px;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--text2);}
textarea.form-input{min-height:90px;resize:none;line-height:1.6;}
.input-row{display:flex;gap:10px;}
.unit-wrap{position:relative;}
.unit-wrap .form-input{padding-right:44px;}
.unit-wrap .unit{position:absolute;right:14px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:14px;pointer-events:none;}

/* CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:8px;}
.chip{padding:10px 16px;border-radius:100px;border:1px solid var(--border);background:var(--surface);color:var(--text2);font-size:14px;font-weight:500;cursor:pointer;transition:all .15s;font-family:'Noto Sans JP',sans-serif;min-height:44px;display:flex;align-items:center;gap:6px;}
.chip.active{border-color:var(--accent);background:rgba(232,160,32,.15);color:var(--accent);font-weight:700;}
.hint{font-size:12px;color:var(--text2);margin-top:6px;line-height:1.5;}
.hint em{color:var(--accent);font-style:normal;}
.sec-title{font-size:11px;color:var(--text2);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;border-left:3px solid var(--accent);padding-left:8px;}
.divider{height:1px;background:var(--border);margin:20px 0;}

/* HOME */
.hero{background:linear-gradient(135deg,var(--surface),#1e1a0e);border:1px solid var(--accent);border-radius:16px;padding:24px;margin-bottom:24px;position:relative;overflow:hidden;}
.hero::before{content:'RS';font-family:'Bebas Neue',sans-serif;font-size:130px;color:rgba(232,160,32,.05);position:absolute;right:-10px;top:-20px;line-height:1;}
.hero-tag{font-size:11px;color:var(--accent);letter-spacing:2px;margin-bottom:8px;}
.hero-title{font-size:20px;font-weight:900;line-height:1.4;margin-bottom:20px;}
.hero-title span{color:var(--accent);}
.site-list{display:flex;flex-direction:column;gap:10px;}
.site-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:space-between;}
.site-card:active{border-color:var(--accent);}
.site-name{font-size:16px;font-weight:700;margin-bottom:4px;}
.site-meta{font-size:12px;color:var(--text2);}
.badges{display:flex;gap:5px;flex-wrap:wrap;justify-content:flex-end;max-width:150px;}
.badge{font-size:10px;padding:3px 8px;border-radius:20px;font-weight:700;white-space:nowrap;}
.b-before{background:rgba(74,158,255,.2);color:var(--before);}
.b-during{background:rgba(168,85,247,.2);color:var(--during);}
.b-after{background:rgba(34,197,94,.2);color:var(--after);}
.b-pickup{background:rgba(245,158,11,.2);color:var(--pickup);}
.b-gray{background:var(--surface2);color:var(--text2);}
.empty{text-align:center;padding:40px 20px;color:var(--text2);}
.empty-icon{font-size:48px;margin-bottom:12px;}

/* TAG BUTTONS */
.tag-bar{display:flex;gap:8px;margin-bottom:14px;}
.tag-btn{
  flex:1;padding:10px 4px;border-radius:12px;
  font-size:11px;font-weight:700;cursor:pointer;transition:all .25s;
  font-family:'Noto Sans JP',sans-serif;text-align:center;min-height:62px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
  /* æœªé¸æŠï¼šã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»æš—ã„ */
  border:2px solid #2a2a2a;background:#141414;color:#3a3a3a;
  filter:grayscale(1);
}
.tag-btn .ti{font-size:20px;display:block;}
.tag-btn.active{
  filter:none;transform:scale(1.06);
  box-shadow:0 4px 18px rgba(0,0,0,.5);
}
.tag-btn.active.t-before{border-color:var(--before);background:rgba(74,158,255,.15);color:var(--before);}
.tag-btn.active.t-during{border-color:var(--during);background:rgba(168,85,247,.15);color:var(--during);}
.tag-btn.active.t-after{border-color:var(--after);background:rgba(34,197,94,.15);color:var(--after);}
.tag-btn.active.t-pickup{border-color:var(--pickup);background:rgba(245,158,11,.15);color:var(--pickup);}

/* UPLOAD */
.upload-zone{border:2px dashed var(--border);border-radius:16px;padding:28px 20px;text-align:center;margin-bottom:16px;cursor:pointer;background:var(--surface);transition:all .15s;}
.upload-zone:active{border-color:var(--accent);}
.upload-zone .ui{font-size:36px;margin-bottom:8px;}
.upload-zone .ut{font-size:16px;font-weight:700;}
.upload-zone .us{font-size:12px;color:var(--text2);margin-top:4px;}
.upload-zone .tag-hint{font-size:12px;color:var(--accent);margin-top:4px;font-weight:700;}

/* PHOTO GRID */
.photo-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;margin-bottom:16px;}
.photo-item{
  position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;
  border:3px solid transparent;transition:all .2s;cursor:pointer;
}
.photo-item img{width:100%;height:100%;object-fit:cover;display:block;filter:grayscale(100%) brightness(.55);transition:filter .2s;}
.photo-item.selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(232,160,32,.35);}
.photo-item.selected img{filter:none;}
.photo-item .chk{position:absolute;top:5px;right:5px;width:24px;height:24px;border-radius:50%;background:var(--accent);display:none;align-items:center;justify-content:center;font-size:13px;color:#000;font-weight:900;z-index:8;}
.photo-item.selected .chk{display:flex;}
.photo-item .ori{position:absolute;bottom:3px;left:3px;font-size:9px;padding:2px 5px;border-radius:3px;background:rgba(0,0,0,.75);color:#fff;z-index:8;}
.photo-item .del{position:absolute;top:5px;left:5px;width:24px;height:24px;border-radius:50%;background:rgba(239,68,68,.9);display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;z-index:10;cursor:pointer;}
.photo-item .tap{position:absolute;inset:0;z-index:5;cursor:pointer;}
.photo-item .tag-badge{position:absolute;bottom:0;left:0;right:0;font-size:9px;font-weight:700;text-align:center;padding:3px 0;z-index:8;}
.tb-before{background:rgba(74,158,255,.85);}
.tb-during{background:rgba(168,85,247,.85);}
.tb-after{background:rgba(34,197,94,.85);color:#000;}
.tb-pickup{background:rgba(245,158,11,.85);color:#000;}

/* SORT BAR */
.sort-bar{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;}
.sort-chip{padding:8px 14px;border-radius:100px;border:1px solid var(--border);background:var(--surface);color:var(--text2);font-size:13px;font-weight:600;cursor:pointer;font-family:'Noto Sans JP',sans-serif;min-height:40px;display:flex;align-items:center;gap:5px;transition:all .15s;}
.sort-chip.active{border-color:var(--accent);background:rgba(232,160,32,.15);color:var(--accent);}

/* PAIR VIEW */
.pair-row{display:flex;gap:5px;margin-bottom:8px;}
.pair-row .photo-item{flex:1;aspect-ratio:unset;}
.pair-row .photo-item.portrait{height:200px;}
.pair-row .photo-item.landscape{height:128px;}

/* INSTAGRAM SECTION */
.ig-section{background:linear-gradient(135deg,#1a1020,#0f1a15);border:1px solid rgba(245,158,11,.3);border-radius:16px;padding:18px;margin-bottom:20px;}
.ig-header{display:flex;align-items:center;gap:8px;margin-bottom:14px;}
.ig-icon{font-size:20px;}
.ig-title{font-size:13px;font-weight:900;color:var(--pickup);}
.ig-sub{font-size:11px;color:var(--text2);margin-top:1px;}
.ig-badge{font-size:10px;background:rgba(245,158,11,.15);color:var(--pickup);border:1px solid rgba(245,158,11,.3);padding:2px 8px;border-radius:20px;margin-left:auto;}

/* MAIN VISUAL */
.main-visual-slot{border:2px dashed rgba(245,158,11,.4);border-radius:12px;min-height:100px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;margin-bottom:12px;}
.main-visual-slot.filled{border-style:solid;border-color:var(--pickup);}
.main-visual-slot img{width:100%;height:140px;object-fit:cover;}
.main-visual-slot .mv-label{position:absolute;bottom:0;left:0;right:0;background:rgba(245,158,11,.85);color:#000;font-size:11px;font-weight:900;text-align:center;padding:4px;z-index:5;}
.main-visual-slot .mv-del{position:absolute;top:6px;right:6px;background:rgba(239,68,68,.9);color:#fff;border:none;border-radius:50%;width:26px;height:26px;font-size:13px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;}
.main-visual-slot .mv-empty{text-align:center;padding:20px;color:var(--text2);}
.main-visual-slot .mv-empty .mvi{font-size:28px;margin-bottom:6px;}
.main-visual-slot .mv-empty .mvt{font-size:13px;font-weight:700;}
.main-visual-slot .mv-empty .mvs{font-size:11px;color:var(--text2);margin-top:3px;}

/* PAIR CARD */
.pair-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px;}
.pair-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.pair-card-num{font-size:12px;font-weight:900;color:var(--text2);}
.pair-card-del{background:none;border:none;color:var(--danger);font-size:20px;cursor:pointer;padding:0;line-height:1;}
.pair-slots{display:flex;gap:6px;}
.pair-slot{flex:1;border:2px dashed var(--border);border-radius:10px;min-height:90px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.pair-slot.filled{border-style:solid;}
.pair-slot.filled.before{border-color:var(--before);}
.pair-slot.filled.after{border-color:var(--after);}
.pair-slot img{width:100%;height:100px;object-fit:cover;}
.pair-slot .ps-label{position:absolute;bottom:0;left:0;right:0;font-size:10px;font-weight:700;text-align:center;padding:3px 0;}
.ps-before{background:rgba(74,158,255,.85);}
.ps-after{background:rgba(34,197,94,.85);color:#000;}
.pair-slot .ps-empty{text-align:center;padding:16px 8px;color:var(--text2);font-size:11px;}
.pair-slot .ps-del{position:absolute;top:4px;right:4px;background:rgba(239,68,68,.9);color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:11px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;}

/* PICKUP GRID */
.pickup-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px;}
.pickup-item{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;border:3px solid var(--pickup);}
.pickup-item img{width:100%;height:100%;object-fit:cover;}
.pickup-item .pk-del{position:absolute;top:4px;right:4px;background:rgba(239,68,68,.9);color:#fff;border:none;border-radius:50%;width:22px;height:22px;font-size:11px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;}
.pickup-count{font-size:12px;color:var(--pickup);font-weight:700;margin-bottom:8px;}
.pickup-max{font-size:11px;color:var(--text2);}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:200;align-items:flex-end;padding:12px;}
.modal-overlay.active{display:flex;}
.modal{background:var(--surface);border-radius:20px;padding:20px;width:100%;max-height:85vh;overflow-y:auto;}
.modal-title{font-size:17px;font-weight:900;margin-bottom:4px;}
.modal-sub{font-size:12px;color:var(--text2);margin-bottom:16px;}
.modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:16px;}
.modal-photo{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden;border:3px solid transparent;cursor:pointer;}
.modal-photo img{width:100%;height:100%;object-fit:cover;}
.modal-photo.selected{border-color:var(--accent);}
.modal-photo .mp-chk{position:absolute;top:4px;right:4px;width:22px;height:22px;border-radius:50%;background:var(--accent);display:none;align-items:center;justify-content:center;font-size:12px;color:#000;font-weight:900;}
.modal-photo.selected .mp-chk{display:flex;}
.modal-photo .mp-badge{position:absolute;bottom:0;left:0;right:0;font-size:9px;text-align:center;padding:2px;font-weight:700;}

/* INFO BOX */
.info-box{background:rgba(232,160,32,.08);border:1px solid rgba(232,160,32,.25);border-radius:10px;padding:12px 14px;font-size:13px;line-height:1.6;margin-bottom:16px;color:var(--text2);}
.info-box strong{color:var(--accent);}

/* PREVIEW */
.preview-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;margin-bottom:16px;}
.preview-card-hd{background:var(--accent);color:#000;padding:10px 16px;font-size:12px;font-weight:900;letter-spacing:1px;}
.preview-row{display:flex;padding:10px 16px;border-bottom:1px solid var(--border);gap:12px;}
.preview-row:last-child{border-bottom:none;}
.pk{font-size:12px;color:var(--text2);font-weight:700;width:88px;flex-shrink:0;}
.pv{font-size:14px;line-height:1.5;flex:1;}
.report-box{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;font-size:13px;line-height:1.9;white-space:pre-wrap;margin-bottom:12px;}

.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--accent);color:#000;padding:12px 24px;border-radius:100px;font-size:14px;font-weight:700;z-index:999;transition:transform .3s;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}

.gap10{display:flex;flex-direction:column;gap:10px;}
input[type="file"]{display:none;}
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="logo">RS-Reporter Pro</div>
    <div class="logo-sub">è·äººã®3ç§’ã‚’ã€ä¼šç¤¾ã®è³‡ç”£ã«å¤‰ãˆã‚‹</div>
  </div>
  <button class="btn btn-ghost btn-sm" style="width:auto;padding:10px 14px;" onclick="openModal('modal-history')">ğŸ“‹ ç¾å ´ä¸€è¦§</button>
</div>
<div class="toast" id="toast"></div>

<!-- HOME -->
<div id="s-home" class="screen active">
  <div class="hero">
    <div class="hero-tag">RollerStone æ–½å·¥å ±å‘Š</div>
    <div class="hero-title">ç¾å ´ã‚’ã¯ã˜ã‚ã‚‹<br><span>3ã‚¿ãƒƒãƒ—ã§å ±å‘Šå®Œäº†</span></div>
    <button class="btn btn-primary" onclick="newSite()">ï¼‹ æ–°ã—ã„ç¾å ´ã‚’ä½œæˆ</button>
  </div>
  <div class="sec-title">ä¿å­˜æ¸ˆã¿ã®ç¾å ´</div>
  <div class="site-list" id="site-list"></div>
</div>

<!-- STEP1 -->
<div id="s-step1" class="screen">
  <button class="back-btn" onclick="goHome()">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:20px;">STEP 1 ï¼ ç¾å ´æƒ…å ±</div>
  <div class="form-group">
    <label class="form-label">ç¾å ´å <span class="opt">â€»ä»»æ„</span></label>
    <input type="text" class="form-input" id="f-name" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜é‚¸ é§è»Šå ´">
  </div>
  <div class="form-group">
    <label class="form-label">æ‹…å½“è€…å</label>
    <input type="text" class="form-input" id="f-worker" placeholder="ä¾‹ï¼šå±±ç”°">
  </div>
  <button class="btn btn-primary" onclick="saveStep1()">å†™çœŸã‚’è¿½åŠ ã™ã‚‹ â†’</button>
</div>

<!-- STEP2: å†™çœŸ -->
<div id="s-step2" class="screen">
  <button class="back-btn" onclick="showScreen('s-step1')">â† ç¾å ´æƒ…å ±ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:6px;">STEP 2 ï¼ å†™çœŸã‚’è¿½åŠ </div>
  <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">ã‚¿ã‚°ã‚’é¸ã‚“ã§ã‹ã‚‰å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‚ä½•åº¦ã§ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚</p>

  <div class="tag-bar">
    <button class="tag-btn t-before active" id="tagbtn-before" onclick="selectTag('before',this)"><span class="ti">ğŸ“·</span>Before</button>
    <button class="tag-btn t-during" id="tagbtn-during" onclick="selectTag('during',this)"><span class="ti">ğŸ”¨</span>é€ å½¢å¾Œ</button>
    <button class="tag-btn t-after" id="tagbtn-after" onclick="selectTag('after',this)"><span class="ti">âœ¨</span>After</button>
    <button class="tag-btn t-pickup" id="tagbtn-pickup" onclick="selectTag('pickup',this)"><span class="ti">â­</span>ã“ã ã‚ã‚Š</button>
  </div>

  <label class="upload-zone" for="file-input" style="display:block;cursor:pointer;">
    <div class="ui">ğŸ“</div>
    <div class="ut">å†™çœŸã‚’è¿½åŠ </div>
    <div class="us">ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰</div>
    <div class="tag-hint" id="upload-tag-hint">é¸æŠä¸­ï¼šBefore</div>
  </label>
  <input type="file" id="file-input" accept="image/*" multiple onchange="handleFiles(this.files)" style="position:absolute;width:1px;height:1px;opacity:0;pointer-events:none;">

  <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
  <div id="sort-area" style="display:none;">
    <div class="sort-bar" id="sort-bar"></div>
    <div id="sorted-photos"></div>
  </div>

  <div class="gap10" style="margin-top:24px;">
    <button class="btn btn-primary" onclick="goStep3()">å ±å‘Šæ›¸ã‚’ä½œæˆã™ã‚‹ â†’</button>
  </div>
</div>

<!-- STEP3 -->
<div id="s-step3" class="screen">
  <button class="back-btn" onclick="showScreen('s-step2')">â† å†™çœŸç”»é¢ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:20px;">STEP 3 ï¼ å ±å‘Šæ›¸</div>

  <!-- Instagramç”¨ã‚»ãƒƒãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨ãƒ»å°†æ¥çš„ã«è¡¨ç¤ºï¼‰ -->
  <div class="ig-section" id="ig-section">
    <div class="ig-header">
      <span class="ig-icon">ğŸ“¸</span>
      <div><div class="ig-title">Instagram æŠ•ç¨¿ã‚»ãƒƒãƒˆ</div><div class="ig-sub">Phase 3 é€£æºç”¨ãƒ‡ãƒ¼ã‚¿ï¼ˆä»Šã¯ä¿å­˜ã®ã¿ï¼‰</div></div>
      <span class="ig-badge">æº–å‚™ä¸­</span>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« -->
    <div style="font-size:12px;font-weight:700;color:var(--pickup);margin-bottom:8px;">â‘  ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ï¼ˆ1æšï¼‰</div>
    <div class="main-visual-slot" id="mv-slot" onclick="openModal('modal-mv')">
      <div class="mv-empty"><div class="mvi">ğŸŒŸ</div><div class="mvt">ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’é¸ã¶</div><div class="mvs">å…¨å†™çœŸã‹ã‚‰1æšé¸æŠ</div></div>
    </div>

    <!-- Before/After ãƒšã‚¢ -->
    <div style="font-size:12px;font-weight:700;color:var(--pickup);margin:14px 0 8px;">â‘¡ Before / After ãƒšã‚¢</div>
    <div id="pair-list"></div>
    <button class="btn btn-add" onclick="addPair()">ï¼‹ ãƒšã‚¢ã‚’è¿½åŠ </button>

    <!-- ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆ -->
    <div style="font-size:12px;font-weight:700;color:var(--pickup);margin:14px 0 6px;">â‘¢ ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆ</div>
    <div class="pickup-count" id="pickup-count">0 / 20æš</div>
    <div class="pickup-grid" id="pickup-grid"></div>
    <button class="btn btn-add" style="margin-top:8px;" onclick="openModal('modal-pickup')">ï¼‹ ã“ã ã‚ã‚Šå†™çœŸã‚’è¿½åŠ </button>
  </div>

  <div class="divider"></div>

  <div class="form-group">
    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« <span class="opt">SNSç”¨ãƒ»ä»»æ„</span></label>
    <div class="chips" id="title-chips">
      <button class="chip" onclick="titleChip(this,'ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥')">ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥</button>
      <button class="chip" onclick="titleChip(this,'é§è»Šå ´æ–½å·¥')">é§è»Šå ´æ–½å·¥</button>
      <button class="chip" onclick="titleChip(this,'ã‚¿ã‚¤ãƒ«ãƒ‡ãƒƒã‚­æ–½å·¥')">ã‚¿ã‚¤ãƒ«ãƒ‡ãƒƒã‚­æ–½å·¥</button>
      <button class="chip" onclick="titleChip(this,'å¤–æ§‹æ–½å·¥')">å¤–æ§‹æ–½å·¥</button>
    </div>
    <input type="text" class="form-input" id="f-title" placeholder="ãã®ä»–ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" style="margin-top:8px;" oninput="clearTitleChips()">
  </div>
  <div class="input-row">
    <div class="form-group" style="flex:1;">
      <label class="form-label">è¦æ¨¡</label>
      <div class="unit-wrap"><input type="number" class="form-input" id="f-area" placeholder="25"><span class="unit">ã¡</span></div>
    </div>
    <div class="form-group" style="flex:1;">
      <label class="form-label">æ–½å·¥æ—¥æ•°</label>
      <div class="unit-wrap"><input type="number" class="form-input" id="f-days" placeholder="3"><span class="unit">æ—¥</span></div>
    </div>
  </div>
  <div class="form-group">
    <label class="form-label">ä¸‹åœ°å‡¦ç†</label>
    <div class="chips">
      <button class="chip" id="chip-base-y" onclick="singleChip('f-base','ã‚ã‚Š',['chip-base-y','chip-base-n'])">ã‚ã‚Š</button>
      <button class="chip" id="chip-base-n" onclick="singleChip('f-base','ãªã—',['chip-base-y','chip-base-n'])">ãªã—</button>
    </div>
    <input type="hidden" id="f-base">
    <input type="text" class="form-input" id="f-base-detail" placeholder="è©³ç´°ï¼ˆä¾‹ï¼šã‚±ãƒ¬ãƒ³å‡¦ç†ï¼‰" style="margin-top:8px;">
  </div>
  <div class="form-group">
    <label class="form-label">ãƒ‘ã‚¿ãƒ¼ãƒ³ <span class="opt">è¤‡æ•°å¯</span></label>
    <div class="chips" id="chips-pat">
      <button class="chip" onclick="multiChip(this,'pat')">ä¹±å½¢çŸ³èª¿</button>
      <button class="chip" onclick="multiChip(this,'pat')">ã‚¿ã‚¤ãƒ«èª¿</button>
      <button class="chip" onclick="multiChip(this,'pat')">ç‰¹æ®Šãƒ»ãƒ­ã‚´</button>
      <button class="chip" onclick="multiChip(this,'pat')">ãã®ä»–</button>
    </div>
    <input type="text" class="form-input" id="f-pat-custom" placeholder="ãã®ä»–ï¼ˆä»»æ„ï¼‰" style="margin-top:8px;">
  </div>
  <div class="form-group">
    <label class="form-label">ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ <span class="opt">è¤‡æ•°å¯</span></label>
    <div class="chips" id="chips-col">
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#6b7280;display:inline-block;flex-shrink:0;"></span>ã‚°ãƒ¬ãƒ¼</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#111827;display:inline-block;flex-shrink:0;"></span>ãƒ–ãƒ©ãƒƒã‚¯</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#d4b896;display:inline-block;flex-shrink:0;"></span>ã‚¤ã‚¨ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¸ãƒ¥</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#c8a882;display:inline-block;flex-shrink:0;"></span>ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#f97316;display:inline-block;flex-shrink:0;"></span>ã‚ªãƒ¬ãƒ³ã‚¸</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#4d7c5f;display:inline-block;flex-shrink:0;"></span>ãƒ¢ã‚¹ã‚°ãƒªãƒ¼ãƒ³</button>
    </div>
    <input type="text" class="form-input" id="f-col-custom" placeholder="ãã®ä»–ã®ã‚«ãƒ©ãƒ¼ï¼ˆä»»æ„ï¼‰" style="margin-top:8px;">
  </div>
  <div class="form-group">
    <label class="form-label">ç›®åœ°ã‚«ãƒ©ãƒ¼</label>
    <input type="text" class="form-input" id="f-grout" placeholder="ä¾‹ï¼šãƒ›ãƒ¯ã‚¤ãƒˆã€ã‚°ãƒ¬ãƒ¼">
  </div>
  <div class="form-group">
    <label class="form-label">ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ <span class="opt">SNSç”¨</span></label>
    <textarea class="form-input" id="f-kodawari" placeholder="ä¾‹ï¼šç›®åœ°ã‚’ç´°ãã—ã¦é«˜ç´šæ„Ÿã‚’å‡ºã—ãŸã€‚çŸ³ã®å‘ãã‚’æƒãˆã¦æ•´ç„¶ã¨ã—ãŸå°è±¡ã«ã€‚"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">ãŠå®¢æ§˜ã®å£° <span class="opt">SNSç”¨</span></label>
    <textarea class="form-input" id="f-voice" placeholder="ä¾‹ï¼šã€Œæƒ³åƒä»¥ä¸Šã®ä»•ä¸ŠãŒã‚Šã§å¤§æº€è¶³ã§ã™ã€"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">ãŠå®¢æ§˜ã®ãŠæ‚©ã¿ <span class="opt">SNSç”¨ãƒ»ä»»æ„</span></label>
    <textarea class="form-input" id="f-pain" placeholder="ä¾‹ï¼šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãŒå‘³æ°—ãªãã¦ãŠã—ã‚ƒã‚Œã«ã—ãŸã‹ã£ãŸ"></textarea>
  </div>
  <div class="form-group">
    <label class="form-label">ãã®ä»–</label>
    <textarea class="form-input" id="f-memo" placeholder="è‡ªç”±è¨˜å…¥"></textarea>
  </div>
  <button class="btn btn-primary" onclick="saveStep3()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã™ã‚‹ â†’</button>
</div>

<!-- PREVIEW -->
<div id="s-preview" class="screen">
  <button class="back-btn" onclick="showScreen('s-step3')">â† å ±å‘Šæ›¸ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:16px;">å ±å‘Šæ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
  <div id="preview-content"></div>
  <div class="info-box"><strong>2ã‚¹ãƒ†ãƒƒãƒ—ã§é€ä»˜</strong><br>â‘  ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ â†’ LINEã«è²¼ã‚Šä»˜ã‘<br>â‘¡ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ LINEã«æ·»ä»˜</div>
  <div class="gap10" style="margin-bottom:12px;">
    <button class="btn btn-primary" onclick="copyText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    <button class="btn btn-secondary" onclick="downloadZip()">ğŸ“¦ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  </div>
  <div class="gap10">
    <button class="btn btn-ghost btn-sm" onclick="showScreen('s-step2')">â† å†™çœŸã‚’è¿½åŠ ãƒ»ä¿®æ­£</button>
    <button class="btn btn-danger btn-sm" onclick="deleteSite()">ğŸ—‘ ã“ã®ç¾å ´ã‚’å‰Šé™¤</button>
  </div>
</div>

<!-- MODAL: ç¾å ´ä¸€è¦§ -->
<div class="modal-overlay" id="modal-history">
  <div class="modal">
    <div class="modal-title">ğŸ“‹ ç¾å ´ä¸€è¦§</div>
    <div id="modal-site-list" class="gap10"></div>
    <div style="margin-top:16px;"><button class="btn btn-ghost" onclick="closeModal('modal-history')">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<!-- MODAL: ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«é¸æŠ -->
<div class="modal-overlay" id="modal-mv">
  <div class="modal">
    <div class="modal-title">ğŸŒŸ ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«</div>
    <div class="modal-sub">å…¨å†™çœŸã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„</div>
    <div class="modal-grid" id="modal-mv-grid"></div>
    <button class="btn btn-ghost" onclick="closeModal('modal-mv')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- MODAL: ãƒšã‚¢å†™çœŸé¸æŠ -->
<div class="modal-overlay" id="modal-pair">
  <div class="modal">
    <div class="modal-title" id="modal-pair-title">å†™çœŸã‚’é¸æŠ</div>
    <div class="modal-sub" id="modal-pair-sub"></div>
    <div class="modal-grid" id="modal-pair-grid"></div>
    <button class="btn btn-ghost" onclick="closeModal('modal-pair')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<!-- MODAL: ã“ã ã‚ã‚Šè¿½åŠ  -->
<div class="modal-overlay" id="modal-pickup">
  <div class="modal">
    <div class="modal-title">â­ ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆ</div>
    <div class="modal-sub" id="modal-pickup-sub">ã‚¿ãƒƒãƒ—ã—ã¦è¿½åŠ ï¼ˆè¤‡æ•°å¯ï¼‰</div>
    <div class="modal-grid" id="modal-pickup-grid"></div>
    <button class="btn btn-primary" style="margin-bottom:8px;" onclick="confirmPickup()">è¿½åŠ ã™ã‚‹</button>
    <button class="btn btn-ghost" onclick="closeModal('modal-pickup')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
// ========== STATE ==========
const PICKUP_MAX = 20;
let siteId = null;
let currentTag = 'before';
let sites = {};
let patSel = new Set();
let colSel = new Set();
let activeSorts = new Set(['all']);
// ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ä¸€æ™‚å¤‰æ•°
let modalPairIndex = null;
let modalPairSlot = null; // 'before'|'after'
let modalPickupTmp = new Set();

// ========== INIT ==========
function init() {
  const s = localStorage.getItem('rs-pro-v3');
  if (s) try { sites = JSON.parse(s); } catch(e){}
  renderHome();
  injectDemoIfFirstTime();
}
function persist() { localStorage.setItem('rs-pro-v3', JSON.stringify(sites)); }

// ========== DEMO ==========
function mkImg(color, label, w, h) {
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  const ctx = c.getContext('2d');
  ctx.fillStyle=color; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='rgba(255,255,255,0.07)'; ctx.lineWidth=1;
  for(let x=0;x<w;x+=22){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let y=0;y<h;y+=22){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  ctx.fillStyle='rgba(255,255,255,0.8)';
  ctx.font=`bold ${Math.min(w,h)*0.1}px sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(label,w/2,h/2);
  return c.toDataURL('image/jpeg',0.7);
}
function injectDemoIfFirstTime() {
  if (localStorage.getItem('rs-demo-v3')) return;
  const id = 'demo_'+Date.now();
  const photos = [
    {tag:'before',dataUrl:mkImg('#243040','Beforeâ‘ ',600,900),orientation:'portrait',selected:true},
    {tag:'before',dataUrl:mkImg('#243040','Beforeâ‘¡',900,600),orientation:'landscape',selected:true},
    {tag:'before',dataUrl:mkImg('#243040','Beforeâ‘¢',600,900),orientation:'portrait',selected:false},
    {tag:'during',dataUrl:mkImg('#2d1a40','é€ å½¢å¾Œâ‘ ',600,900),orientation:'portrait',selected:true},
    {tag:'during',dataUrl:mkImg('#2d1a40','é€ å½¢å¾Œâ‘¡',900,600),orientation:'landscape',selected:true},
    {tag:'after', dataUrl:mkImg('#0e3020','Afterâ‘ ',600,900),orientation:'portrait',selected:true},
    {tag:'after', dataUrl:mkImg('#0e3020','Afterâ‘¡',600,900),orientation:'portrait',selected:true},
    {tag:'after', dataUrl:mkImg('#0e3020','Afterâ‘¢',900,600),orientation:'landscape',selected:true},
    {tag:'after', dataUrl:mkImg('#0e3020','Afterâ‘£',600,900),orientation:'portrait',selected:false},
    {tag:'pickup',dataUrl:mkImg('#402800','ã“ã ã‚ã‚Šâ‘ ',900,600),orientation:'landscape',selected:true},
    {tag:'pickup',dataUrl:mkImg('#402800','ã“ã ã‚ã‚Šâ‘¡',600,900),orientation:'portrait',selected:true},
    {tag:'pickup',dataUrl:mkImg('#402800','ã“ã ã‚ã‚Šâ‘¢',600,900),orientation:'portrait',selected:true},
  ].map((p,i)=>({...p,id:'dp_'+i}));

  sites[id] = {
    info:{name:'ç”°ä¸­æ§˜é‚¸ é§è»Šå ´',worker:'å±±ç”°',date:new Date().toLocaleDateString('ja-JP'),
      title:'ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥',area:'25',days:'3',base:'ã‚ã‚Š',baseDetail:'ã‚±ãƒ¬ãƒ³å‡¦ç†',
      patterns:['ä¹±å½¢çŸ³èª¿'],patCustom:'',colors:['ã‚°ãƒ¬ãƒ¼','ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼'],colCustom:'',
      grout:'ãƒ›ãƒ¯ã‚¤ãƒˆ',
      kodawari:'ç›®åœ°å¹…ã‚’3mmã«çµ±ä¸€ã—ã€ä¸Šè³ªãªä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã€‚çŸ³ã®å‘ãã‚’æƒãˆã¦æ•´ç„¶ã¨ã—ãŸå°è±¡ã«ã€‚',
      voice:'ã€Œæƒ³åƒä»¥ä¸Šã®ä»•ä¸ŠãŒã‚Šã§å¤§æº€è¶³ã§ã™ï¼è¿‘æ‰€ã®æ–¹ã«ã‚‚è¤’ã‚ã‚‰ã‚Œã¾ã—ãŸã€',
      pain:'ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãŒå‘³æ°—ãªãã¦ãŠã—ã‚ƒã‚Œã«ã—ãŸã‹ã£ãŸ',memo:''},
    photos,
    ig:{ mainVisual:null, pairs:[], pickup:[] },
  };
  persist();
  localStorage.setItem('rs-demo-v3','1');
  siteId = id; renderHome(); renderPhotoSections(); showScreen('s-step2');
  setTimeout(()=>showToast('ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§æ“ä½œç¢ºèªã§ãã¾ã™'),600);
}

// ========== NAV ==========
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}
function goHome(){ siteId=null; renderHome(); showScreen('s-home'); }

// ========== HOME ==========
function renderHome(){
  const el=document.getElementById('site-list');
  const ids=Object.keys(sites).reverse();
  if(!ids.length){
    el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ—ï¸</div><div>ã¾ã ç¾å ´ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';return;
  }
  el.innerHTML=ids.map(id=>{
    const info=sites[id].info||{};
    const photos=sites[id].photos||[];
    const bc=photos.filter(p=>p.tag==='before').length;
    const dc=photos.filter(p=>p.tag==='during').length;
    const ac=photos.filter(p=>p.tag==='after').length;
    const pc=photos.filter(p=>p.tag==='pickup').length;
    return `<div class="site-card">
      <div style="flex:1;min-width:0;cursor:pointer;" onclick="openSite('${id}')">
        <div class="site-name">${info.name||'ï¼ˆåå‰ãªã—ï¼‰'}</div>
        <div class="site-meta">${[info.worker,info.date].filter(Boolean).join(' Â· ')}</div>
        <div class="badges" style="justify-content:flex-start;margin-top:6px;">
          ${bc?`<span class="badge b-before">å‰${bc}</span>`:''}
          ${dc?`<span class="badge b-during">ä¸­${dc}</span>`:''}
          ${ac?`<span class="badge b-after">å¾Œ${ac}</span>`:''}
          ${pc?`<span class="badge b-pickup">â­${pc}</span>`:''}
          <span class="badge b-gray">${photos.length}æš</span>
        </div>
      </div>
      <button onclick="deleteSiteFromHome('${id}',event)" style="background:none;border:none;color:var(--danger);font-size:22px;cursor:pointer;padding:8px;flex-shrink:0;line-height:1;">ğŸ—‘</button>
    </div>`;
  }).join('');
}

// ========== SITE ==========
function newSite(){
  siteId='site_'+Date.now();
  sites[siteId]={info:{date:new Date().toLocaleDateString('ja-JP')},photos:[],ig:{mainVisual:null,pairs:[],pickup:[]}};
  document.getElementById('f-name').value='';
  document.getElementById('f-worker').value='';
  showScreen('s-step1');
}
function openSite(id){
  siteId=id;
  if(!sites[id].ig) sites[id].ig={mainVisual:null,pairs:[],pickup:[]};
  const info=sites[id].info||{};
  document.getElementById('f-name').value=info.name||'';
  document.getElementById('f-worker').value=info.worker||'';
  loadStep3Fields(info);
  closeModal('modal-history');
  renderPhotoSections();
  showScreen('s-step2');
}
function saveStep1(){
  if(!sites[siteId]) return;
  sites[siteId].info.name=document.getElementById('f-name').value;
  sites[siteId].info.worker=document.getElementById('f-worker').value;
  persist(); renderPhotoSections(); showScreen('s-step2');
}

// ========== CHIPS ==========
function singleChip(hidId,val,chipIds){
  chipIds.forEach(cid=>document.getElementById(cid).classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById(hidId).value=val;
}
function multiChip(el,group){
  const label=el.innerText.trim();
  const sel=group==='pat'?patSel:colSel;
  if(el.classList.contains('active')){el.classList.remove('active');sel.delete(label);}
  else{el.classList.add('active');sel.add(label);}
}
function titleChip(el,val){
  document.querySelectorAll('#title-chips .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('f-title').value=val;
}
function clearTitleChips(){ document.querySelectorAll('#title-chips .chip').forEach(c=>c.classList.remove('active')); }

// ========== TAG SELECT ==========
function selectTag(tag,el){
  currentTag=tag;
  document.querySelectorAll('.tag-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  const labels={before:'Before',during:'é€ å½¢å¾Œ',after:'After',pickup:'ã“ã ã‚ã‚Š'};
  document.getElementById('upload-tag-hint').textContent='é¸æŠä¸­ï¼š'+labels[tag];
}

// ========== PHOTO UPLOAD ==========
function handleFiles(files){
  if(!siteId) return;
  const site=sites[siteId];
  if(!site.photos) site.photos=[];
  if(!site.ig) site.ig={mainVisual:null,pairs:[],pickup:[]};

  const readers=Array.from(files).map(file=>new Promise(resolve=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const img=new Image();
      img.onload=()=>{
        const photo={
          id:'p_'+Date.now()+'_'+Math.random().toString(36).slice(2),
          tag:currentTag, dataUrl:e.target.result,
          orientation:img.width>=img.height?'landscape':'portrait',
          selected:true,
        };
        site.photos.push(photo);
        // Phase2ç”¨ã‚®ãƒ£ãƒ©ãƒªãƒ¼DBã«ã‚‚è‡ªå‹•è“„ç©
        addToGalleryDB(photo, site.info);
        resolve();
      };
      img.src=e.target.result;
    };
    reader.readAsDataURL(file);
  }));
  Promise.all(readers).then(()=>{
    persist(); renderPhotoSections();
    document.getElementById('file-input').value='';
  });
}

// Phase2ã‚®ãƒ£ãƒ©ãƒªãƒ¼DBï¼ˆç¾å ´é–¢ä¿‚ãªãè“„ç©ï¼‰
function addToGalleryDB(photo, info){
  let db=[];
  try{ db=JSON.parse(localStorage.getItem('rs-gallery-v1')||'[]'); }catch(e){}
  db.push({
    id:photo.id, dataUrl:photo.dataUrl, tag:photo.tag,
    orientation:photo.orientation,
    patterns:info.patterns||[], colors:info.colors||[],
    date:info.date||'', site:info.name||'',
    savedAt:Date.now(),
  });
  // æœ€æ–°500æšã¾ã§ä¿æŒ
  if(db.length>500) db=db.slice(-500);
  try{ localStorage.setItem('rs-gallery-v1',JSON.stringify(db)); }catch(e){}
}

// ========== PHOTO DISPLAY ==========
function renderPhotoSections(){
  if(!siteId) return;
  const photos=sites[siteId].photos||[];
  const sortArea=document.getElementById('sort-area');
  if(!photos.length){ sortArea.style.display='none'; return; }
  sortArea.style.display='block';
  renderSortBar();
  renderSortedPhotos();
}

function renderSortBar(){
  const defs=[
    {key:'all',label:'ğŸ”€ å…¨ã¦'},
    {key:'pair',label:'ğŸ”— ãƒšã‚¢è¡¨ç¤º'},
    {key:'portrait',label:'ğŸ“± ç¸¦'},
    {key:'landscape',label:'ğŸ–¼ æ¨ª'},
    {key:'before',label:'ğŸ“· Before'},
    {key:'after',label:'âœ¨ After'},
    {key:'during',label:'ğŸ”¨ é€ å½¢å¾Œ'},
    {key:'pickup',label:'â­ ã“ã ã‚ã‚Š'},
  ];
  document.getElementById('sort-bar').innerHTML=defs.map(d=>
    `<button class="sort-chip${activeSorts.has(d.key)?' active':''}" data-sort="${d.key}" onclick="toggleSort('${d.key}',this)">${d.label}</button>`
  ).join('');
}

function toggleSort(key,el){
  if(key==='all'){
    activeSorts=new Set(['all']);
    document.querySelectorAll('.sort-chip').forEach(c=>c.classList.remove('active'));
    el.classList.add('active');
  } else {
    activeSorts.delete('all');
    document.querySelector('[data-sort="all"]')?.classList.remove('active');
    if(el.classList.contains('active')){
      el.classList.remove('active'); activeSorts.delete(key);
      if(activeSorts.size===0){activeSorts.add('all');document.querySelector('[data-sort="all"]')?.classList.add('active');}
    } else { el.classList.add('active'); activeSorts.add(key); }
  }
  renderSortedPhotos();
}

function photoCard(p){
  const tbMap={before:'tb-before',during:'tb-during',after:'tb-after',pickup:'tb-pickup'};
  const tlMap={before:'Before',during:'é€ å½¢å¾Œ',after:'After',pickup:'â­'};
  return `<div class="photo-item${p.selected?' selected':''} ${p.orientation}" id="pi-${p.id}">
    <img src="${p.dataUrl}" loading="lazy">
    <div class="chk">âœ“</div>
    <div class="ori">${p.orientation==='portrait'?'ç¸¦':'æ¨ª'}</div>
    <div class="del" onclick="delPhoto('${p.id}');event.stopPropagation()">âœ•</div>
    <div class="tag-badge ${tbMap[p.tag]}">${tlMap[p.tag]}</div>
    <div class="tap" onclick="toggleSel('${p.id}')"></div>
  </div>`;
}

function renderSortedPhotos(){
  if(!siteId) return;
  const all=sites[siteId].photos||[];
  const container=document.getElementById('sorted-photos');
  const selCount=all.filter(p=>p.selected).length;

  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <span style="font-size:13px;color:var(--text2);">è¨ˆ ${all.length}æš</span>
    <span style="font-size:12px;color:var(--accent);font-weight:700;">${selCount}æšé¸æŠä¸­</span>
  </div>`;

  if(activeSorts.has('pair')){
    html+=renderPairSection(all);
  } else {
    let photos=[...all];
    if(!activeSorts.has('all')){
      photos=photos.filter(p=>{
        let ok=false;
        if(activeSorts.has('portrait')&&p.orientation==='portrait') ok=true;
        if(activeSorts.has('landscape')&&p.orientation==='landscape') ok=true;
        if(activeSorts.has('before')&&p.tag==='before') ok=true;
        if(activeSorts.has('after')&&p.tag==='after') ok=true;
        if(activeSorts.has('during')&&p.tag==='during') ok=true;
        if(activeSorts.has('pickup')&&p.tag==='pickup') ok=true;
        return ok;
      });
    } else {
      photos.sort((a,b)=>({before:0,after:1,during:2,pickup:3}[a.tag]||0)-({before:0,after:1,during:2,pickup:3}[b.tag]||0));
    }
    html+=photos.length
      ?`<div class="photo-grid">${photos.map(p=>photoCard(p)).join('')}</div>`
      :`<div class="empty" style="padding:24px 0;"><div style="font-size:32px;">ğŸ”</div><div style="font-size:13px;">è©²å½“ã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
  }
  container.innerHTML=html;
}

function renderPairSection(all){
  // ç”»è§’ã”ã¨ã«ç¸¦/æ¨ªã§è‡ªå‹•ãƒšã‚¢ãƒªãƒ³ã‚°
  const bPort=all.filter(p=>p.tag==='before'&&p.orientation==='portrait');
  const bLand=all.filter(p=>p.tag==='before'&&p.orientation==='landscape');
  const aPort=all.filter(p=>p.tag==='after'&&p.orientation==='portrait');
  const aLand=all.filter(p=>p.tag==='after'&&p.orientation==='landscape');
  const during=all.filter(p=>p.tag==='during');
  const pickup=all.filter(p=>p.tag==='pickup');

  let html='';
  const maxP=Math.max(bPort.length,aPort.length);
  const maxL=Math.max(bLand.length,aLand.length);

  if(maxP>0){
    html+=`<div style="font-size:12px;color:var(--text2);margin-bottom:6px;border-left:3px solid var(--before);padding-left:6px;">ç¸¦ Before / After</div>`;
    for(let i=0;i<maxP;i++){
      html+=`<div class="pair-row">`;
      if(bPort[i]) html+=photoCard(bPort[i]);
      if(aPort[i]) html+=photoCard(aPort[i]);
      html+=`</div>`;
    }
  }
  if(maxL>0){
    html+=`<div style="font-size:12px;color:var(--text2);margin:10px 0 6px;border-left:3px solid var(--after);padding-left:6px;">æ¨ª Before / After</div>`;
    for(let i=0;i<maxL;i++){
      html+=`<div class="pair-row">`;
      if(bLand[i]) html+=photoCard(bLand[i]);
      if(aLand[i]) html+=photoCard(aLand[i]);
      html+=`</div>`;
    }
  }
  if(during.length){
    html+=`<div style="font-size:12px;color:var(--text2);margin:14px 0 6px;border-left:3px solid var(--during);padding-left:6px;">é€ å½¢å¾Œï¼ˆ${during.length}æšï¼‰</div>`;
    html+=`<div class="photo-grid">${during.map(p=>photoCard(p)).join('')}</div>`;
  }
  if(pickup.length){
    html+=`<div style="font-size:12px;color:var(--text2);margin:14px 0 6px;border-left:3px solid var(--pickup);padding-left:6px;">â­ ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆï¼ˆ${pickup.length}æšï¼‰</div>`;
    html+=`<div class="photo-grid">${pickup.map(p=>photoCard(p)).join('')}</div>`;
  }
  return html||`<div class="empty" style="padding:24px 0;"><div style="font-size:32px;">ğŸ“·</div><div style="font-size:13px;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
}

function toggleSel(id){
  const p=sites[siteId].photos.find(p=>p.id===id);
  if(p){p.selected=!p.selected;persist();renderSortedPhotos();
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°ã®ã¿å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    const all=sites[siteId].photos||[];
    const selCount=all.filter(p=>p.selected).length;
    const el=document.querySelector('#sorted-photos span[style*="accent"]');
    if(el) el.textContent=selCount+'æšé¸æŠä¸­';
  }
}
function delPhoto(id){
  sites[siteId].photos=sites[siteId].photos.filter(p=>p.id!==id);
  persist(); renderPhotoSections();
}

// ========== IG SECTION ==========
function renderIgSection(){
  if(!siteId) return;
  const ig=sites[siteId].ig||{mainVisual:null,pairs:[],pickup:[]};
  // ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«
  const mvSlot=document.getElementById('mv-slot');
  if(ig.mainVisual){
    const p=sites[siteId].photos.find(p=>p.id===ig.mainVisual);
    mvSlot.innerHTML=p
      ?`<img src="${p.dataUrl}"><div class="mv-label">ğŸŒŸ ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«</div><button class="mv-del" onclick="clearMV(event)">âœ•</button>`
      :`<div class="mv-empty"><div class="mvi">ğŸŒŸ</div><div class="mvt">ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’é¸ã¶</div><div class="mvs">å…¨å†™çœŸã‹ã‚‰1æšé¸æŠ</div></div>`;
    mvSlot.classList.toggle('filled',!!p);
  } else {
    mvSlot.innerHTML=`<div class="mv-empty"><div class="mvi">ğŸŒŸ</div><div class="mvt">ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ã‚’é¸ã¶</div><div class="mvs">å…¨å†™çœŸã‹ã‚‰1æšé¸æŠ</div></div>`;
    mvSlot.classList.remove('filled');
  }

  // ãƒšã‚¢ãƒªã‚¹ãƒˆ
  const pairList=document.getElementById('pair-list');
  pairList.innerHTML=(ig.pairs||[]).map((pair,i)=>{
    const bp=pair.before?sites[siteId].photos.find(p=>p.id===pair.before):null;
    const ap=pair.after?sites[siteId].photos.find(p=>p.id===pair.after):null;
    const ori=bp?.orientation||ap?.orientation||'';
    const oriLabel=ori==='portrait'?'ğŸ“± ç¸¦':ori==='landscape'?'ğŸ–¼ æ¨ª':'';
    return `<div class="pair-card">
      <div class="pair-card-header">
        <span class="pair-card-num">ãƒšã‚¢ ${i+1} <span style="font-size:11px;color:var(--text2);font-weight:400;">${oriLabel}</span></span>
        <button class="pair-card-del" onclick="removePair(${i})">Ã—</button>
      </div>
      <div class="pair-slots">
        <div class="pair-slot${bp?' filled before':''}" onclick="openPairModal(${i},'before')">
          ${bp
            ?`<img src="${bp.dataUrl}"><div class="ps-label ps-before">Before</div><button class="ps-del" onclick="clearPairSlot(${i},'before',event)">âœ•</button>`
            :`<div class="ps-empty"><div style="font-size:20px;">ğŸ“·</div><div>Beforeã‚’å¤‰æ›´</div></div>`}
        </div>
        <div class="pair-slot${ap?' filled after':''}" onclick="openPairModal(${i},'after')">
          ${ap
            ?`<img src="${ap.dataUrl}"><div class="ps-label ps-after">After</div><button class="ps-del" onclick="clearPairSlot(${i},'after',event)">âœ•</button>`
            :`<div class="ps-empty"><div style="font-size:20px;">âœ¨</div><div>Afterã‚’å¤‰æ›´</div></div>`}
        </div>
      </div>
    </div>`;
  }).join('');

  // ã“ã ã‚ã‚Šã‚°ãƒªãƒƒãƒ‰
  const pList=ig.pickup||[];
  document.getElementById('pickup-count').innerHTML=`<span style="color:var(--pickup);font-weight:900;">${pList.length}</span> / ${PICKUP_MAX}æš`;
  document.getElementById('pickup-grid').innerHTML=pList.map(pid=>{
    const p=sites[siteId].photos.find(p=>p.id===pid);
    return p?`<div class="pickup-item"><img src="${p.dataUrl}"><button class="pk-del" onclick="removePickup('${pid}')">âœ•</button></div>`:'';
  }).join('');
}

function clearMV(e){ e.stopPropagation(); sites[siteId].ig.mainVisual=null; persist(); renderIgSection(); }

function addPair(){
  const ig=sites[siteId].ig;
  const photos=sites[siteId].photos||[];

  // æ—¢ã«ãƒšã‚¢ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹IDã‚’åé›†
  const usedBefore=new Set((ig.pairs||[]).map(p=>p.before).filter(Boolean));
  const usedAfter=new Set((ig.pairs||[]).map(p=>p.after).filter(Boolean));

  // æœªä½¿ç”¨ã®Before/After ã‚’ç”»è§’åˆ¥ã«ç”¨æ„
  const bPort=photos.filter(p=>p.tag==='before'&&p.orientation==='portrait'&&!usedBefore.has(p.id));
  const bLand=photos.filter(p=>p.tag==='before'&&p.orientation==='landscape'&&!usedBefore.has(p.id));
  const aPort=photos.filter(p=>p.tag==='after'&&p.orientation==='portrait'&&!usedAfter.has(p.id));
  const aLand=photos.filter(p=>p.tag==='after'&&p.orientation==='landscape'&&!usedAfter.has(p.id));

  // ç¸¦ãƒšã‚¢ã‚’å„ªå…ˆã€ãªã‘ã‚Œã°æ¨ªãƒšã‚¢ã€ãªã‘ã‚Œã°ç‰‡æ–¹ã ã‘
  let newPair={before:null,after:null};
  if(bPort.length&&aPort.length){
    newPair={before:bPort[0].id, after:aPort[0].id};
  } else if(bLand.length&&aLand.length){
    newPair={before:bLand[0].id, after:aLand[0].id};
  } else if(bPort.length||aPort.length||bLand.length||aLand.length){
    // ç‰‡æ–¹ã ã‘æ®‹ã£ã¦ã„ã‚‹å ´åˆ
    newPair={
      before:(bPort[0]||bLand[0])?.id||null,
      after:(aPort[0]||aLand[0])?.id||null,
    };
    showToast('ç”»è§’ãŒæƒã†å†™çœŸãŒãªã‹ã£ãŸãŸã‚ç‰‡æ–¹ã®ã¿ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
  } else {
    showToast('è¿½åŠ ã§ãã‚‹Before/Afterå†™çœŸãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  if(!ig.pairs) ig.pairs=[];
  ig.pairs.push(newPair);
  persist(); renderIgSection();
}

function removePair(i){ sites[siteId].ig.pairs.splice(i,1); persist(); renderIgSection(); }
function clearPairSlot(i,slot,e){ e.stopPropagation(); sites[siteId].ig.pairs[i][slot]=null; persist(); renderIgSection(); }
function removePickup(pid){ sites[siteId].ig.pickup=sites[siteId].ig.pickup.filter(id=>id!==pid); persist(); renderIgSection(); }

// ========== MODALS ==========
function openModal(id){
  if(id==='modal-history'){
    const ids=Object.keys(sites).reverse();
    const el=document.getElementById('modal-site-list');
    if(!ids.length){ el.innerHTML='<div style="color:var(--text2);text-align:center;padding:20px;font-size:14px;">ç¾å ´ãŒã‚ã‚Šã¾ã›ã‚“</div>'; }
    else { el.innerHTML=ids.map(id=>{
      const info=sites[id].info||{};
      return `<button class="btn btn-secondary" onclick="openSite('${id}')" style="justify-content:flex-start;text-align:left;"><div>
        <div style="font-size:15px;font-weight:700;">${info.name||'ï¼ˆåå‰ãªã—ï¼‰'}</div>
        <div style="font-size:12px;color:var(--text2);">${[info.worker,info.date].filter(Boolean).join(' Â· ')}</div>
      </div></button>`;
    }).join(''); }
  }
  if(id==='modal-mv'){
    const photos=sites[siteId].photos||[];
    document.getElementById('modal-mv-grid').innerHTML=photos.map(p=>`
      <div class="modal-photo" onclick="selectMV('${p.id}')">
        <img src="${p.dataUrl}">
        <div class="mp-chk">âœ“</div>
        <div class="mp-badge ${p.tag==='before'?'tb-before':p.tag==='after'?'tb-after':p.tag==='during'?'tb-during':'tb-pickup'}">${{before:'B',after:'A',during:'é€ ',pickup:'â­'}[p.tag]}</div>
      </div>`).join('');
  }
  if(id==='modal-pickup'){
    const ig=sites[siteId].ig||{};
    const cur=new Set(ig.pickup||[]);
    const photos=(sites[siteId].photos||[]).filter(p=>p.tag==='pickup'||p.tag==='after');
    modalPickupTmp=new Set(cur);
    const rem=PICKUP_MAX-(ig.pickup||[]).length;
    document.getElementById('modal-pickup-sub').textContent=`æ®‹ã‚Š${rem}æšè¿½åŠ å¯èƒ½ï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠï¼‰`;
    document.getElementById('modal-pickup-grid').innerHTML=photos.map(p=>`
      <div class="modal-photo${cur.has(p.id)?' selected':''}" id="mpk-${p.id}" onclick="togglePickupTmp('${p.id}')">
        <img src="${p.dataUrl}">
        <div class="mp-chk">âœ“</div>
        <div class="mp-badge ${p.tag==='after'?'tb-after':'tb-pickup'}">${p.tag==='after'?'A':'â­'}</div>
      </div>`).join('');
  }
  document.getElementById(id).classList.add('active');
}

function selectMV(pid){ sites[siteId].ig.mainVisual=pid; persist(); renderIgSection(); closeModal('modal-mv'); }

function openPairModal(pairIndex,slot){
  modalPairIndex=pairIndex; modalPairSlot=slot;
  const tag=slot==='before'?'before':'after';
  const photos=(sites[siteId].photos||[]).filter(p=>p.tag===tag);
  document.getElementById('modal-pair-title').textContent=slot==='before'?'ğŸ“· Beforeå†™çœŸã‚’é¸æŠ':'âœ¨ Afterå†™çœŸã‚’é¸æŠ';
  document.getElementById('modal-pair-sub').textContent=slot==='before'?'Beforeã‚¿ã‚°ã®å†™çœŸ':'Afterã‚¿ã‚°ã®å†™çœŸ';
  document.getElementById('modal-pair-grid').innerHTML=photos.map(p=>`
    <div class="modal-photo" onclick="selectPairPhoto('${p.id}')">
      <img src="${p.dataUrl}">
      <div class="mp-chk">âœ“</div>
      <div class="mp-badge ${slot==='before'?'tb-before':'tb-after'}">${slot==='before'?'B':'A'}</div>
    </div>`).join('');
  document.getElementById('modal-pair').classList.add('active');
}

function selectPairPhoto(pid){
  sites[siteId].ig.pairs[modalPairIndex][modalPairSlot]=pid;
  persist(); renderIgSection(); closeModal('modal-pair');
}

function togglePickupTmp(pid){
  const ig=sites[siteId].ig||{pickup:[]};
  const already=modalPickupTmp.has(pid);
  if(already){ modalPickupTmp.delete(pid); }
  else {
    if(modalPickupTmp.size>=(ig.pickup||[]).length+PICKUP_MAX-(ig.pickup||[]).length){
      showToast(`æœ€å¤§${PICKUP_MAX}æšã§ã™`); return;
    }
    modalPickupTmp.add(pid);
  }
  document.getElementById('mpk-'+pid)?.classList.toggle('selected',!already);
}

function confirmPickup(){
  sites[siteId].ig.pickup=[...modalPickupTmp];
  persist(); renderIgSection(); closeModal('modal-pickup');
}

function closeModal(id){ document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active');}));

// ========== STEP3 ==========
function goStep3(){
  if(!siteId||!sites[siteId]){ showToast('ç¾å ´ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„'); return; }
  loadStep3Fields(sites[siteId].info||{});
  renderIgSection();
  showScreen('s-step3');
}

function loadStep3Fields(info){
  document.getElementById('f-title').value=info.title||'';
  document.getElementById('f-area').value=info.area||'';
  document.getElementById('f-days').value=info.days||'';
  document.getElementById('f-base').value=info.base||'';
  document.getElementById('f-base-detail').value=info.baseDetail||'';
  document.getElementById('f-pat-custom').value=info.patCustom||'';
  document.getElementById('f-col-custom').value=info.colCustom||'';
  document.getElementById('f-grout').value=info.grout||'';
  document.getElementById('f-kodawari').value=info.kodawari||'';
  document.getElementById('f-voice').value=info.voice||'';
  document.getElementById('f-pain').value=info.pain||'';
  document.getElementById('f-memo').value=info.memo||'';
  patSel=new Set(info.patterns||[]);
  colSel=new Set(info.colors||[]);
  ['chip-base-y','chip-base-n'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if(info.base==='ã‚ã‚Š') document.getElementById('chip-base-y').classList.add('active');
  if(info.base==='ãªã—') document.getElementById('chip-base-n').classList.add('active');
  document.querySelectorAll('#chips-pat .chip').forEach(el=>el.classList.toggle('active',patSel.has(el.innerText.trim())));
  document.querySelectorAll('#chips-col .chip').forEach(el=>el.classList.toggle('active',colSel.has(el.innerText.trim())));
  document.querySelectorAll('#title-chips .chip').forEach(el=>el.classList.toggle('active',el.innerText.trim()===info.title));
}

function saveStep3(){
  if(!siteId||!sites[siteId]){ showToast('ã‚¨ãƒ©ãƒ¼ï¼šç¾å ´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const info=sites[siteId].info||{};
  Object.assign(info,{
    title:document.getElementById('f-title').value,
    area:document.getElementById('f-area').value,
    days:document.getElementById('f-days').value,
    base:document.getElementById('f-base').value,
    baseDetail:document.getElementById('f-base-detail').value,
    patterns:[...patSel], patCustom:document.getElementById('f-pat-custom').value,
    colors:[...colSel], colCustom:document.getElementById('f-col-custom').value,
    grout:document.getElementById('f-grout').value,
    kodawari:document.getElementById('f-kodawari').value,
    voice:document.getElementById('f-voice').value,
    pain:document.getElementById('f-pain').value,
    memo:document.getElementById('f-memo').value,
  });
  sites[siteId].info=info;
  persist(); renderPreview(); showScreen('s-preview');
}

// ========== PREVIEW ==========
function buildText(){
  const info=sites[siteId].info||{};
  const photos=(sites[siteId].photos||[]).filter(p=>p.selected);
  const bc=photos.filter(p=>p.tag==='before').length;
  const dc=photos.filter(p=>p.tag==='during').length;
  const ac=photos.filter(p=>p.tag==='after').length;
  const pc=photos.filter(p=>p.tag==='pickup').length;
  const pats=[...(info.patterns||[]),info.patCustom].filter(Boolean).join(' / ');
  const cols=[...(info.colors||[]),info.colCustom].filter(Boolean).join(' / ');
  const base=info.base?(info.base+(info.baseDetail?`ï¼ˆ${info.baseDetail}ï¼‰`:'')):'';
  let t=`ã€æ–½å·¥å ±å‘Šã€‘RollerStone\n`;
  if(info.title) t+=`â—† ${info.title}\n`;
  t+=`â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  if(info.name) t+=`â–  ç¾å ´åï¼š${info.name}\n`;
  if(info.worker) t+=`â–  æ‹…å½“ï¼š${info.worker}\n`;
  if(info.date) t+=`â–  æ—¥ä»˜ï¼š${info.date}\n`;
  t+=`\n`;
  if(info.area) t+=`â–· è¦æ¨¡ï¼š${info.area}ã¡\n`;
  if(info.days) t+=`â–· æ–½å·¥æ—¥æ•°ï¼š${info.days}æ—¥\n`;
  if(base) t+=`â–· ä¸‹åœ°å‡¦ç†ï¼š${base}\n`;
  if(pats) t+=`â–· ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š${pats}\n`;
  if(cols) t+=`â–· ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ï¼š${cols}\n`;
  if(info.grout) t+=`â–· ç›®åœ°ã‚«ãƒ©ãƒ¼ï¼š${info.grout}\n`;
  t+=`\n`;
  if(info.kodawari) t+=`â˜… ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ\n${info.kodawari}\n\n`;
  if(info.voice) t+=`ğŸ’¬ ãŠå®¢æ§˜ã®å£°\n${info.voice}\n\n`;
  if(info.memo) t+=`ğŸ“ ãã®ä»–\n${info.memo}\n\n`;
  t+=`â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  t+=`ğŸ“· æ·»ä»˜ï¼š${photos.length}æšï¼ˆBefore:${bc} é€ å½¢å¾Œ:${dc} After:${ac}${pc?` â­:${pc}`:''}ï¼‰`;
  return t;
}

function renderPreview(){
  const info=sites[siteId].info||{};
  const photos=(sites[siteId].photos||[]).filter(p=>p.selected);
  const rows=[
    ['ã‚¿ã‚¤ãƒˆãƒ«',info.title],['ç¾å ´å',info.name],['æ‹…å½“è€…',info.worker],['æ—¥ä»˜',info.date],
    ['è¦æ¨¡',info.area?info.area+'ã¡':''],['æ–½å·¥æ—¥æ•°',info.days?info.days+'æ—¥':''],
    ['ä¸‹åœ°å‡¦ç†',info.base?(info.base+(info.baseDetail?`ï¼ˆ${info.baseDetail}ï¼‰`:'')):'' ],
    ['ãƒ‘ã‚¿ãƒ¼ãƒ³',[...(info.patterns||[]),info.patCustom].filter(Boolean).join(' / ')],
    ['ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼',[...(info.colors||[]),info.colCustom].filter(Boolean).join(' / ')],
    ['ç›®åœ°ã‚«ãƒ©ãƒ¼',info.grout],['ã“ã ã‚ã‚Š',info.kodawari],['ãŠå®¢æ§˜ã®å£°',info.voice],['ãŠæ‚©ã¿',info.pain],['ãã®ä»–',info.memo],
  ].filter(r=>r[1]);

  const bph=photos.filter(p=>p.tag==='before');
  const dph=photos.filter(p=>p.tag==='during');
  const aph=photos.filter(p=>p.tag==='after');
  const pph=photos.filter(p=>p.tag==='pickup');
  const maxLen=Math.max(bph.length,dph.length,aph.length);
  let pairs='';
  for(let i=0;i<maxLen;i++){
    const b=bph[i],d=dph[i],a=aph[i];
    if(!b&&!d&&!a) continue;
    pairs+=`<div style="display:flex;gap:4px;margin-bottom:5px;">`;
    if(b) pairs+=`<div style="flex:1;position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;"><img src="${b.dataUrl}" style="width:100%;height:100%;object-fit:cover;"><div style="position:absolute;bottom:0;left:0;right:0;background:rgba(74,158,255,.85);font-size:10px;font-weight:700;text-align:center;padding:3px;">Before</div></div>`;
    if(d) pairs+=`<div style="flex:1;position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;"><img src="${d.dataUrl}" style="width:100%;height:100%;object-fit:cover;"><div style="position:absolute;bottom:0;left:0;right:0;background:rgba(168,85,247,.85);font-size:10px;font-weight:700;text-align:center;padding:3px;">é€ å½¢å¾Œ</div></div>`;
    if(a) pairs+=`<div style="flex:1;position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;"><img src="${a.dataUrl}" style="width:100%;height:100%;object-fit:cover;"><div style="position:absolute;bottom:0;left:0;right:0;background:rgba(34,197,94,.85);font-size:10px;font-weight:700;text-align:center;padding:3px;color:#000;">After</div></div>`;
    pairs+=`</div>`;
  }
  let pickupGrid='';
  if(pph.length){
    pickupGrid=`<div class="sec-title" style="margin:16px 0 8px;">â­ ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆï¼ˆ${pph.length}æšï¼‰</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:5px;">${pph.map(p=>`<div style="aspect-ratio:1;border-radius:8px;overflow:hidden;"><img src="${p.dataUrl}" style="width:100%;height:100%;object-fit:cover;"></div>`).join('')}</div>`;
  }
  document.getElementById('preview-content').innerHTML=`
    <div class="preview-card">
      <div class="preview-card-hd">æ–½å·¥æƒ…å ±</div>
      ${rows.map(r=>`<div class="preview-row"><div class="pk">${r[0]}</div><div class="pv">${r[1]}</div></div>`).join('')}
    </div>
    <div class="sec-title" style="margin-bottom:8px;">é€ä»˜ãƒ†ã‚­ã‚¹ãƒˆ</div>
    <div class="report-box">${buildText()}</div>
    <div class="sec-title" style="margin-bottom:8px;">é¸æŠä¸­ã®å†™çœŸï¼ˆ${photos.length}æšï¼‰</div>
    ${pairs}${pickupGrid}<div class="divider"></div>`;
}

function copyText(){
  const text=buildText();
  if(navigator.clipboard){ navigator.clipboard.writeText(text).then(()=>showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼')); }
  else{ const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'); }
}

async function downloadZip(){
  const site=sites[siteId]; const info=site.info||{};
  const photos=(site.photos||[]).filter(p=>p.selected);
  if(!photos.length){ showToast('å†™çœŸãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  showToast('ZIPã‚’ä½œæˆä¸­...');
  const zip=new JSZip();
  const folders={before:zip.folder('Beforeï¼ˆæ–½å·¥å‰ï¼‰'),during:zip.folder('é€ å½¢å¾Œ'),after:zip.folder('Afterï¼ˆä»•ä¸Šã’å¾Œï¼‰'),pickup:zip.folder('ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆ')};
  const cnt={before:1,during:1,after:1,pickup:1};
  for(const p of photos){
    const ext=p.dataUrl.split(';')[0].split('/')[1]||'jpg';
    const fname=`${String(cnt[p.tag]).padStart(3,'0')}_${p.orientation==='portrait'?'ç¸¦':'æ¨ª'}.${ext}`;
    cnt[p.tag]++;
    const blob=await (await fetch(p.dataUrl)).blob();
    folders[p.tag].file(fname,blob);
  }
  zip.file('å ±å‘Šæ›¸.txt',buildText());
  const content=await zip.generateAsync({type:'blob'});
  const url=URL.createObjectURL(content);
  const a=document.createElement('a');
  a.href=url; a.download=`${info.name||'ç¾å ´'}_${(info.date||'').replace(/\//g,'-')}.zip`; a.click();
  URL.revokeObjectURL(url);
  showToast('ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
}

function deleteSiteFromHome(id, e){
  e.stopPropagation();
  const name = sites[id]?.info?.name || 'ï¼ˆåå‰ãªã—ï¼‰';
  if(!confirm(`ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå†™çœŸã‚‚å…¨ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) return;
  delete sites[id];
  persist(); renderHome();
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
}
function deleteSite(){
  if(!confirm('ã“ã®ç¾å ´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  delete sites[siteId]; persist(); siteId=null; renderHome(); showScreen('s-home'); showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

init();
</script>
</body>
</html>
