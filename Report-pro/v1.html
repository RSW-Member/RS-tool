<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RS-Reporter Pro</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Bebas+Neue&display=swap');

:root {
  --bg: #0f0f0f;
  --surface: #1a1a1a;
  --surface2: #242424;
  --border: #2e2e2e;
  --accent: #e8a020;
  --text: #f0f0f0;
  --text2: #888;
  --before: #4a9eff;
  --during: #a855f7;
  --after: #22c55e;
  --pickup: #f59e0b;
  --danger: #ef4444;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Noto Sans JP', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  padding-bottom: 40px;
}

.header {
  background: var(--surface);
  border-bottom: 2px solid var(--accent);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
}
.logo { font-family: 'Bebas Neue', sans-serif; font-size: 22px; letter-spacing: 2px; color: var(--accent); }
.logo-sub { font-size: 9px; color: var(--text2); letter-spacing: 1px; margin-top: 1px; }

.screen { display: none; padding: 20px 16px; }
.screen.active { display: block; }

.btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 16px 24px; border: none; border-radius: 12px;
  font-family: 'Noto Sans JP', sans-serif; font-size: 16px; font-weight: 700;
  cursor: pointer; transition: all 0.15s; min-height: 56px; width: 100%;
}
.btn:active { transform: scale(0.97); }
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
.btn-ghost { background: transparent; color: var(--text2); border: 1px solid var(--border); font-size: 14px; min-height: 44px; }
.btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); font-size: 14px; min-height: 44px; }
.btn-sm { min-height: 44px; font-size: 14px; padding: 10px 16px; border-radius: 8px; }

.back-btn {
  display: flex; align-items: center; gap: 6px; font-size: 14px; color: var(--text2);
  cursor: pointer; padding: 8px 0; margin-bottom: 16px; background: none; border: none;
  font-family: 'Noto Sans JP', sans-serif;
}

.form-group { margin-bottom: 22px; }
.form-label {
  display: block; font-size: 12px; font-weight: 700; color: var(--text2);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;
  border-left: 3px solid var(--accent); padding-left: 8px;
}
.form-label .opt { color: var(--text2); font-size: 10px; font-weight: 400; text-transform: none; letter-spacing: 0; }
.form-input {
  width: 100%; background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px; font-size: 16px; color: var(--text);
  font-family: 'Noto Sans JP', sans-serif; outline: none; transition: border-color 0.15s; min-height: 56px;
}
.form-input:focus { border-color: var(--accent); }
.form-input::placeholder { color: var(--text2); }
textarea.form-input { min-height: 90px; resize: none; line-height: 1.6; }

.input-row { display: flex; gap: 10px; }
.unit-wrap { position: relative; }
.unit-wrap .form-input { padding-right: 44px; }
.unit-wrap .unit { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text2); font-size: 14px; pointer-events: none; }

.chips { display: flex; flex-wrap: wrap; gap: 8px; }
.chip {
  padding: 10px 16px; border-radius: 100px; border: 1px solid var(--border);
  background: var(--surface); color: var(--text2); font-size: 14px; font-weight: 500;
  cursor: pointer; transition: all 0.15s; font-family: 'Noto Sans JP', sans-serif;
  min-height: 44px; display: flex; align-items: center; gap: 6px;
}
.chip.active { border-color: var(--accent); background: rgba(232,160,32,0.15); color: var(--accent); font-weight: 700; }

.hint { font-size: 12px; color: var(--text2); margin-top: 6px; line-height: 1.5; }
.hint em { color: var(--accent); font-style: normal; }

.sec-title {
  font-size: 11px; color: var(--text2); letter-spacing: 2px; text-transform: uppercase;
  margin-bottom: 12px; border-left: 3px solid var(--accent); padding-left: 8px;
}
.divider { height: 1px; background: var(--border); margin: 20px 0; }

/* HOME */
.hero {
  background: linear-gradient(135deg, var(--surface), #1e1a0e);
  border: 1px solid var(--accent); border-radius: 16px; padding: 24px; margin-bottom: 24px;
  position: relative; overflow: hidden;
}
.hero::before {
  content: 'RS'; font-family: 'Bebas Neue', sans-serif; font-size: 130px;
  color: rgba(232,160,32,0.05); position: absolute; right: -10px; top: -20px; line-height: 1;
}
.hero-tag { font-size: 11px; color: var(--accent); letter-spacing: 2px; margin-bottom: 8px; }
.hero-title { font-size: 20px; font-weight: 900; line-height: 1.4; margin-bottom: 20px; }
.hero-title span { color: var(--accent); }

.site-list { display: flex; flex-direction: column; gap: 10px; }
.site-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
  padding: 16px; cursor: pointer; transition: all 0.15s;
  display: flex; align-items: center; justify-content: space-between;
}
.site-card:active { border-color: var(--accent); }
.site-name { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
.site-meta { font-size: 12px; color: var(--text2); }
.badges { display: flex; gap: 5px; flex-wrap: wrap; justify-content: flex-end; max-width: 140px; }
.badge { font-size: 10px; padding: 3px 8px; border-radius: 20px; font-weight: 700; white-space: nowrap; }
.b-before { background: rgba(74,158,255,0.2); color: var(--before); }
.b-during { background: rgba(168,85,247,0.2); color: var(--during); }
.b-after { background: rgba(34,197,94,0.2); color: var(--after); }
.b-pickup { background: rgba(245,158,11,0.2); color: var(--pickup); }
.b-gray { background: var(--surface2); color: var(--text2); }

.empty { text-align: center; padding: 40px 20px; color: var(--text2); }
.empty-icon { font-size: 48px; margin-bottom: 12px; }

/* PHOTOS */
.tag-bar { display: flex; gap: 8px; margin-bottom: 14px; }
.tag-btn {
  flex: 1; padding: 12px 4px; border-radius: 12px; border: 2px solid transparent;
  background: var(--surface); font-size: 12px; font-weight: 700; cursor: pointer;
  transition: all 0.15s; font-family: 'Noto Sans JP', sans-serif;
  text-align: center; min-height: 60px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 4px;
}
.tag-btn .ti { font-size: 18px; }
.tag-btn.t-before { border-color: var(--before); color: var(--before); }
.tag-btn.t-during { border-color: var(--during); color: var(--during); }
.tag-btn.t-after { border-color: var(--after); color: var(--after); }
.tag-btn.t-pickup { border-color: var(--pickup); color: var(--pickup); }
.tag-btn.active.t-before { background: rgba(74,158,255,0.15); }
.tag-btn.active.t-during { background: rgba(168,85,247,0.15); }
.tag-btn.active.t-after { background: rgba(34,197,94,0.15); }
.tag-btn.active.t-pickup { background: rgba(245,158,11,0.15); }

.upload-zone {
  border: 2px dashed var(--border); border-radius: 16px; padding: 28px 20px;
  text-align: center; margin-bottom: 20px; cursor: pointer; background: var(--surface);
}
.upload-zone:active { border-color: var(--accent); }
.upload-zone .ui { font-size: 36px; margin-bottom: 8px; }
.upload-zone .ut { font-size: 16px; font-weight: 700; }
.upload-zone .us { font-size: 13px; color: var(--text2); margin-top: 4px; }

.photo-sec { margin-bottom: 20px; }
.photo-sec-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
.photo-sec-title { font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 6px; }
.dot10 { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.dot-before { background: var(--before); }
.dot-during { background: var(--during); }
.dot-after { background: var(--after); }
.dot-pickup { background: var(--pickup); }
.sel-count { font-size: 12px; color: var(--accent); font-weight: 700; }
.pickup-limit { font-size: 11px; color: var(--text2); font-weight: 400; }

/* SORT BAR */
.sort-bar { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 14px; }
.sort-chip {
  padding: 8px 14px; border-radius: 100px; border: 1px solid var(--border);
  background: var(--surface); color: var(--text2); font-size: 13px; font-weight: 600;
  cursor: pointer; font-family: 'Noto Sans JP', sans-serif; min-height: 40px;
  display: flex; align-items: center; gap: 5px; transition: all 0.15s;
}
.sort-chip.active { border-color: var(--accent); background: rgba(232,160,32,0.15); color: var(--accent); }

/* PAIR VIEW */
.pair-row { display: flex; gap: 6px; margin-bottom: 8px; }
.pair-row .photo-item { flex: 1; aspect-ratio: unset; }
.pair-row .photo-item.portrait  { height: 200px; }
.pair-row .photo-item.landscape { height: 130px; }
.pair-tag-label {
  position: absolute; bottom: 0; left: 0; right: 0;
  font-size: 10px; font-weight: 700; text-align: center; padding: 3px 0; z-index: 6;
}
.ptl-before { background: rgba(74,158,255,0.85); }
.ptl-after  { background: rgba(34,197,94,0.85); color:#000; }
.ptl-during { background: rgba(168,85,247,0.85); }
.ptl-pickup { background: rgba(245,158,11,0.85); color:#000; }

.photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
.photo-item {
  position: relative; aspect-ratio: 1; border-radius: 8px; overflow: hidden;
  border: 3px solid transparent; transition: all 0.2s; cursor: pointer;
}
.photo-item img {
  width: 100%; height: 100%; object-fit: cover; display: block;
  filter: grayscale(100%) brightness(0.6);
  transition: filter 0.2s;
}
.photo-item.selected { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(232,160,32,0.4); }
.photo-item.selected img { filter: none; }
.photo-item .chk {
  position: absolute; top: 5px; right: 5px; width: 22px; height: 22px;
  border-radius: 50%; background: var(--accent); display: none;
  align-items: center; justify-content: center; font-size: 12px; color: #000; font-weight: 900;
  z-index: 8;
}
.photo-item.selected .chk { display: flex; }
.photo-item .ori {
  position: absolute; bottom: 3px; left: 3px; font-size: 9px; padding: 2px 4px;
  border-radius: 3px; background: rgba(0,0,0,0.7); color: #fff; z-index: 8;
}
.photo-item .del {
  position: absolute; top: 5px; left: 5px; width: 22px; height: 22px;
  border-radius: 50%; background: rgba(239,68,68,0.9); display: flex;
  align-items: center; justify-content: center; font-size: 11px; color: #fff; z-index: 10; cursor: pointer;
}
.photo-item .tap { position: absolute; inset: 0; z-index: 5; cursor: pointer; }

/* PREVIEW */
.preview-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; margin-bottom: 16px; }
.preview-card-hd { background: var(--accent); color: #000; padding: 10px 16px; font-size: 12px; font-weight: 900; letter-spacing: 1px; }
.preview-row { display: flex; padding: 10px 16px; border-bottom: 1px solid var(--border); gap: 12px; }
.preview-row:last-child { border-bottom: none; }
.pk { font-size: 12px; color: var(--text2); font-weight: 700; width: 88px; flex-shrink: 0; }
.pv { font-size: 14px; line-height: 1.5; flex: 1; }

.report-box {
  background: var(--surface2); border: 1px solid var(--border); border-radius: 12px;
  padding: 16px; font-size: 13px; line-height: 1.9; white-space: pre-wrap; margin-bottom: 12px;
}
.photo-pair { display: flex; gap: 5px; margin-bottom: 5px; }
.pair-item { flex: 1; position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; }
.pair-item img { width: 100%; height: 100%; object-fit: cover; }
.pair-label { position: absolute; bottom: 0; left: 0; right: 0; padding: 3px 6px; font-size: 10px; font-weight: 700; text-align: center; }
.pl-before { background: rgba(74,158,255,0.85); }
.pl-during { background: rgba(168,85,247,0.85); }
.pl-after { background: rgba(34,197,94,0.85); color: #000; }
.pl-pickup { background: rgba(245,158,11,0.85); color: #000; }

.info-box {
  background: rgba(232,160,32,0.08); border: 1px solid rgba(232,160,32,0.25);
  border-radius: 10px; padding: 12px 14px; font-size: 13px; line-height: 1.6;
  margin-bottom: 16px; color: var(--text2);
}
.info-box strong { color: var(--accent); }

.gap10 { display: flex; flex-direction: column; gap: 10px; }

/* MODAL */
.modal-overlay {
  display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85);
  z-index: 200; align-items: flex-end; padding: 16px;
}
.modal-overlay.active { display: flex; }
.modal { background: var(--surface); border-radius: 20px; padding: 24px; width: 100%; max-height: 80vh; overflow-y: auto; }
.modal-title { font-size: 18px; font-weight: 900; margin-bottom: 16px; }

.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
  background: var(--accent); color: #000; padding: 12px 24px; border-radius: 100px;
  font-size: 14px; font-weight: 700; z-index: 999; transition: transform 0.3s; white-space: nowrap;
}
.toast.show { transform: translateX(-50%) translateY(0); }

input[type="file"] { display: none; }
</style>
</head>
<body>

<div class="header">
  <div>
    <div class="logo">RS-Reporter Pro</div>
    <div class="logo-sub">è·äººã®3ç§’ã‚’ã€ä¼šç¤¾ã®è³‡ç”£ã«å¤‰ãˆã‚‹</div>
  </div>
  <button class="btn btn-ghost btn-sm" style="width:auto;padding:10px 14px;" onclick="openModal('modal-history')">ğŸ“‹ ç¾å ´ä¸€è¦§</button>
</div>

<div class="toast" id="toast"></div>

<!-- HOME -->
<div id="s-home" class="screen active">
  <div class="hero">
    <div class="hero-tag">RollerStone æ–½å·¥å ±å‘Š</div>
    <div class="hero-title">ç¾å ´ã‚’ã¯ã˜ã‚ã‚‹<br><span>3ã‚¿ãƒƒãƒ—ã§å ±å‘Šå®Œäº†</span></div>
    <button class="btn btn-primary" onclick="newSite()">ï¼‹ æ–°ã—ã„ç¾å ´ã‚’ä½œæˆ</button>
  </div>
  <div class="sec-title">ä¿å­˜æ¸ˆã¿ã®ç¾å ´</div>
  <div class="site-list" id="site-list"></div>
</div>

<!-- STEP1: ç¾å ´æƒ…å ± -->
<div id="s-step1" class="screen">
  <button class="back-btn" onclick="goHome()">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:20px;">STEP 1 ï¼ ç¾å ´æƒ…å ±</div>
  <div class="form-group">
    <label class="form-label">ç¾å ´å <span class="opt">â€» ä»»æ„</span></label>
    <input type="text" class="form-input" id="f-name" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜é‚¸ é§è»Šå ´">
  </div>
  <div class="form-group">
    <label class="form-label">æ‹…å½“è€…å</label>
    <input type="text" class="form-input" id="f-worker" placeholder="ä¾‹ï¼šå±±ç”°">
  </div>
  <button class="btn btn-primary" onclick="saveStep1()">å†™çœŸã‚’è¿½åŠ ã™ã‚‹ â†’</button>
</div>

<!-- STEP2: å†™çœŸ -->
<div id="s-step2" class="screen">
  <button class="back-btn" onclick="showScreen('s-step1')">â† ç¾å ´æƒ…å ±ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:6px;">STEP 2 ï¼ å†™çœŸã‚’è¿½åŠ </div>
  <p style="font-size:13px;color:var(--text2);margin-bottom:14px;">ã‚¿ã‚°ã‚’é¸ã‚“ã§ã‹ã‚‰å†™çœŸã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€‚æ—¥ã‚’ã¾ãŸã„ã§ä½•åº¦ã§ã‚‚è¿½åŠ ã§ãã¾ã™ã€‚</p>

  <div class="tag-bar">
    <button class="tag-btn t-before active" onclick="selectTag('before',this)">
      <span class="ti">ğŸ“·</span><span>Before</span>
    </button>
    <button class="tag-btn t-during" onclick="selectTag('during',this)">
      <span class="ti">ğŸ”¨</span><span>é€ å½¢å¾Œ</span>
    </button>
    <button class="tag-btn t-after" onclick="selectTag('after',this)">
      <span class="ti">âœ¨</span><span>After</span>
    </button>
    <button class="tag-btn t-pickup" onclick="selectTag('pickup',this)">
      <span class="ti">â­</span><span>ã“ã ã‚ã‚Š</span>
    </button>
  </div>

  <div class="upload-zone" onclick="document.getElementById('file-input').click()">
    <div class="ui">ğŸ“</div>
    <div class="ut">å†™çœŸã‚’è¿½åŠ </div>
    <div class="us">ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰<br><span style="font-size:11px;color:var(--accent);">ä¸Šã®ã‚¿ã‚°ã‚’é¸ã‚“ã§ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span></div>
  </div>
  <input type="file" id="file-input" accept="image/*" multiple onchange="handleFiles(this.files)">

  <div id="photo-sections"></div>

  <!-- SORT BARï¼ˆå†™çœŸãŒ1æšã§ã‚‚ã‚ã‚Œã°è¡¨ç¤ºï¼‰ -->
  <div id="sort-area" style="display:none;">
    <div class="sec-title" style="margin-top:20px;margin-bottom:10px;">è¡¨ç¤ºãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ <span style="font-size:10px;font-weight:400;color:var(--text2);">è¤‡æ•°é¸æŠå¯</span></div>
    <div class="sort-bar">
      <button class="sort-chip active" data-sort="all"    onclick="toggleSort('all',this)">ğŸ”€ å…¨ã¦</button>
      <button class="sort-chip"        data-sort="pair"   onclick="toggleSort('pair',this)">ğŸ”— Before/Afterãƒšã‚¢</button>
      <button class="sort-chip"        data-sort="portrait"  onclick="toggleSort('portrait',this)">ğŸ“± ç¸¦</button>
      <button class="sort-chip"        data-sort="landscape" onclick="toggleSort('landscape',this)">ğŸ–¼ æ¨ª</button>
      <button class="sort-chip"        data-sort="before" onclick="toggleSort('before',this)">ğŸ“· Before</button>
      <button class="sort-chip"        data-sort="after"  onclick="toggleSort('after',this)">âœ¨ After</button>
      <button class="sort-chip"        data-sort="during" onclick="toggleSort('during',this)">ğŸ”¨ é€ å½¢å¾Œ</button>
      <button class="sort-chip"        data-sort="pickup" onclick="toggleSort('pickup',this)">â­ ã“ã ã‚ã‚Š</button>
    </div>
    <div id="sorted-photos"></div>
  </div>

  <div class="gap10" style="margin-top:24px;">
    <button class="btn btn-primary" onclick="goStep3()">å ±å‘Šæ›¸ã‚’ä½œæˆã™ã‚‹ â†’</button>
  </div>
</div>

<!-- STEP3: å ±å‘Šæ›¸ -->
<div id="s-step3" class="screen">
  <button class="back-btn" onclick="showScreen('s-step2')">â† å†™çœŸç”»é¢ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:20px;">STEP 3 ï¼ å ±å‘Šæ›¸</div>

  <div class="form-group">
    <label class="form-label">ã‚¿ã‚¤ãƒˆãƒ« <span class="opt">SNSç”¨ãƒ»ä»»æ„</span></label>
    <div class="chips" id="title-chips">
      <button class="chip" onclick="titleChip(this,'ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥')">ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥</button>
      <button class="chip" onclick="titleChip(this,'é§è»Šå ´æ–½å·¥')">é§è»Šå ´æ–½å·¥</button>
      <button class="chip" onclick="titleChip(this,'ã‚¿ã‚¤ãƒ«ãƒ‡ãƒƒã‚­æ–½å·¥')">ã‚¿ã‚¤ãƒ«ãƒ‡ãƒƒã‚­æ–½å·¥</button>
      <button class="chip" onclick="titleChip(this,'å¤–æ§‹æ–½å·¥')">å¤–æ§‹æ–½å·¥</button>
    </div>
    <input type="text" class="form-input" id="f-title" placeholder="ãã®ä»–ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰" style="margin-top:8px;" oninput="clearTitleChips()">
  </div>

  <div class="input-row">
    <div class="form-group" style="flex:1;">
      <label class="form-label">è¦æ¨¡</label>
      <div class="unit-wrap">
        <input type="number" class="form-input" id="f-area" placeholder="25">
        <span class="unit">ã¡</span>
      </div>
    </div>
    <div class="form-group" style="flex:1;">
      <label class="form-label">æ–½å·¥æ—¥æ•°</label>
      <div class="unit-wrap">
        <input type="number" class="form-input" id="f-days" placeholder="3">
        <span class="unit">æ—¥</span>
      </div>
    </div>
  </div>

  <div class="form-group">
    <label class="form-label">ä¸‹åœ°å‡¦ç†</label>
    <div class="chips">
      <button class="chip" id="chip-base-y" onclick="singleChip('f-base','ã‚ã‚Š',['chip-base-y','chip-base-n'])">ã‚ã‚Š</button>
      <button class="chip" id="chip-base-n" onclick="singleChip('f-base','ãªã—',['chip-base-y','chip-base-n'])">ãªã—</button>
    </div>
    <input type="hidden" id="f-base">
    <input type="text" class="form-input" id="f-base-detail" placeholder="è©³ç´°ï¼ˆä¾‹ï¼šã‚±ãƒ¬ãƒ³å‡¦ç†ï¼‰" style="margin-top:8px;">
  </div>

  <div class="form-group">
    <label class="form-label">ãƒ‘ã‚¿ãƒ¼ãƒ³ <span class="opt">è¤‡æ•°å¯</span></label>
    <div class="chips" id="chips-pat">
      <button class="chip" onclick="multiChip(this,'pat')">ä¹±å½¢çŸ³èª¿</button>
      <button class="chip" onclick="multiChip(this,'pat')">ã‚¿ã‚¤ãƒ«èª¿</button>
      <button class="chip" onclick="multiChip(this,'pat')">ç‰¹æ®Šãƒ»ãƒ­ã‚´</button>
      <button class="chip" onclick="multiChip(this,'pat')">ãã®ä»–</button>
    </div>
    <input type="text" class="form-input" id="f-pat-custom" placeholder="ãã®ä»–ï¼ˆä»»æ„ï¼‰" style="margin-top:8px;">
  </div>

  <div class="form-group">
    <label class="form-label">ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ <span class="opt">è¤‡æ•°å¯</span></label>
    <div class="chips" id="chips-col">
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#6b7280;flex-shrink:0;display:inline-block;"></span>ã‚°ãƒ¬ãƒ¼</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#111827;flex-shrink:0;display:inline-block;"></span>ãƒ–ãƒ©ãƒƒã‚¯</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#d4b896;flex-shrink:0;display:inline-block;"></span>ã‚¤ã‚¨ãƒ­ãƒ¼ãƒ™ãƒ¼ã‚¸ãƒ¥</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#c8a882;flex-shrink:0;display:inline-block;"></span>ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#f97316;flex-shrink:0;display:inline-block;"></span>ã‚ªãƒ¬ãƒ³ã‚¸</button>
      <button class="chip" onclick="multiChip(this,'col')"><span style="width:10px;height:10px;border-radius:50%;background:#4d7c5f;flex-shrink:0;display:inline-block;"></span>ãƒ¢ã‚¹ã‚°ãƒªãƒ¼ãƒ³</button>
    </div>
    <input type="text" class="form-input" id="f-col-custom" placeholder="ãã®ä»–ã®ã‚«ãƒ©ãƒ¼ï¼ˆä»»æ„ï¼‰" style="margin-top:8px;">
  </div>

  <div class="form-group">
    <label class="form-label">ç›®åœ°ã‚«ãƒ©ãƒ¼</label>
    <input type="text" class="form-input" id="f-grout" placeholder="ä¾‹ï¼šãƒ›ãƒ¯ã‚¤ãƒˆã€ã‚°ãƒ¬ãƒ¼">
  </div>

  <div class="form-group">
    <label class="form-label">ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ <span class="opt">SNSç”¨</span></label>
    <textarea class="form-input" id="f-kodawari" placeholder="ä¾‹ï¼šç›®åœ°ã‚’ç´°ãã—ã¦é«˜ç´šæ„Ÿã‚’å‡ºã—ãŸã€‚çŸ³ã®å‘ãã‚’æƒãˆã¦æ•´ç„¶ã¨ã—ãŸå°è±¡ã«ã€‚"></textarea>
    <div class="hint">ğŸ’¡ ä¾‹ï¼š<em>ã€Œç›®åœ°å¹…3mmã§ä¸Šè³ªãªä»•ä¸ŠãŒã‚Šã«ã€ã€ŒãŠå®¢æ§˜å¸Œæœ›è‰²ã§ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒ–ãƒ¬ãƒ³ãƒ‰ã€</em></div>
  </div>

  <div class="form-group">
    <label class="form-label">ãŠå®¢æ§˜ã®å£° <span class="opt">SNSç”¨</span></label>
    <textarea class="form-input" id="f-voice" placeholder="ä¾‹ï¼šã€Œæƒ³åƒä»¥ä¸Šã®ä»•ä¸ŠãŒã‚Šã§å¤§æº€è¶³ã§ã™ã€"></textarea>
  </div>

  <div class="form-group">
    <label class="form-label">ãŠå®¢æ§˜ã®ãŠæ‚©ã¿ <span class="opt">SNSç”¨ãƒ»ä»»æ„</span></label>
    <textarea class="form-input" id="f-pain" placeholder="ä¾‹ï¼šã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãŒå‘³æ°—ãªãã¦ã‚‚ã£ã¨ãŠã—ã‚ƒã‚Œã«ã—ãŸã‹ã£ãŸ"></textarea>
  </div>

  <div class="form-group">
    <label class="form-label">ãã®ä»–</label>
    <textarea class="form-input" id="f-memo" placeholder="è‡ªç”±è¨˜å…¥"></textarea>
  </div>

  <button class="btn btn-primary" onclick="saveStep3()">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã™ã‚‹ â†’</button>
</div>

<!-- PREVIEW -->
<div id="s-preview" class="screen">
  <button class="back-btn" onclick="showScreen('s-step3')">â† å ±å‘Šæ›¸ã«æˆ»ã‚‹</button>
  <div class="sec-title" style="margin-bottom:16px;">å ±å‘Šæ›¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
  <div id="preview-content"></div>
  <div class="sec-title" style="margin-bottom:12px;">é€ä»˜</div>
  <div class="info-box">
    <strong>2ã‚¹ãƒ†ãƒƒãƒ—ã§é€ä»˜</strong><br>
    â‘  ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ â†’ LINEã«è²¼ã‚Šä»˜ã‘<br>
    â‘¡ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â†’ LINEã«æ·»ä»˜
  </div>
  <div class="gap10" style="margin-bottom:12px;">
    <button class="btn btn-primary" onclick="copyText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
    <button class="btn btn-secondary" onclick="downloadZip()">ğŸ“¦ ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
  </div>
  <div class="gap10">
    <button class="btn btn-ghost btn-sm" onclick="showScreen('s-step2')">â† å†™çœŸã‚’è¿½åŠ ãƒ»ä¿®æ­£</button>
    <button class="btn btn-danger btn-sm" onclick="deleteSite()">ğŸ—‘ ã“ã®ç¾å ´ã‚’å‰Šé™¤</button>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-history">
  <div class="modal">
    <div class="modal-title">ğŸ“‹ ç¾å ´ä¸€è¦§</div>
    <div id="modal-site-list" class="gap10"></div>
    <div style="margin-top:16px;">
      <button class="btn btn-ghost" onclick="closeModal('modal-history')">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script>
const PICKUP_MAX = 20;
let siteId = null;
let currentTag = 'before';
let sites = {};
let patSel = new Set();
let colSel = new Set();

function init() {
  const s = localStorage.getItem('rs-pro-v2');
  if (s) try { sites = JSON.parse(s); } catch(e){}
  renderHome();
}

function persist() {
  localStorage.setItem('rs-pro-v2', JSON.stringify(sites));
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

function goHome() {
  siteId = null; renderHome(); showScreen('s-home');
}

/* HOME */
function renderHome() {
  const el = document.getElementById('site-list');
  const ids = Object.keys(sites).reverse();
  if (!ids.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ—ï¸</div><div>ã¾ã ç¾å ´ãŒã‚ã‚Šã¾ã›ã‚“<br>ã€Œæ–°ã—ã„ç¾å ´ã‚’ä½œæˆã€ã‹ã‚‰ã©ã†ã</div></div>';
    return;
  }
  el.innerHTML = ids.map(id => {
    const info = sites[id].info || {};
    const photos = sites[id].photos || [];
    const bc = photos.filter(p=>p.tag==='before').length;
    const dc = photos.filter(p=>p.tag==='during').length;
    const ac = photos.filter(p=>p.tag==='after').length;
    const pc = photos.filter(p=>p.tag==='pickup').length;
    return `<div class="site-card" onclick="openSite('${id}')">
      <div style="flex:1;min-width:0;">
        <div class="site-name">${info.name||'ï¼ˆåå‰ãªã—ï¼‰'}</div>
        <div class="site-meta">${[info.worker,info.date].filter(Boolean).join(' Â· ')}</div>
      </div>
      <div class="badges">
        ${bc?`<span class="badge b-before">å‰${bc}</span>`:''}
        ${dc?`<span class="badge b-during">ä¸­${dc}</span>`:''}
        ${ac?`<span class="badge b-after">å¾Œ${ac}</span>`:''}
        ${pc?`<span class="badge b-pickup">â­${pc}</span>`:''}
        <span class="badge b-gray">${photos.length}æš</span>
      </div>
    </div>`;
  }).join('');
}

/* NEW / OPEN */
function newSite() {
  siteId = 'site_' + Date.now();
  sites[siteId] = { info: { date: new Date().toLocaleDateString('ja-JP') }, photos: [] };
  document.getElementById('f-name').value = '';
  document.getElementById('f-worker').value = '';
  showScreen('s-step1');
}

function openSite(id) {
  siteId = id;
  const info = sites[id].info || {};
  document.getElementById('f-name').value = info.name || '';
  document.getElementById('f-worker').value = info.worker || '';
  loadStep3Fields(info);
  closeModal('modal-history');
  renderPhotoSections();
  showScreen('s-step2');
}

/* STEP1 */
function saveStep1() {
  sites[siteId].info.name = document.getElementById('f-name').value;
  sites[siteId].info.worker = document.getElementById('f-worker').value;
  persist();
  renderPhotoSections();
  showScreen('s-step2');
}

/* CHIPS */
function singleChip(hidId, val, chipIds) {
  chipIds.forEach(cid => document.getElementById(cid).classList.remove('active'));
  event.currentTarget.classList.add('active');
  document.getElementById(hidId).value = val;
}

function multiChip(el, group) {
  const label = el.innerText.trim();
  const sel = group === 'pat' ? patSel : colSel;
  if (el.classList.contains('active')) {
    el.classList.remove('active'); sel.delete(label);
  } else {
    el.classList.add('active'); sel.add(label);
  }
}

function titleChip(el, val) {
  document.querySelectorAll('#title-chips .chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('f-title').value = val;
}

function clearTitleChips() {
  document.querySelectorAll('#title-chips .chip').forEach(c=>c.classList.remove('active'));
}

/* STEP2: PHOTOS */
function selectTag(tag, el) {
  currentTag = tag;
  document.querySelectorAll('.tag-btn').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
}

function handleFiles(files) {
  if (!siteId) return;
  const site = sites[siteId];
  if (!site.photos) site.photos = [];

  if (currentTag === 'pickup') {
    const cur = site.photos.filter(p=>p.tag==='pickup').length;
    const rem = PICKUP_MAX - cur;
    if (rem <= 0) { showToast(`ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆã¯æœ€å¤§${PICKUP_MAX}æšã§ã™`); return; }
    if (files.length > rem) {
      showToast(`æ®‹ã‚Š${rem}æšã¾ã§è¿½åŠ ã§ãã¾ã™`);
      files = Array.from(files).slice(0, rem);
    }
  }

  const readers = Array.from(files).map(file => new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      const img = new Image();
      img.onload = () => {
        site.photos.push({
          id: 'p_' + Date.now() + '_' + Math.random().toString(36).slice(2),
          tag: currentTag,
          dataUrl: e.target.result,
          orientation: img.width >= img.height ? 'landscape' : 'portrait',
          selected: true,
        });
        resolve();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }));

  Promise.all(readers).then(() => {
    persist(); renderPhotoSections();
    document.getElementById('file-input').value = '';
  });
}

let activeSorts = new Set(['all']);

function toggleSort(key, el) {
  if (key === 'all') {
    activeSorts = new Set(['all']);
    document.querySelectorAll('.sort-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
  } else {
    activeSorts.delete('all');
    document.querySelector('[data-sort="all"]').classList.remove('active');
    if (el.classList.contains('active')) {
      el.classList.remove('active');
      activeSorts.delete(key);
      if (activeSorts.size === 0) {
        activeSorts.add('all');
        document.querySelector('[data-sort="all"]').classList.add('active');
      }
    } else {
      el.classList.add('active');
      activeSorts.add(key);
    }
  }
  renderSortedPhotos();
}

function renderPhotoSections() {
  if (!siteId) return;
  const photos = sites[siteId].photos || [];
  // ã‚¿ã‚°åˆ¥ã‚µãƒ ãƒã‚¤ãƒ«ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çŠ¶æ³ç¢ºèªç”¨ãƒ»ãƒŸãƒ‹è¡¨ç¤ºï¼‰
  document.getElementById('photo-sections').innerHTML = '';
  const sortArea = document.getElementById('sort-area');
  if (photos.length > 0) {
    sortArea.style.display = 'block';
    renderSortedPhotos();
  } else {
    sortArea.style.display = 'none';
  }
}

function photoCard(p, extraLabel) {
  const oriClass = p.orientation === 'portrait' ? 'portrait' : 'landscape';
  const tagColors = { before:'ptl-before', after:'ptl-after', during:'ptl-during', pickup:'ptl-pickup' };
  const tagLabels = { before:'Before', after:'After', during:'é€ å½¢å¾Œ', pickup:'â­' };
  const lbl = extraLabel || tagLabels[p.tag] || '';
  const lblCls = tagColors[p.tag] || '';
  return `<div class="photo-item ${oriClass}${p.selected?' selected':''}" id="pi-${p.id}">
    <img src="${p.dataUrl}" loading="lazy">
    <div class="chk">âœ“</div>
    <div class="ori">${p.orientation==='portrait'?'ç¸¦':'æ¨ª'}</div>
    <div class="del" onclick="delPhoto('${p.id}');event.stopPropagation()">âœ•</div>
    <div class="pair-tag-label ${lblCls}">${lbl}</div>
    <div class="tap" onclick="toggleSel('${p.id}')"></div>
  </div>`;
}

function renderSortedPhotos() {
  if (!siteId) return;
  const all = sites[siteId].photos || [];
  const container = document.getElementById('sorted-photos');
  const total = all.length;
  const selCount = all.filter(p=>p.selected).length;

  // header
  let html = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
    <span style="font-size:13px;color:var(--text2);">è¨ˆ ${total}æš</span>
    <span class="sel-count">${selCount}æšé¸æŠä¸­</span>
  </div>`;

  if (activeSorts.has('pair')) {
    html += renderPairView(all);
  } else {
    let photos = [...all];

    // filter
    if (!activeSorts.has('all')) {
      photos = photos.filter(p => {
        let show = false;
        if (activeSorts.has('portrait') && p.orientation === 'portrait') show = true;
        if (activeSorts.has('landscape') && p.orientation === 'landscape') show = true;
        if (activeSorts.has('before') && p.tag === 'before') show = true;
        if (activeSorts.has('after') && p.tag === 'after') show = true;
        if (activeSorts.has('during') && p.tag === 'during') show = true;
        if (activeSorts.has('pickup') && p.tag === 'pickup') show = true;
        return show;
      });
    } else {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šBefore/Afterå‰ã€é€ å½¢å¾Œãƒ»ã“ã ã‚ã‚Šå¾Œ
      photos.sort((a,b) => {
        const order = { before:0, after:1, during:2, pickup:3 };
        return (order[a.tag]||0) - (order[b.tag]||0);
      });
    }

    if (!photos.length) {
      html += `<div class="empty" style="padding:24px 0;"><div class="empty-icon" style="font-size:32px;">ğŸ”</div><div style="font-size:13px;">è©²å½“ã™ã‚‹å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
    } else {
      html += `<div class="photo-grid">${photos.map(p=>photoCard(p)).join('')}</div>`;
    }
  }

  container.innerHTML = html;
}

function renderPairView(all) {
  const befores = all.filter(p=>p.tag==='before');
  const afters  = all.filter(p=>p.tag==='after');
  const during  = all.filter(p=>p.tag==='during');
  const pickup  = all.filter(p=>p.tag==='pickup');

  // ç”»è§’åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆportrait / landscapeï¼‰
  const bPort = befores.filter(p=>p.orientation==='portrait');
  const bLand = befores.filter(p=>p.orientation==='landscape');
  const aPort = afters.filter(p=>p.orientation==='portrait');
  const aLand = afters.filter(p=>p.orientation==='landscape');

  let html = '';
  const maxP = Math.max(bPort.length, aPort.length);
  const maxL = Math.max(bLand.length, aLand.length);

  if (maxP > 0) {
    html += `<div style="font-size:12px;color:var(--text2);margin-bottom:6px;border-left:3px solid var(--before);padding-left:6px;">ç¸¦ Before / After</div>`;
    for (let i=0; i<maxP; i++) {
      html += `<div class="pair-row">`;
      if (bPort[i]) html += photoCard(bPort[i], 'Before');
      if (aPort[i]) html += photoCard(aPort[i], 'After');
      html += `</div>`;
    }
  }
  if (maxL > 0) {
    html += `<div style="font-size:12px;color:var(--text2);margin:10px 0 6px;border-left:3px solid var(--after);padding-left:6px;">æ¨ª Before / After</div>`;
    for (let i=0; i<maxL; i++) {
      html += `<div class="pair-row">`;
      if (bLand[i]) html += photoCard(bLand[i], 'Before');
      if (aLand[i]) html += photoCard(aLand[i], 'After');
      html += `</div>`;
    }
  }

  // é€ å½¢å¾Œ
  if (during.length) {
    html += `<div style="font-size:12px;color:var(--text2);margin:14px 0 6px;border-left:3px solid var(--during);padding-left:6px;">é€ å½¢å¾Œï¼ˆ${during.length}æšï¼‰</div>`;
    html += `<div class="photo-grid">${during.map(p=>photoCard(p)).join('')}</div>`;
  }
  // ã“ã ã‚ã‚Š
  if (pickup.length) {
    html += `<div style="font-size:12px;color:var(--text2);margin:14px 0 6px;border-left:3px solid var(--pickup);padding-left:6px;">â­ ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆï¼ˆ${pickup.length}æšï¼‰</div>`;
    html += `<div class="photo-grid">${pickup.map(p=>photoCard(p)).join('')}</div>`;
  }

  if (!html) html = `<div class="empty" style="padding:24px 0;"><div style="font-size:32px;">ğŸ“·</div><div style="font-size:13px;">å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“</div></div>`;
  return html;
}

function toggleSel(id) {
  const p = sites[siteId].photos.find(p=>p.id===id);
  if (p) { p.selected=!p.selected; persist(); renderSortedPhotos(); }
}

function delPhoto(id) {
  sites[siteId].photos = sites[siteId].photos.filter(p=>p.id!==id);
  persist(); renderPhotoSections();
}

function goStep3() {
  if (!siteId || !sites[siteId]) { showToast('ç¾å ´ã‚’å…ˆã«ä½œæˆã—ã¦ãã ã•ã„'); return; }
  // ç¾å ´åãƒ»æ‹…å½“è€…ã‚’æœ€æ–°ã«ä¿å­˜
  if (document.getElementById('f-name')) {
    sites[siteId].info.name = sites[siteId].info.name || '';
    sites[siteId].info.worker = sites[siteId].info.worker || '';
  }
  loadStep3Fields(sites[siteId].info || {});
  showScreen('s-step3');
}

function saveStep3() {
  if (!siteId || !sites[siteId]) { showToast('ã‚¨ãƒ©ãƒ¼ï¼šç¾å ´ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
  const info = sites[siteId].info || {};
  Object.assign(info, {
    title: document.getElementById('f-title').value,
    area: document.getElementById('f-area').value,
    days: document.getElementById('f-days').value,
    base: document.getElementById('f-base').value,
    baseDetail: document.getElementById('f-base-detail').value,
    patterns: [...patSel],
    patCustom: document.getElementById('f-pat-custom').value,
    colors: [...colSel],
    colCustom: document.getElementById('f-col-custom').value,
    grout: document.getElementById('f-grout').value,
    kodawari: document.getElementById('f-kodawari').value,
    voice: document.getElementById('f-voice').value,
    pain: document.getElementById('f-pain').value,
    memo: document.getElementById('f-memo').value,
  });
  sites[siteId].info = info;
  persist();
  renderPreview();
  showScreen('s-preview');
}

function loadStep3Fields(info) {
  document.getElementById('f-title').value = info.title || '';
  document.getElementById('f-area').value = info.area || '';
  document.getElementById('f-days').value = info.days || '';
  document.getElementById('f-base').value = info.base || '';
  document.getElementById('f-base-detail').value = info.baseDetail || '';
  document.getElementById('f-pat-custom').value = info.patCustom || '';
  document.getElementById('f-col-custom').value = info.colCustom || '';
  document.getElementById('f-grout').value = info.grout || '';
  document.getElementById('f-kodawari').value = info.kodawari || '';
  document.getElementById('f-voice').value = info.voice || '';
  document.getElementById('f-pain').value = info.pain || '';
  document.getElementById('f-memo').value = info.memo || '';

  patSel = new Set(info.patterns || []);
  colSel = new Set(info.colors || []);

  // restore base chip
  ['chip-base-y','chip-base-n'].forEach(id=>document.getElementById(id).classList.remove('active'));
  if (info.base === 'ã‚ã‚Š') document.getElementById('chip-base-y').classList.add('active');
  if (info.base === 'ãªã—') document.getElementById('chip-base-n').classList.add('active');

  // restore pattern chips
  document.querySelectorAll('#chips-pat .chip').forEach(el=>{
    el.classList.toggle('active', patSel.has(el.innerText.trim()));
  });
  // restore color chips
  document.querySelectorAll('#chips-col .chip').forEach(el=>{
    el.classList.toggle('active', colSel.has(el.innerText.trim()));
  });
  // restore title chip
  document.querySelectorAll('#title-chips .chip').forEach(el=>{
    el.classList.toggle('active', el.innerText.trim() === info.title);
  });
}

function saveStep3() {
  const info = sites[siteId].info || {};
  Object.assign(info, {
    title: document.getElementById('f-title').value,
    area: document.getElementById('f-area').value,
    days: document.getElementById('f-days').value,
    base: document.getElementById('f-base').value,
    baseDetail: document.getElementById('f-base-detail').value,
    patterns: [...patSel],
    patCustom: document.getElementById('f-pat-custom').value,
    colors: [...colSel],
    colCustom: document.getElementById('f-col-custom').value,
    grout: document.getElementById('f-grout').value,
    kodawari: document.getElementById('f-kodawari').value,
    voice: document.getElementById('f-voice').value,
    pain: document.getElementById('f-pain').value,
    memo: document.getElementById('f-memo').value,
  });
  sites[siteId].info = info;
  persist();
  renderPreview();
  showScreen('s-preview');
}

/* PREVIEW */
function buildText() {
  const info = sites[siteId].info || {};
  const photos = (sites[siteId].photos||[]).filter(p=>p.selected);
  const bc=photos.filter(p=>p.tag==='before').length;
  const dc=photos.filter(p=>p.tag==='during').length;
  const ac=photos.filter(p=>p.tag==='after').length;
  const pc=photos.filter(p=>p.tag==='pickup').length;
  const pats = [...(info.patterns||[]), info.patCustom].filter(Boolean).join(' / ');
  const cols = [...(info.colors||[]), info.colCustom].filter(Boolean).join(' / ');
  const base = info.base ? info.base+(info.baseDetail?`ï¼ˆ${info.baseDetail}ï¼‰`:'') : '';

  let t = `ã€æ–½å·¥å ±å‘Šã€‘RollerStone\n`;
  if (info.title) t += `â—† ${info.title}\n`;
  t += `â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  if (info.name) t += `â–  ç¾å ´åï¼š${info.name}\n`;
  if (info.worker) t += `â–  æ‹…å½“ï¼š${info.worker}\n`;
  if (info.date) t += `â–  æ—¥ä»˜ï¼š${info.date}\n`;
  t += `\n`;
  if (info.area) t += `â–· è¦æ¨¡ï¼š${info.area}ã¡\n`;
  if (info.days) t += `â–· æ–½å·¥æ—¥æ•°ï¼š${info.days}æ—¥\n`;
  if (base) t += `â–· ä¸‹åœ°å‡¦ç†ï¼š${base}\n`;
  if (pats) t += `â–· ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼š${pats}\n`;
  if (cols) t += `â–· ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼ï¼š${cols}\n`;
  if (info.grout) t += `â–· ç›®åœ°ã‚«ãƒ©ãƒ¼ï¼š${info.grout}\n`;
  t += `\n`;
  if (info.kodawari) t += `â˜… ã“ã ã‚ã‚Šãƒã‚¤ãƒ³ãƒˆ\n${info.kodawari}\n\n`;
  if (info.voice) t += `ğŸ’¬ ãŠå®¢æ§˜ã®å£°\n${info.voice}\n\n`;
  if (info.memo) t += `ğŸ“ ãã®ä»–\n${info.memo}\n\n`;
  t += `â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  t += `ğŸ“· æ·»ä»˜ï¼š${photos.length}æšï¼ˆBefore:${bc} é€ å½¢å¾Œ:${dc} After:${ac}${pc?` â­:${pc}`:''}ï¼‰`;
  return t;
}

function renderPreview() {
  const info = sites[siteId].info || {};
  const photos = (sites[siteId].photos||[]).filter(p=>p.selected);
  const rows = [
    ['ã‚¿ã‚¤ãƒˆãƒ«', info.title],
    ['ç¾å ´å', info.name],
    ['æ‹…å½“è€…', info.worker],
    ['æ—¥ä»˜', info.date],
    ['è¦æ¨¡', info.area?info.area+'ã¡':''],
    ['æ–½å·¥æ—¥æ•°', info.days?info.days+'æ—¥':''],
    ['ä¸‹åœ°å‡¦ç†', info.base?(info.base+(info.baseDetail?`ï¼ˆ${info.baseDetail}ï¼‰`:'')):'' ],
    ['ãƒ‘ã‚¿ãƒ¼ãƒ³', [...(info.patterns||[]),info.patCustom].filter(Boolean).join(' / ')],
    ['ä»•ä¸Šã’ã‚«ãƒ©ãƒ¼', [...(info.colors||[]),info.colCustom].filter(Boolean).join(' / ')],
    ['ç›®åœ°ã‚«ãƒ©ãƒ¼', info.grout],
    ['ã“ã ã‚ã‚Š', info.kodawari],
    ['ãŠå®¢æ§˜ã®å£°', info.voice],
    ['ãŠæ‚©ã¿', info.pain],
    ['ãã®ä»–', info.memo],
  ].filter(r=>r[1]);

  const bph=photos.filter(p=>p.tag==='before');
  const dph=photos.filter(p=>p.tag==='during');
  const aph=photos.filter(p=>p.tag==='after');
  const pph=photos.filter(p=>p.tag==='pickup');
  const maxLen=Math.max(bph.length,dph.length,aph.length);

  let pairs='';
  for(let i=0;i<maxLen;i++){
    const b=bph[i],d=dph[i],a=aph[i];
    if(!b&&!d&&!a) continue;
    pairs+=`<div class="photo-pair">`;
    if(b) pairs+=`<div class="pair-item"><img src="${b.dataUrl}"><div class="pair-label pl-before">Before</div></div>`;
    if(d) pairs+=`<div class="pair-item"><img src="${d.dataUrl}"><div class="pair-label pl-during">é€ å½¢å¾Œ</div></div>`;
    if(a) pairs+=`<div class="pair-item"><img src="${a.dataUrl}"><div class="pair-label pl-after">After</div></div>`;
    pairs+=`</div>`;
  }

  let pickupGrid='';
  if(pph.length){
    pickupGrid=`<div class="sec-title" style="margin:16px 0 10px;">ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆï¼ˆ${pph.length}æšï¼‰</div>
    <div class="photo-grid">${pph.map(p=>`
      <div style="position:relative;border-radius:8px;overflow:hidden;aspect-ratio:1;">
        <img src="${p.dataUrl}" style="width:100%;height:100%;object-fit:cover;">
        <div class="pair-label pl-pickup" style="position:absolute;bottom:0;left:0;right:0;">â­</div>
      </div>`).join('')}</div>`;
  }

  document.getElementById('preview-content').innerHTML = `
    <div class="preview-card">
      <div class="preview-card-hd">æ–½å·¥æƒ…å ±</div>
      ${rows.map(r=>`<div class="preview-row"><div class="pk">${r[0]}</div><div class="pv">${r[1]}</div></div>`).join('')}
    </div>
    <div class="sec-title" style="margin-bottom:10px;">é€ä»˜ãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</div>
    <div class="report-box">${buildText()}</div>
    <div class="sec-title" style="margin-bottom:10px;">é¸æŠä¸­ã®å†™çœŸï¼ˆ${photos.length}æšï¼‰</div>
    ${pairs}${pickupGrid}
    <div class="divider"></div>
  `;
}

function copyText() {
  const text = buildText();
  if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(()=>showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'));
  } else {
    const ta=document.createElement('textarea');
    ta.value=text; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    showToast('ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
  }
}

async function downloadZip() {
  const site = sites[siteId];
  const info = site.info || {};
  const photos = (site.photos||[]).filter(p=>p.selected);
  if (!photos.length) { showToast('å†™çœŸãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }
  showToast('ZIPã‚’ä½œæˆä¸­...');

  const zip = new JSZip();
  const name = info.name || 'ç¾å ´';
  const date = (info.date||'').replace(/\//g,'-');

  const folders = {
    before: zip.folder('Beforeï¼ˆæ–½å·¥å‰ï¼‰'),
    during: zip.folder('é€ å½¢å¾Œ'),
    after: zip.folder('Afterï¼ˆä»•ä¸Šã’å¾Œï¼‰'),
    pickup: zip.folder('ã“ã ã‚ã‚Šã‚·ãƒ§ãƒƒãƒˆ'),
  };
  const cnt = { before:1, during:1, after:1, pickup:1 };

  for (const p of photos) {
    const ext = p.dataUrl.split(';')[0].split('/')[1]||'jpg';
    const ori = p.orientation==='portrait'?'ç¸¦':'æ¨ª';
    const fname = `${String(cnt[p.tag]).padStart(3,'0')}_${ori}.${ext}`;
    cnt[p.tag]++;
    const blob = await (await fetch(p.dataUrl)).blob();
    folders[p.tag].file(fname, blob);
  }
  zip.file('å ±å‘Šæ›¸.txt', buildText());

  const content = await zip.generateAsync({ type:'blob' });
  const url = URL.createObjectURL(content);
  const a = document.createElement('a');
  a.href=url; a.download=`${name}_${date}.zip`; a.click();
  URL.revokeObjectURL(url);
  showToast('ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼');
}

function deleteSite() {
  if (!confirm('ã“ã®ç¾å ´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
  delete sites[siteId];
  persist(); siteId=null; renderHome(); showScreen('s-home');
  showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
}

function openModal(id) {
  if (id==='modal-history') {
    const ids = Object.keys(sites).reverse();
    const el = document.getElementById('modal-site-list');
    if (!ids.length) {
      el.innerHTML='<div style="color:var(--text2);text-align:center;padding:20px;font-size:14px;">ç¾å ´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    } else {
      el.innerHTML = ids.map(id=>{
        const info=(sites[id].info||{});
        return `<button class="btn btn-secondary" onclick="openSite('${id}')" style="justify-content:flex-start;text-align:left;">
          <div>
            <div style="font-size:15px;font-weight:700;">${info.name||'ï¼ˆåå‰ãªã—ï¼‰'}</div>
            <div style="font-size:12px;color:var(--text2);">${[info.worker,info.date].filter(Boolean).join(' Â· ')}</div>
          </div>
        </button>`;
      }).join('');
    }
  }
  document.getElementById(id).classList.add('active');
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('active');}));

function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

init();

// ===== ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›ã®ã¿è‡ªå‹•æŠ•å…¥ï¼‰ =====
function makeDemoImg(color, label, w, h) {
  const c = document.createElement('canvas');
  c.width=w; c.height=h;
  const ctx = c.getContext('2d');
  ctx.fillStyle=color; ctx.fillRect(0,0,w,h);
  // tile pattern
  ctx.strokeStyle='rgba(255,255,255,0.08)'; ctx.lineWidth=1;
  for(let x=0;x<w;x+=20){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h);ctx.stroke();}
  for(let y=0;y<h;y+=20){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(w,y);ctx.stroke();}
  ctx.fillStyle='rgba(255,255,255,0.8)';
  ctx.font=`bold ${Math.min(w,h)*0.09}px sans-serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(label, w/2, h/2);
  return c.toDataURL('image/jpeg',0.7);
}

if (!localStorage.getItem('rs-pro-demo-loaded')) {
  const demoId = 'demo_' + Date.now();
  const photos = [
    {tag:'before', dataUrl:makeDemoImg('#2a3545','Beforeâ‘ ',600,900), orientation:'portrait', selected:true},
    {tag:'before', dataUrl:makeDemoImg('#2a3545','Beforeâ‘¡',900,600), orientation:'landscape', selected:true},
    {tag:'before', dataUrl:makeDemoImg('#2a3545','Beforeâ‘¢',600,900), orientation:'portrait', selected:false},
    {tag:'during', dataUrl:makeDemoImg('#3b2050','é€ å½¢å¾Œâ‘ ',600,900), orientation:'portrait', selected:true},
    {tag:'during', dataUrl:makeDemoImg('#3b2050','é€ å½¢å¾Œâ‘¡',900,600), orientation:'landscape', selected:true},
    {tag:'after',  dataUrl:makeDemoImg('#0f3020','Afterâ‘ ',600,900), orientation:'portrait', selected:true},
    {tag:'after',  dataUrl:makeDemoImg('#0f3020','Afterâ‘¡',600,900), orientation:'portrait', selected:true},
    {tag:'after',  dataUrl:makeDemoImg('#0f3020','Afterâ‘¢',900,600), orientation:'landscape', selected:true},
    {tag:'after',  dataUrl:makeDemoImg('#0f3020','Afterâ‘£',600,900), orientation:'portrait', selected:false},
    {tag:'pickup', dataUrl:makeDemoImg('#503010','â­ã“ã ã‚ã‚Šâ‘ ',900,600), orientation:'landscape', selected:true},
    {tag:'pickup', dataUrl:makeDemoImg('#503010','â­ã“ã ã‚ã‚Šâ‘¡',600,900), orientation:'portrait', selected:true},
  ].map((p,i)=>({...p, id:'dp_'+i}));

  sites[demoId] = {
    info:{
      name:'ç”°ä¸­æ§˜é‚¸ é§è»Šå ´', worker:'å±±ç”°',
      date: new Date().toLocaleDateString('ja-JP'),
      title:'ç„é–¢ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–½å·¥', area:'25', days:'3',
      base:'ã‚ã‚Š', baseDetail:'ã‚±ãƒ¬ãƒ³å‡¦ç†',
      patterns:['ä¹±å½¢çŸ³èª¿'], patCustom:'',
      colors:['ã‚°ãƒ¬ãƒ¼','ãƒŸãƒ«ã‚¯ãƒ†ã‚£ãƒ¼'], colCustom:'',
      grout:'ãƒ›ãƒ¯ã‚¤ãƒˆ',
      kodawari:'ç›®åœ°å¹…ã‚’3mmã«çµ±ä¸€ã—ã€ä¸Šè³ªãªä»•ä¸ŠãŒã‚Šã‚’å®Ÿç¾ã€‚çŸ³ã®å‘ãã‚’æƒãˆã¦æ•´ç„¶ã¨ã—ãŸå°è±¡ã«ã€‚',
      voice:'ã€Œæƒ³åƒä»¥ä¸Šã®ä»•ä¸ŠãŒã‚Šã§å¤§æº€è¶³ã§ã™ï¼è¿‘æ‰€ã®æ–¹ã«ã‚‚è¤’ã‚ã‚‰ã‚Œã¾ã—ãŸã€',
      pain:'ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãŒå‘³æ°—ãªãã¦ã€ã‚‚ã£ã¨ãŠã—ã‚ƒã‚Œã«ã—ãŸã‹ã£ãŸ',
      memo:'',
    },
    photos,
  };
  persist();
  localStorage.setItem('rs-pro-demo-loaded','1');
  renderHome();
  // ãƒ‡ãƒ¢ç¾å ´ã‚’è‡ªå‹•ã§é–‹ã
  siteId = demoId;
  renderPhotoSections();
  showScreen('s-step2');
  setTimeout(()=>showToast('ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã§æ“ä½œã‚’ç¢ºèªã§ãã¾ã™'), 500);
}
</script>
</body>
</html>
